<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vancouver DTES Lifeline Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Nunito Sans', sans-serif; margin: 0; padding: 0; }
        #map { height: 70vh; width: 100%; min-height: 400px; border-radius: 0.75rem; background-color: #f3f4f6; }
        .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .popup-btn { padding: 0.4rem 0.7rem; border-radius: 0.5rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; margin-top: 10px; margin-right: 5px; font-size: 0.85rem; cursor: pointer; border: none; transition: all 0.2s ease; }
        .popup-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); }
        .direction-btn { background-color: #EF4444; color: white; width: 100%; margin-top: 12px !important; }
        .filter-button { transition: all 0.2s ease-in-out; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 2px solid transparent; }
        .filter-button.active { box-shadow: 0 0 0 3px #1D4ED8; border-color: #1D4ED8; background-color: #1D4ED8 !important; transform: scale(1.05); }
        .filter-button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .user-location-icon { background-color: #3B82F6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0, 0, 0, 0.6); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        #loadingOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); z-index: 1010; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 40px; height: 40px; border-radius: 50%; border-left-color: #1D4ED8; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-open { background-color: #10B981; }
        .status-closed { background-color: #EF4444; }
        #quickExitBtn { position: fixed; bottom: 20px; right: 20px; background-color: #EF4444; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; z-index: 1000; display: none; }
        .language-selector { position: fixed; top: 10px; right: 10px; z-index: 1000; }
        .qr-modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .qr-modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 10px; text-align: center; }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: black; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner mb-4"></div>
    <div class="text-2xl font-bold text-gray-800">DTES Lifeline Map</div>
    <div class="text-sm text-gray-500 mt-2">Loading 60+ community resources...</div>
</div>

<div class="language-selector">
    <select id="languageSelect" class="bg-white border border-gray-300 rounded px-3 py-1 text-sm shadow-lg">
        <option value="en">English</option>
        <option value="zh">‰∏≠Êñá</option>
        <option value="es">Espa√±ol</option>
        <option value="fr">Fran√ßais</option>
        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
        <option value="tl">Tagalog</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="fa">ŸÅÿßÿ±ÿ≥€å</option>
    </select>
</div>

<div id="qrModal" class="qr-modal">
    <div class="qr-modal-content">
        <span class="close-modal">√ó</span>
        <h2 class="text-lg font-bold mb-4">Location QR Code</h2>
        <p class="mb-4">Scan this code to get directions on your phone</p>
        <div id="qrcode"></div>
        <p id="qrLocationName" class="mt-4 text-sm text-gray-600"></p>
    </div>
</div>

<button id="quickExitBtn">
    <i class="fas fa-times mr-2"></i> Quick Exit
</button>

<div id="mainAppContent" class="container mx-auto p-4 md:p-8 opacity-0 transition-opacity duration-500">
    
    <header class="bg-white p-6 shadow-xl rounded-xl mb-6">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Vancouver DTES Lifeline Map</h1>
        <p class="text-gray-600 mb-2">Instant access to harm reduction, supervised consumption, food banks, shelters, detox centers, and urgent care services.</p>
        <p class="text-sm text-gray-500 mb-2">
            <span id="userLocationStatus" class="font-semibold text-gray-700">Ready to use</span>
            <span class="mx-2">|</span>
            <span id="resourceCount" class="text-blue-600 font-semibold">60 verified locations</span>
        </p>
        <div class="text-xs text-red-600 font-semibold mt-3 bg-red-50 p-3 rounded-lg border border-red-200">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span>Important: Service hours may change. Always call ahead.</span>
        </div>
    </header>

    <div class="grid grid-cols-1 gap-4 mb-6">
        <div class="bg-white p-5 shadow-lg rounded-xl border border-gray-200">
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="flex-grow">
                    <label for="searchBar" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-search mr-1"></i> Search Resources:
                    </label>
                    <input id="searchBar" type="text" placeholder="Search by name, type, or service" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
            </div>
            
            <div class="mb-2">
                <span class="text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-filter mr-1"></i> Filter by Category:
                </span>
            </div>
            
            <div id="filterButtons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                <button data-filter="all" class="filter-button bg-gray-600 hover:bg-gray-700 text-white py-2.5 px-3 rounded-lg active">
                    <i class="fas fa-globe mr-1"></i> All (60)
                </button>
                <button data-filter="Naloxone" class="filter-button bg-blue-500 hover:bg-blue-600 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-kit-medical mr-1"></i> Naloxone
                </button>
                <button data-filter="Injection Site" class="filter-button bg-green-500 hover:bg-green-600 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-syringe mr-1"></i> Sites
                </button>
                <button data-filter="Detox" class="filter-button bg-orange-500 hover:bg-orange-600 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-house-medical-flag mr-1"></i> Detox
                </button>
                <button data-filter="Food" class="filter-button bg-purple-600 hover:bg-purple-700 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-utensils mr-1"></i> Food
                </button>
                <button data-filter="Shelter" class="filter-button bg-yellow-700 hover:bg-yellow-800 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-bed mr-1"></i> Shelter
                </button>
                <button data-filter="Urgent" class="filter-button bg-red-600 hover:bg-red-700 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-hospital mr-1"></i> Urgent
                </button>
                <button data-filter="Washrooms" class="filter-button bg-teal-600 hover:bg-teal-700 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-restroom mr-1"></i> Washrooms
                </button>
                <button data-filter="Mental Health" class="filter-button bg-pink-600 hover:bg-pink-700 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-brain mr-1"></i> Mental
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <button id="locateUserButton" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg">
                <i class="fas fa-crosshairs mr-2"></i> Find My Location
            </button>
            <button id="instructionsButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg">
                <i class="fas fa-hand-holding-medical mr-2"></i> Naloxone Guide
            </button>
            <button id="reportStatusButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg shadow-lg">
                <i class="fas fa-bullhorn mr-2"></i> Report Issue
            </button>
            <button id="emergencyButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg">
                <i class="fas fa-phone-alt mr-2"></i> Emergency 911
            </button>
        </div>
    </div>

    <div id="emergencyMessage" class="hidden bg-red-200 border-2 border-red-500 text-red-800 px-4 py-3 rounded-lg mb-4 font-bold">
        <i class="fas fa-exclamation-circle mr-2"></i> EMERGENCY: Please call 911 immediately.
    </div>

    <div id="map" class="shadow-2xl border-4 border-white"></div>

    <footer class="mt-6 bg-gray-800 text-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">
            <i class="fas fa-phone-volume mr-2"></i> 24/7 Crisis Support Hotlines
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5 text-sm">
            <div><div class="font-semibold text-teal-400 mb-2"><i class="fas fa-headset mr-2"></i> BC Crisis</div><a href="tel:310-6789" class="hover:text-teal-300 block text-lg font-bold">310-6789</a><div class="text-xs text-gray-400 mt-1">24/7</div></div>
            <div><div class="font-semibold text-red-400 mb-2"><i class="fas fa-heartbeat mr-2"></i> Suicide Crisis</div><a href="tel:988" class="hover:text-red-300 block text-lg font-bold">988</a><div class="text-xs text-gray-400 mt-1">24/7</div></div>
            <div><div class="font-semibold text-yellow-400 mb-2"><i class="fas fa-leaf mr-2"></i> Indigenous</div><a href="tel:1-800-588-8717" class="hover:text-yellow-300 block text-lg font-bold">1-800-588-8717</a></div>
            <div><div class="font-semibold text-blue-400 mb-2"><i class="fas fa-child mr-2"></i> Kids Help</div><a href="tel:1-800-668-6868" class="hover:text-blue-300 block text-lg font-bold">1-800-668-6868</a></div>
            <div><div class="font-semibold text-orange-400 mb-2"><i class="fas fa-pills mr-2"></i> ADIRS</div><a href="tel:1-800-663-1441" class="hover:text-orange-300 block text-lg font-bold">1-800-663-1441</a></div>
        </div>
        <div class="text-center text-xs text-gray-400 mt-6 pt-4 border-t border-gray-700">
            <p>Made with ‚ù§Ô∏è for the DTES community</p>
        </div>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
const dtesResources = [
    {name: "Insite", lat: 49.2811, lng: -123.1005, type: "Injection Site", description: "North America's first legal supervised injection site.", hours: "24/7", phone: "604-685-7677", address: "139 E Hastings St", status: "open"},
    {name: "Powell Street Getaway", lat: 49.2817, lng: -123.0982, type: "Injection Site", description: "Peer-run overdose prevention site.", hours: "Daily 10am-10pm", phone: "778-379-2640", address: "528 Powell St", status: "open"},
    {name: "Dr. Peter Centre", lat: 49.2828, lng: -123.1056, type: "Injection Site", description: "Supervised consumption for HIV/AIDS.", hours: "Mon-Fri 9am-5pm", phone: "604-677-6330", address: "1110 Comox St", status: "open"},
    {name: "Overdose Prevention Society", lat: 49.2805, lng: -123.1015, type: "Injection Site", description: "Community-led overdose prevention.", hours: "Daily 8am-midnight", phone: "604-559-8873", address: "58 E Hastings St", status: "open"},
    {name: "VCH Naloxone", lat: 49.2819, lng: -123.1, type: "Naloxone", description: "Free naloxone kits and training.", hours: "Mon-Fri 9am-5pm", phone: "604-675-3700", address: "601 W Broadway", status: "open"},
    {name: "BC Centre Substance Use", lat: 49.2825, lng: -123.1208, type: "Naloxone", description: "Naloxone kits, training, resources.", hours: "Mon-Fri 8:30am-4:30pm", phone: "778-945-7619", address: "400-1045 Howe St", status: "open"},
    {name: "Carnegie Centre", lat: 49.2813, lng: -123.1003, type: "Naloxone", description: "Free naloxone kits at desk.", hours: "Mon-Sun 9am-10pm", phone: "604-665-2289", address: "401 Main St", status: "open"},
    {name: "Portland Hotel Society", lat: 49.2816, lng: -123.0995, type: "Naloxone", description: "Naloxone and harm reduction.", hours: "24/7", phone: "604-683-2911", address: "713 E Hastings St", status: "open"},
    {name: "VANDU", lat: 49.2814, lng: -123.1002, type: "Naloxone", description: "Peer-led advocacy and naloxone.", hours: "Mon-Fri 10am-6pm", phone: "604-683-8595", address: "380 E Hastings St", status: "open"},
    {name: "Overdose Outreach Team", lat: 49.2815, lng: -123.1005, type: "Naloxone", description: "Mobile naloxone distribution.", hours: "Daily 10am-8pm", phone: "778-379-1965", address: "Mobile DTES", status: "open"},
    {name: "Withdrawal Management", lat: 49.2823, lng: -123.1012, type: "Detox", description: "Medical detox, 24-hour nursing.", hours: "24/7", phone: "604-675-3900", address: "1081 Burrard St", status: "open"},
    {name: "Strathcona Mental Health", lat: 49.279, lng: -123.0987, type: "Detox", description: "Mental health and detox support.", hours: "Mon-Fri 8:30am-4:30pm", phone: "604-675-2237", address: "565 E Cordova St", status: "open"},
    {name: "Harbour Light Detox", lat: 49.2801, lng: -123.1008, type: "Detox", description: "Detox and recovery program.", hours: "24/7", phone: "604-681-3405", address: "119 E Cordova St", status: "open"},
    {name: "Onsite Detox", lat: 49.2811, lng: -123.1005, type: "Detox", description: "Medical withdrawal management.", hours: "24/7", phone: "604-696-3134", address: "139 E Hastings St", status: "open"},
    {name: "Union Gospel Mission", lat: 49.2809, lng: -123.0998, type: "Food", description: "Free hot meals daily.", hours: "Breakfast 7-9am, Lunch 12-2pm, Dinner 5-7pm", phone: "604-253-3323", address: "616 E Cordova St", status: "open"},
    {name: "First United Church", lat: 49.2815, lng: -123.1003, type: "Food", description: "Free meals and food hampers.", hours: "Mon-Fri 9am-4pm", phone: "604-681-8365", address: "320 E Hastings St", status: "open"},
    {name: "Carnegie Lunch", lat: 49.2813, lng: -123.1003, type: "Food", description: "Free community lunch.", hours: "Mon-Fri 11:30am-1pm", phone: "604-665-2289", address: "401 Main St", status: "open"},
    {name: "St. James Community", lat: 49.2807, lng: -123.1018, type: "Food", description: "Food bank and meals.", hours: "Mon-Fri 10am-3pm", phone: "604-685-8565", address: "303 E Cordova St", status: "open"},
    {name: "DTES Neighbourhood House", lat: 49.28, lng: -123.099, type: "Food", description: "Hot meals and food hampers.", hours: "Mon-Fri 9am-5pm", phone: "604-683-2554", address: "573 E Hastings St", status: "open"},
    {name: "Kettle Friendship", lat: 49.2795, lng: -123.098, type: "Food", description: "Affordable meals and food bank.", hours: "Mon-Sun 8am-9pm", phone: "604-251-1258", address: "1725 Venables St", status: "open"},
    {name: "Gospel Mission Meals", lat: 49.2812, lng: -123.1001, type: "Food", description: "Daily hot meals.", hours: "Daily 7am-8pm", phone: "604-872-3464", address: "331 Carrall St", status: "open"},
    {name: "Evelyn Saller Centre", lat: 49.2819, lng: -123.1012, type: "Food", description: "Drop-in with meals, showers.", hours: "Mon-Fri 8am-4pm", phone: "604-215-4917", address: "320 Alexander St", status: "open"},
    {name: "Ray-Cam Co-op", lat: 49.2756, lng: -123.0712, type: "Food", description: "Food programs and recreation.", hours: "Mon-Fri 9am-9pm", phone: "604-257-6933", address: "920 E Hastings St", status: "open"},
    {name: "Triage Emergency Shelter", lat: 49.2821, lng: -123.1009, type: "Shelter", description: "24/7 emergency shelter.", hours: "24/7", phone: "604-215-6285", address: "655 Dunlevy Ave", status: "open"},
    {name: "Salvation Army Harbour", lat: 49.2801, lng: -123.1008, type: "Shelter", description: "Men's shelter with recovery.", hours: "24/7", phone: "604-681-3405", address: "119 E Cordova St", status: "open"},
    {name: "Salvation Army Shield", lat: 49.2798, lng: -123.1012, type: "Shelter", description: "Women's shelter with childcare.", hours: "24/7", phone: "604-872-7705", address: "209 Carrall St", status: "open"},
    {name: "Lookout Emergency Aid", lat: 49.2803, lng: -123.0997, type: "Shelter", description: "Emergency shelter beds.", hours: "24/7", phone: "604-681-4844", address: "320 Alexander St", status: "open"},
    {name: "Directions Youth", lat: 49.2788, lng: -123.0975, type: "Shelter", description: "Youth shelter 13-24.", hours: "24/7", phone: "604-251-3310", address: "1575 Vernon Dr", status: "open"},
    {name: "Covenant House", lat: 49.2782, lng: -123.0968, type: "Shelter", description: "Youth shelter 16-24.", hours: "24/7", phone: "604-685-7474", address: "575 Drake St", status: "open"},
    {name: "Aboriginal Front Door", lat: 49.2818, lng: -123.1005, type: "Shelter", description: "Indigenous shelter.", hours: "24/7", phone: "604-876-7600", address: "1 W Hastings St", status: "open"},
    {name: "Urban Native Youth", lat: 49.2742, lng: -123.1158, type: "Shelter", description: "Indigenous youth services.", hours: "Mon-Fri 9am-5pm", phone: "604-254-7732", address: "1618 E Hastings St", status: "open"},
    {name: "WISH Drop-In", lat: 49.2808, lng: -123.0992, type: "Shelter", description: "Women-only drop-in.", hours: "Daily 7pm-7am", phone: "604-255-7779", address: "334 Alexander St", status: "open"},
    {name: "St. Paul's Hospital ER", lat: 49.2828, lng: -123.1056, type: "Urgent", description: "24/7 emergency medical care.", hours: "24/7", phone: "604-682-2344", address: "1081 Burrard St", status: "open"},
    {name: "Vancouver Native Health", lat: 49.2816, lng: -123.1002, type: "Urgent", description: "Primary care for Indigenous.", hours: "Mon-Fri 8:30am-5pm", phone: "604-254-9949", address: "441 E Hastings St", status: "open"},
    {name: "Dr. Peter AIDS Foundation", lat: 49.2828, lng: -123.1056, type: "Urgent", description: "Medical care for HIV/AIDS.", hours: "Mon-Fri 9am-5pm", phone: "604-677-6330", address: "1110 Comox St", status: "open"},
    {name: "Downtown Community Health", lat: 49.2819, lng: -123.1008, type: "Urgent", description: "Primary care, mental health.", hours: "Mon-Fri 8:30am-4:30pm", phone: "604-675-3700", address: "569 Powell St", status: "open"},
    {name: "Pender Community Health", lat: 49.2795, lng: -123.1035, type: "Urgent", description: "Primary care, harm reduction.", hours: "Mon-Fri 8am-6pm", phone: "604-669-9181", address: "59 W Pender St", status: "open"},
    {name: "Three Bridges Health", lat: 49.2802, lng: -123.1005, type: "Urgent", description: "Care for homeless.", hours: "Mon-Fri 9am-5pm", phone: "604-875-5511", address: "1292 Hornby St", status: "open"},
    {name: "VCH Mobile Health", lat: 49.2812, lng: -123.1, type: "Urgent", description: "Mobile medical services.", hours: "Daily 9am-5pm", phone: "604-675-3700", address: "Mobile DTES", status: "open"},
    {name: "Pacific Spirit Health", lat: 49.2819, lng: -123.1015, type: "Urgent", description: "HIV/AIDS, addiction medicine.", hours: "Mon-Fri 9am-5pm", phone: "604-742-1482", address: "1125 Howe St", status: "open"},
    {name: "Carnegie Washrooms", lat: 49.2813, lng: -123.1003, type: "Washrooms", description: "Free public washrooms.", hours: "Mon-Sun 9am-10pm", phone: "604-665-2289", address: "401 Main St", status: "open"},
    {name: "Oppenheimer Park", lat: 49.281, lng: -123.0975, type: "Washrooms", description: "Public park washrooms.", hours: "Daily 7am-10pm", phone: "311", address: "400 Powell St", status: "open"},
    {name: "Pigeon Park", lat: 49.2815, lng: -123.1005, type: "Washrooms", description: "24/7 accessible washrooms.", hours: "24/7", phone: "311", address: "Carrall & Hastings", status: "open"},
    {name: "CRAB Park", lat: 49.286, lng: -123.0965, type: "Washrooms", description: "Waterfront park washrooms.", hours: "Daily 6am-11pm", phone: "311", address: "101 E Waterfront Rd", status: "open"},
    {name: "Main SkyTrain Station", lat: 49.2729, lng: -123.1005, type: "Washrooms", description: "Transit station washrooms.", hours: "24/7", phone: "604-953-3333", address: "Main & Terminal", status: "open"},
    {name: "Carnegie Library", lat: 49.2813, lng: -123.1003, type: "Washrooms", description: "Library with washrooms, wifi.", hours: "Mon-Sun 9am-9pm", phone: "604-665-3010", address: "401 Main St", status: "open"},
    {name: "Vancouver Mental Health", lat: 49.282, lng: -123.1015, type: "Mental Health", description: "Crisis intervention, counseling.", hours: "Mon-Fri 8:30am-4:30pm", phone: "604-675-3700", address: "803 W 12th Ave", status: "open"},
    {name: "Coast Mental Health", lat: 49.2808, lng: -123.1012, type: "Mental Health", description: "Mental health support.", hours: "Mon-Fri 9am-5pm", phone: "604-872-3502", address: "1155 Burrard St", status: "open"},
    {name: "Access & Assessment", lat: 49.2825, lng: -123.1018, type: "Mental Health", description: "Walk-in mental health.", hours: "Mon-Fri 8am-9pm", phone: "604-675-3700", address: "803 W 12th Ave", status: "open"},
    {name: "CMHA Vancouver", lat: 49.2795, lng: -123.1025, type: "Mental Health", description: "Mental health education.", hours: "Mon-Fri 9am-5pm", phone: "604-872-4902", address: "1301 E 41st Ave", status: "open"},
    {name: "RainCity Housing", lat: 49.2811, lng: -123.0998, type: "Mental Health", description: "Mental health outreach.", hours: "Mon-Fri 9am-5pm", phone: "604-685-7699", address: "520 E Hastings St", status: "open"},
    {name: "BC Women's Crisis", lat: 49.2633, lng: -123.1238, type: "Mental Health", description: "24/7 women's crisis support.", hours: "24/7", phone: "604-875-2025", address: "4500 Oak St", status: "open"},
    {name: "Vancouver Recovery Club", lat: 49.2762, lng: -123.1045, type: "Mental Health", description: "Peer support, recovery meetings.", hours: "Mon-Fri 9am-9pm", phone: "604-874-8244", address: "1212 W Broadway", status: "open"},
    {name: "Battered Women's Support", lat: 49.2635, lng: -123.1158, type: "Mental Health", description: "24/7 crisis line for women.", hours: "24/7", phone: "604-687-1867", address: "Confidential", status: "open"}
];

let map, markers = [], userLocationMarker, userLat, userLng, routingControl, currentLanguage = 'en';

const translations = {
    en: {type: "Type", hours: "Hours", call: "Call", getDirections: "Get Directions", openInMaps: "Open in Maps", showQRCode: "Show QR", locating: "Locating...", locationFound: "Location found!", enableLocationFirst: "Enable your location first", directionsTo: "Directions to", followRedLine: "Follow the red line on map"},
    zh: {type: "Á±ªÂûã", hours: "Êó∂Èó¥", call: "Ëá¥Áîµ", getDirections: "Ëé∑ÂèñË∑ØÁ∫ø", openInMaps: "Âú®Âú∞Âõæ‰∏≠ÊâìÂºÄ", showQRCode: "ÊòæÁ§∫‰∫åÁª¥Á†Å", locating: "Ê≠£Âú®ÂÆö‰Ωç...", locationFound: "ÊâæÂà∞‰ΩçÁΩÆÔºÅ", enableLocationFirst: "ËØ∑ÂÖàÂêØÁî®‰ΩçÁΩÆ", directionsTo: "ÂâçÂæÄ", followRedLine: "ÊåâÁÖßÂú∞Âõæ‰∏äÁöÑÁ∫¢Á∫ø"},
    es: {type: "Tipo", hours: "Horario", call: "Llamar", getDirections: "Direcciones", openInMaps: "Abrir en Mapas", showQRCode: "C√≥digo QR", locating: "Localizando...", locationFound: "¬°Ubicaci√≥n encontrada!", enableLocationFirst: "Active su ubicaci√≥n primero", directionsTo: "Direcciones a", followRedLine: "Siga la l√≠nea roja"},
    fr: {type: "Type", hours: "Heures", call: "Appeler", getDirections: "Itin√©raire", openInMaps: "Ouvrir Maps", showQRCode: "Code QR", locating: "Localisation...", locationFound: "Position trouv√©e!", enableLocationFirst: "Activez votre position", directionsTo: "Itin√©raire vers", followRedLine: "Suivez la ligne rouge"},
    bn: {type: "‡¶ß‡¶∞‡¶®", hours: "‡¶∏‡¶Æ‡¶Ø‡¶º", call: "‡¶ï‡¶≤", getDirections: "‡¶¶‡¶ø‡¶ï‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂", openInMaps: "‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßá ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®", showQRCode: "QR ‡¶ï‡ßã‡¶°", locating: "‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...", locationFound: "‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá!", enableLocationFirst: "‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®", directionsTo: "‡¶¶‡¶ø‡¶ï‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂", followRedLine: "‡¶≤‡¶æ‡¶≤ ‡¶∞‡ßá‡¶ñ‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®"},
    tl: {type: "Uri", hours: "Oras", call: "Tumawag", getDirections: "Direksyon", openInMaps: "Buksan sa Maps", showQRCode: "QR Code", locating: "Hinahanap...", locationFound: "Nahanap!", enableLocationFirst: "I-enable muna", directionsTo: "Direksyon sa", followRedLine: "Sundin ang pulang linya"},
    ar: {type: "ÿßŸÑŸÜŸàÿπ", hours: "ÿßŸÑÿ≥ÿßÿπÿßÿ™", call: "ÿßÿ™ÿµŸÑ", getDirections: "ÿßŸÑÿßÿ™ÿ¨ÿßŸáÿßÿ™", openInMaps: "ŸÅÿ™ÿ≠ ÿßŸÑÿÆÿ±ÿßÿ¶ÿ∑", showQRCode: "ÿ±ŸÖÿ≤ QR", locating: "ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ÿØŸäÿØ...", locationFound: "ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ±!", enableLocationFirst: "ŸÇŸÖ ÿ®ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÖŸàŸÇÿπ ÿ£ŸàŸÑÿßŸã", directionsTo: "ÿßÿ™ÿ¨ÿßŸáÿßÿ™ ÿ•ŸÑŸâ", followRedLine: "ÿßÿ™ÿ®ÿπ ÿßŸÑÿÆÿ∑ ÿßŸÑÿ£ÿ≠ŸÖÿ±"},
    fa: {type: "ŸÜŸàÿπ", hours: "ÿ≥ÿßÿπÿßÿ™", call: "ÿ™ŸÖÿßÿ≥", getDirections: "ŸÖÿ≥€åÿ±", openInMaps: "ÿ®ÿßÿ≤ ⁄©ÿ±ÿØŸÜ ŸÜŸÇÿ¥Ÿá", showQRCode: "⁄©ÿØ QR", locating: "ÿØÿ± ÿ≠ÿßŸÑ €åÿßŸÅÿ™ŸÜ...", locationFound: "€åÿßŸÅÿ™ ÿ¥ÿØ!", enableLocationFirst: "ÿßÿ®ÿ™ÿØÿß ŸÖŸàŸÇÿπ€åÿ™ ÿ±ÿß ŸÅÿπÿßŸÑ ⁄©ŸÜ€åÿØ", directionsTo: "ŸÖÿ≥€åÿ± ÿ®Ÿá", followRedLine: "ÿÆÿ∑ ŸÇÿ±ŸÖÿ≤ ÿ±ÿß ÿØŸÜÿ®ÿßŸÑ ⁄©ŸÜ€åÿØ"}
};

function initMap() {
    console.log('Starting map initialization...');
    
    if (typeof L === 'undefined') {
        console.error('Leaflet not loaded!');
        document.getElementById('loadingOverlay').innerHTML = '<div class="text-center px-8"><p class="text-red-600 font-bold text-xl mb-4">Map library failed to load</p><button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded">Refresh</button></div>';
        return;
    }
    
    try {
        map = L.map('map').setView([49.2819, -123.1000], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap', maxZoom: 19}).addTo(map);
        dtesResources.forEach(r => addMarker(r));
        
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainAppContent').style.opacity = '1';
            }, 500);
        }, 800);
        
        console.log('Map initialized successfully!');
    } catch (error) {
        console.error('Map error:', error);
        document.getElementById('loadingOverlay').innerHTML = '<div class="text-center px-8"><p class="text-red-600 font-bold text-xl mb-4">Map Error</p><p class="text-gray-600">' + error.message + '</p><button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Refresh</button></div>';
    }
}

function addMarker(r) {
    const colors = {'Naloxone': '#3B82F6', 'Injection Site': '#10B981', 'Detox': '#F97316', 'Food': '#9333EA', 'Shelter': '#b45309', 'Urgent': '#EF4444', 'Washrooms': '#14B8A6', 'Mental Health': '#EC4899'};
    const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="background-color: ${colors[r.type] || '#6B7280'}; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);"></div>`,
        iconSize: [28, 28],
        iconAnchor: [14, 14]
    });
    const marker = L.marker([r.lat, r.lng], { icon: icon }).addTo(map).bindPopup(createPopup(r));
    marker.resourceData = r;
    markers.push(marker);
}

function createPopup(r) {
    const colors = {'Naloxone': '#3B82F6', 'Injection Site': '#10B981', 'Detox': '#F97316', 'Food': '#9333EA', 'Shelter': '#b45309', 'Urgent': '#EF4444', 'Washrooms': '#14B8A6', 'Mental Health': '#EC4899'};
    const t = translations[currentLanguage];
    const safeName = r.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    
    return `
        <div style="max-width: 280px; font-family: 'Nunito Sans', sans-serif;">
            <h3 style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">${r.name}</h3>
            <p style="margin-bottom: 8px; font-size: 13px;">
                <span class="status-indicator ${r.status === 'open' ? 'status-open' : 'status-closed'}"></span>
                <strong style="color: ${colors[r.type]};">${t.type}:</strong> ${r.type}
            </p>
            <p style="margin-bottom: 8px; font-size: 13px;">${r.description}</p>
            <p style="margin-bottom: 8px; font-size: 13px;"><strong>${t.hours}:</strong> ${r.hours}</p>
            <p style="margin-bottom: 12px; font-size: 13px;"><strong>${t.call}:</strong> <a href="tel:${r.phone}" style="color: #2563EB;">${r.phone}</a></p>
            <p style="margin-bottom: 12px; font-size: 12px; color: #6B7280;"><i class="fas fa-map-marker-alt"></i> ${r.address}</p>
            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                <button onclick="getDirections(${r.lat}, ${r.lng}, '${safeName}');" class="popup-btn direction-btn"><i class="fas fa-directions mr-1"></i> ${t.getDirections}</button>
                <button onclick="openInExternalMap(${r.lat}, ${r.lng}, '${safeName}');" class="popup-btn" style="background-color: #3B82F6; color: white;"><i class="fas fa-external-link-alt mr-1"></i> ${t.openInMaps}</button>
                <button onclick="showQRCode(${r.lat}, ${r.lng}, '${safeName}');" class="popup-btn" style="background-color: #10B981; color: white;"><i class="fas fa-qrcode mr-1"></i> ${t.showQRCode}</button>
            </div>
        </div>
    `;
}

window.getDirections = function(lat, lng, name) {
    if (!userLat || !userLng) {
        alert(translations[currentLanguage].enableLocationFirst);
        return;
    }
    if (routingControl) map.removeControl(routingControl);
    routingControl = L.Routing.control({
        waypoints: [L.latLng(userLat, userLng), L.latLng(lat, lng)],
        routeWhileDragging: false,
        lineOptions: {styles: [{color: '#EF4444', weight: 5, opacity: 0.8}]},
        createMarker: () => null,
        show: true,
        collapsible: false
    }).addTo(map);
    alert(`üó∫Ô∏è ${translations[currentLanguage].directionsTo} ${name}\n\n${translations[currentLanguage].followRedLine}`);
};

window.openInExternalMap = function(lat, lng, name) {
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    let url;
    if (isMobile) {
        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
            url = `maps://maps.google.com/maps?daddr=${lat},${lng}`;
        } else if (/Android/.test(navigator.userAgent)) {
            url = `geo:${lat},${lng}?q=${lat},${lng}(${encodeURIComponent(name)})`;
        } else {
            url = `https://maps.google.com/maps?daddr=${lat},${lng}`;
        }
    } else {
        url = `https://maps.google.com/maps?daddr=${lat},${lng}`;
    }
    window.open(url, '_blank');
};

window.showQRCode = function(lat, lng, name) {
    const url = `https://maps.google.com/maps?q=${lat},${lng}(${encodeURIComponent(name)})`;
    const modal = document.getElementById('qrModal');
    const qrcodeDiv = document.getElementById('qrcode');
    qrcodeDiv.innerHTML = '';
    new QRCode(qrcodeDiv, {text: url, width: 200, height: 200, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H});
    document.getElementById('qrLocationName').textContent = name;
    modal.style.display = 'block';
};

document.getElementById('locateUserButton').addEventListener('click', () => {
    if (!navigator.geolocation) {alert('Geolocation not supported'); return;}
    document.getElementById('userLocationStatus').textContent = translations[currentLanguage].locating;
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
            if (userLocationMarker) map.removeLayer(userLocationMarker);
            const icon = L.divIcon({className: 'user-location-icon', iconSize: [20, 20], iconAnchor: [10, 10]});
            userLocationMarker = L.marker([userLat, userLng], {icon: icon}).addTo(map).bindPopup('<strong>You are here</strong>');
            map.setView([userLat, userLng], 15);
            document.getElementById('userLocationStatus').textContent = translations[currentLanguage].locationFound;
            userLocationMarker.openPopup();
        },
        (err) => {
            console.error('Geolocation error:', err);
            alert('Unable to get location. Please enable location services.');
            document.getElementById('userLocationStatus').textContent = 'Location error';
        }
    );
});

document.querySelectorAll('.filter-button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const filter = btn.dataset.filter;
        markers.forEach(m => {
            if (filter === 'all' || m.resourceData.type === filter) {
                m.addTo(map);
            } else {
                map.removeLayer(m);
            }
        });
        const count = markers.filter(m => filter === 'all' || m.resourceData.type === filter).length;
        document.getElementById('resourceCount').textContent = `${count} verified locations`;
    });
});

document.getElementById('searchBar').addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase().trim();
    markers.forEach(m => {
        const r = m.resourceData;
        const match = r.name.toLowerCase().includes(q) || r.description.toLowerCase().includes(q) || r.type.toLowerCase().includes(q) || r.address.toLowerCase().includes(q);
        if (match || q === '') {
            m.addTo(map);
        } else {
            map.removeLayer(m);
        }
    });
    const count = markers.filter(m => map.hasLayer(m)).length;
    document.getElementById('resourceCount').textContent = `${count} verified locations`;
});

document.getElementById('emergencyButton').addEventListener('click', () => {
    const msg = document.getElementById('emergencyMessage');
    msg.classList.remove('hidden');
    setTimeout(() => msg.classList.add('hidden'), 5000);
});

document.getElementById('instructionsButton').addEventListener('click', () => {
    alert(`üÜò NALOXONE INSTRUCTIONS\n\n1Ô∏è‚É£ RECOGNIZE OVERDOSE:\n‚Ä¢ No/slow breathing\n‚Ä¢ Blue lips\n‚Ä¢ Unconscious\n\n2Ô∏è‚É£ CALL 911\n\n3Ô∏è‚É£ GIVE NALOXONE:\nNasal: Insert, press plunger\nInjectable: Inject arm/thigh\n\n4Ô∏è‚É£ RESCUE BREATHS:\n‚Ä¢ Tilt head back\n‚Ä¢ 1 breath every 5 seconds\n\n5Ô∏è‚É£ STAY WITH PERSON\n‚Ä¢ Recovery position\n\n6Ô∏è‚É£ SECOND DOSE:\n‚Ä¢ After 3-5 min if no response\n\nüìû Free kits at blue pins\n‚öñÔ∏è Good Samaritan Act protects you`);
});

document.getElementById('reportStatusButton').addEventListener('click', () => {
    alert(`üì¢ REPORT SERVICE CHANGES\n\nHelp keep info accurate:\n‚úÖ Service closures\n‚úÖ Updated hours\n‚úÖ New resources\n‚úÖ Incorrect info\n\nContact:\n‚Ä¢ Email: info@dteslifeline.org\n‚Ä¢ GitHub: Open issue\n‚Ä¢ In person: Visit location\n\nThank you! üôè`);
});

document.getElementById('languageSelect').addEventListener('change', (e) => {
    currentLanguage = e.target.value;
    markers.forEach(m => m.setPopupContent(createPopup(m.resourceData)));
});

document.querySelector('.close-modal').addEventListener('click', () => {
    document.getElementById('qrModal').style.display = 'none';
});

window.addEventListener('click', (e) => {
    if (e.target === document.getElementById('qrModal')) {
        document.getElementById('qrModal').style.display = 'none';
    }
});

document.getElementById('quickExitBtn').addEventListener('click', () => {
    window.location.href = 'https://www.weather.com';
});

window.addEventListener('scroll', () => {
    const btn = document.getElementById('quickExitBtn');
    btn.style.display = window.scrollY > 200 ? 'block' : 'none';
});

function waitForLeaflet() {
    if (typeof L !== 'undefined' && typeof L.Routing !== 'undefined') {
        console.log('All libraries loaded!');
        initMap();
    } else {
        console.log('Waiting for libraries...');
        setTimeout(waitForLeaflet, 100);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForLeaflet);
} else {
    waitForLeaflet();
}
</script>

</body>
</html>
