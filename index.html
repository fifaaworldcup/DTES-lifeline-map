<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vancouver DTES Lifeline Map - Real-Time Resource Locator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz,wght@6..12,400;6..12,600;6..12,700;6..12,800&display=swap');
        
        body { 
            font-family: 'Nunito Sans', sans-serif; 
            margin: 0;
            padding: 0;
        }
        
        /* Map Container */
        #map { 
            height: 70vh; 
            width: 100%; 
            min-height: 400px; 
            border-radius: 0.75rem;
            transition: opacity 0.5s;
            background-color: #f3f4f6;
        }
        
        /* Leaflet Popup Custom Styles */
        .leaflet-popup-content {
            margin: 13px 19px;
            line-height: 1.4;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .leaflet-popup-content .popup-btn {
            padding: 0.4rem 0.7rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            margin-right: 5px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        
        .leaflet-popup-content .popup-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .direction-btn {
            background-color: #EF4444;
            color: white;
            width: 100%;
            margin-top: 12px !important;
        }
        
        .direction-btn:hover {
            background-color: #DC2626;
        }
        
        /* Filter Button Styles */
        .filter-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
        }
        
        .filter-button.active {
            box-shadow: 0 0 0 3px #1D4ED8, 0 2px 4px rgba(0, 0, 0, 0.1);
            border-color: #1D4ED8;
            background-color: #1D4ED8 !important;
            transform: scale(1.05);
        }
        
        .filter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* User Location Marker - Pulsing Blue Dot */
        .user-location-icon {
            background-color: #3B82F6;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            z-index: 1010;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: #1D4ED8;
            animation: spin 1s ease infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Dark Mode Support */
        body.dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        
        body.dark .bg-white {
            background-color: #2d3748;
        }
        
        body.dark .text-gray-600 {
            color: #cbd5e0;
        }
    </style>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
</head>
<body>
    
    <!-- Initial Loading Overlay -->
    <div id="loadingOverlay" role="status" aria-live="polite">
        <div class="spinner mb-4"></div>
        <p class="text-2xl font-bold text-gray-800">DTES Lifeline Map</p>
        <p class="text-sm text-gray-500 mt-2">Loading 25+ community resources...</p>
    </div>

    <!-- Main Application Content -->
    <div class="container mx-auto p-4 md:p-8 opacity-0 transition-opacity duration-500" id="mainAppContent">
        
        <!-- Header -->
        <header class="bg-white p-6 shadow-xl rounded-xl mb-6">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                Vancouver DTES Lifeline Map
            </h1>
            <p class="text-gray-600 mb-2">
                Instant access to harm reduction, supervised consumption, food banks, shelters, 
                detox centers, and urgent care services in Vancouver's Downtown Eastside.
            </p>
            <p class="text-sm text-gray-500 mb-2">
                <span id="userLocationStatus" class="font-semibold text-gray-700">Ready to use</span> | 
                <span id="resourceCount" class="text-blue-600 font-semibold">25 verified locations</span> | 
                <span class="text-gray-500">Data from VCH, BC211, Community Partners</span>
            </p>
            <div class="text-xs text-red-600 font-semibold mt-3 bg-red-50 p-3 rounded-lg border border-red-200">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <strong>Important Notice:</strong> Service hours shown are typical schedules. 
                Always call ahead to verify availability, as hours may change without notice.
            </div>
        </header>

        <!-- Controls and Filters Section -->
        <div class="grid grid-cols-1 gap-4 mb-6">
            
            <!-- Search and Filter Block -->
            <div class="bg-white p-5 shadow-lg rounded-xl border border-gray-200">
                
                <!-- Search Bar and Time Slider -->
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-grow">
                        <label for="searchBar" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-search mr-1"></i> Search Resources:
                        </label>
                        <input 
                            type="text" 
                            id="searchBar" 
                            placeholder="Search by name, type, or service (e.g., Insite, naloxone, food)" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                        >
                    </div>
                    <div class="flex-shrink-0 min-w-[200px]">
                        <label for="timeSlider" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clock mr-1"></i> Filter by Time:
                        </label>
                        <input 
                            type="range" 
                            id="timeSlider" 
                            min="0" 
                            max="23" 
                            value="12" 
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                        >
                        <div class="text-center mt-1">
                            <span id="timeValue" class="text-sm font-semibold text-gray-600">12:00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Category Filter Buttons -->
                <div class="mb-2">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">
                        <i class="fas fa-filter mr-1"></i> Filter by Category:
                    </h3>
                </div>
                <div id="filterButtons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-7 gap-3">
                    <button 
                        data-filter="all" 
                        class="filter-button bg-gray-600 hover:bg-gray-700 text-white py-2.5 px-3 rounded-lg active"
                        aria-pressed="true"
                    >
                        <i class="fas fa-globe mr-1"></i> All (25)
                    </button>
                    <button 
                        data-filter="Naloxone" 
                        class="filter-button bg-blue-500 hover:bg-blue-600 text-white py-2.5 px-3 rounded-lg"
                        aria-pressed="false"
                    >
                        <i class="fas fa-kit-medical mr-1"></i> Naloxone
                    </button>
                    <button 
                        data-filter="Injection Site" 
                        class="filter-button bg-green-500 hover:bg-green-600 text-white py-2.5 px-3 rounded-lg"
                        aria-pressed="false"
                    >
                        <i class="fas fa-syringe mr-1"></i> Sites
                    </button>
                    <button 
                        data-filter="Detox" 
                        class="filter-button bg-orange-500 hover:bg-orange-600 text-white py-2.5 px-3 rounded-lg"
                        aria-pressed="false"
                    >
                        <i class="fas fa-house-medical-flag mr-1"></i> Detox
                    </button>
                    <button 
                        data-filter="Food" 
                        class="filter-button bg-purple-600 hover:bg-purple-700 text-white py-2.5 px-3 rounded-lg"
                        aria-pressed="false"
                    >
                        <i class="fas fa-utensils mr-1"></i> Food
                    </button>
                    <button 
                        data-filter="Urgent" 
                        class="filter-button bg-red-600 hover:bg-red-700 text-white py-2.5 px-3 rounded-lg"
                        aria-pressed="false"
                    >
                        <i class="fas fa-hospital mr-1"></i> Urgent
                    </button>
                    <button 
                        data-filter="Washrooms" 
                        class="filter-button bg-teal-600 hover:bg-teal-700 text-white py-2.5 px-3 rounded-lg"
                        aria-pressed="false"
                    >
                        <i class="fas fa-restroom mr-1"></i> Washrooms
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <button 
                    id="locateUserButton" 
                    class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-105"
                >
                    <i class="fas fa-crosshairs mr-2"></i> Find My Location
                </button>
                <button 
                    id="instructionsButton" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-105"
                >
                    <i class="fas fa-hand-holding-medical mr-2"></i> Naloxone Guide
                </button>
                <button 
                    id="reportStatusButton" 
                    class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-105"
                >
                    <i class="fas fa-bullhorn mr-2"></i> Report Issue
                </button>
                <button 
                    id="emergencyButton" 
                    class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-105"
                >
                    <i class="fas fa-phone-alt mr-2"></i> Emergency 911
                </button>
            </div>
        </div>

        <!-- Emergency Alert Message (Hidden by Default) -->
        <div 
            id="emergencyMessage" 
            class="hidden bg-red-200 border-2 border-red-500 text-red-800 px-4 py-3 rounded-lg mb-4 font-bold"
            role="alert"
        >
            <span class="block sm:inline">
                <i class="fas fa-exclamation-circle mr-2"></i>
                EMERGENCY: Please call 911 immediately for medical emergencies. 
                (This button demonstrates the emergency feature)
            </span>
        </div>
        
        <!-- Interactive Map Container -->
        <div id="map" class="shadow-2xl border-4 border-white"></div>

        <!-- Crisis Support Footer -->
        <footer class="mt-6 bg-gray-800 text-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">
                <i class="fas fa-phone-volume mr-2"></i>
                24/7 Crisis Support Hotlines (Free & Anonymous)
            </h2>
            
            <!-- Crisis Hotlines Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5 text-sm">
                
                <!-- BC Crisis Line -->
                <div class="border-r border-gray-700 pr-4">
                    <p class="font-semibold text-teal-400 mb-2">
                        <i class="fas fa-headset mr-2"></i> BC Crisis Line
                    </p>
                    <a href="tel:310-6789" class="hover:text-teal-300 transition block text-lg font-bold">
                        310-6789
                    </a>
                    <p class="text-xs text-gray-400 mt-1">No area code needed ‚Ä¢ 24/7</p>
                </div>
                
                <!-- Suicide Crisis Helpline -->
                <div class="border-r border-gray-700 pr-4">
                    <p class="font-semibold text-red-400 mb-2">
                        <i class="fas fa-heartbeat mr-2"></i> Suicide Crisis
                    </p>
                    <a href="tel:988" class="hover:text-red-300 transition block text-lg font-bold">
                        988
                    </a>
                    <p class="text-xs text-gray-400 mt-1">24/7 call or text</p>
                </div>
                
                <!-- Indigenous Crisis Line -->
                <div class="border-r border-gray-700 pr-4">
                    <p class="font-semibold text-yellow-400 mb-2">
                        <i class="fas fa-leaf mr-2"></i> KUU-US Indigenous
                    </p>
                    <a href="tel:18005888717" class="hover:text-yellow-300 transition block text-lg font-bold">
                        1-800-588-8717
                    </a>
                    <p class="text-xs text-gray-400 mt-1">Indigenous crisis support</p>
                </div>
                
                <!-- Kids Help Phone -->
                <div class="border-r border-gray-700 pr-4">
                    <p class="font-semibold text-blue-400 mb-2">
                        <i class="fas fa-child mr-2"></i> Kids Help Phone
                    </p>
                    <a href="tel:18006686868" class="hover:text-blue-300 transition block text-lg font-bold">
                        1-800-668-6868
                    </a>
                    <p class="text-xs text-gray-400 mt-1">Youth support 24/7</p>
                </div>
                
                <!-- ADIRS -->
                <div>
                    <p class="font-semibold text-orange-400 mb-2">
                        <i class="fas fa-pills mr-2"></i> ADIRS
                    </p>
                    <a href="tel:18006631441" class="hover:text-orange-300 transition block text-lg font-bold">
                        1-800-663-1441
                    </a>
                    <p class="text-xs text-gray-400 mt-1">Alcohol & Drug info</p>
                </div>
            </div>
            
            <!-- Footer Info -->
            <div class="text-center text-xs text-gray-400 mt-6 pt-4 border-t border-gray-700">
                <p class="mb-2">
                    <i class="fas fa-code mr-1"></i> Open source community project ‚Ä¢ 
                    Data verified from Vancouver Coastal Health, BC211, and community partners
                </p>
                <p>
                    <a href="https://github.com/fifaaworldcup/DTESsupport.github.io" 
                       class="text-blue-400 hover:text-blue-300 transition underline">
                        View on GitHub
                    </a>
                    <span class="mx-2">‚Ä¢</span>
                    <span>Made with ‚ù§Ô∏è for the DTES community</span>
                </p>
            </div>
        </footer>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Main Application JavaScript -->
    <script>
        // ===================================================================
        // DTES RESOURCES DATABASE (25+ Verified Locations)
        // Data verified November 2025 from official sources
        // ===================================================================
        
        const dtesResources = [
            // ================= SUPERVISED CONSUMPTION SITES =================
            {
                name: "Insite (Supervised Consumption)",
                lat: 49.2811,
                lng: -123.1005,
                type: "Injection Site",
                description: "North America's first legal supervised injection site. Medical supervision, sterile supplies, overdose prevention, and healthcare referrals.",
                hours: "24/7",
                phone: "604-685-7677",
                address: "139 E Hastings St"
            },
            {
                name: "Overdose Prevention Site - 58 W Hastings",
                lat: 49.2813,
                lng: -123.1052,
                type: "Injection Site",
                description: "Safe consumption site with medical supervision, naloxone distribution, peer support workers, and harm reduction supplies.",
                hours: "Daily 10am-2am",
                phone: "604-682-2245",
                address: "58 W Hastings St"
            },
            {
                name: "Dr. Peter Centre",
                lat: 49.2656,
                lng: -123.1377,
                type: "Injection Site",
                description: "Day health program with supervised consumption, meals, primary care, and support services for people living with HIV/AIDS.",
                hours: "Mon-Fri 8:30am-4pm",
                phone: "604-646-5700",
                address: "1110 Comox St"
            },
            
            // ================= NALOXONE DISTRIBUTION SITES =================
            {
                name: "Downtown Eastside Community Health Centre",
                lat: 49.2808,
                lng: -123.0996,
                type: "Naloxone",
                description: "Free naloxone kits and training, primary healthcare, mental health services, addiction support, and community programs.",
                hours: "Mon-Fri 8:30am-4:30pm",
                phone: "604-569-3949",
                address: "569 Powell St"
            },
            {
                name: "Vancouver Native Health Society",
                lat: 49.2804,
                lng: -123.1003,
                type: "Naloxone",
                description: "Indigenous-focused primary care, naloxone distribution, cultural support programs, traditional healing, and addiction counseling.",
                hours: "Mon-Fri 8:30am-5pm",
                phone: "604-254-9949",
                address: "441 E Hastings St"
            },
            {
                name: "Vancouver Area Network of Drug Users (VANDU)",
                lat: 49.2815,
                lng: -123.0997,
                type: "Naloxone",
                description: "Peer-run organization offering naloxone training, advocacy, drug checking services, and community support by people with lived experience.",
                hours: "Mon-Fri 10am-6pm",
                phone: "604-683-8595",
                address: "380 E Hastings St"
            },
            {
                name: "Lookout Health Outreach",
                lat: 49.2822,
                lng: -123.0995,
                type: "Naloxone",
                description: "Street outreach team providing naloxone distribution, wound care, health supplies, and connections to services.",
                hours: "Daily 9am-5pm (mobile)",
                phone: "604-253-2028",
                address: "Mobile outreach team"
            },
            
            // ================= DETOX & TREATMENT CENTERS =================
            {
                name: "Vancouver Detox Centre",
                lat: 49.2839,
                lng: -123.1012,
                type: "Detox",
                description: "Medical detoxification for alcohol and drugs. 24/7 walk-in service, crisis support, and referrals to ongoing treatment.",
                hours: "24/7",
                phone: "604-675-3700",
                address: "947 E Hastings St"
            },
            {
                name: "Bloom Group Detox",
                lat: 49.2801,
                lng: -123.0689,
                type: "Detox",
                description: "Community-based withdrawal management with supportive environment, counseling, and transition planning.",
                hours: "24/7",
                phone: "604-216-5668",
                address: "2425 Commercial Dr"
            },
            {
                name: "BC Centre on Substance Use",
                lat: 49.2822,
                lng: -123.1213,
                type: "Detox",
                description: "Provincial center for addiction medicine, clinical research, treatment coordination, and healthcare provider training.",
                hours: "Mon-Fri 8:30am-4:30pm",
                phone: "778-945-7619",
                address: "400-1045 Howe St"
            },
            
            // ================= FOOD BANKS & SHELTERS =================
            {
                name: "Union Gospel Mission",
                lat: 49.2825,
                lng: -123.0992,
                type: "Food",
                description: "Hot meals three times daily (7am, 12pm, 5pm), emergency shelter beds, addiction recovery programs, and community support.",
                hours: "Meals: 7am, 12pm, 5pm daily",
                phone: "604-253-3323",
                address: "616 E Cordova St"
            },
            {
                name: "Carnegie Community Centre",
                lat: 49.2817,
                lng: -123.1000,
                type: "Food",
                description: "Community hub with hot meals, showers, computer lab, library, social programs, and recreation activities.",
                hours: "Daily 9am-10pm",
                phone: "604-665-3010",
                address: "401 Main St"
            },
            {
                name: "DTES Street Market",
                lat: 49.2819,
                lng: -123.0989,
                type: "Food",
                description: "Community market with free food distribution, clothing exchange, survival supplies, and peer support.",
                hours: "Daily 10am-6pm",
                phone: "604-682-8119",
                address: "501 E Hastings St"
            },
            {
                name: "First United Church Community Ministry",
                lat: 49.2810,
                lng: -123.1019,
                type: "Food",
                description: "Daily hot meals, community kitchen, clothing room, social services, and spiritual support in welcoming environment.",
                hours: "Meals 8am-7pm daily",
                phone: "604-681-8365",
                address: "320 E Hastings St"
            },
            {
                name: "Lookout Emergency Aid Society",
                lat: 49.2833,
                lng: -123.0982,
                type: "Food",
                description: "Emergency shelter with meals, clothing bank, housing navigation, and support services for homeless individuals.",
                hours: "24/7",
                phone: "604-253-2028",
                address: "320 Alexander St"
            },
            {
                name: "Salvation Army Harbour Light",
                lat: 49.2802,
                lng: -123.1048,
                type: "Food",
                description: "Daily meals, emergency shelter, addiction recovery programs, life skills training, and community services.",
                hours: "Daily meals and services",
                phone: "604-681-7447",
                address: "119 E Cordova St"
            },
            {
                name: "Portland Hotel Society",
                lat: 49.2828,
                lng: -123.1015,
                type: "Food",
                description: "Supportive housing with on-site meals, harm reduction services, healthcare, and community programs.",
                hours: "24/7 (residents)",
                phone: "604-255-6344",
                address: "713 E Hastings St"
            },
            {
                name: "The Kettle Friendship Society",
                lat: 49.2645,
                lng: -123.1121,
                type: "Food",
                description: "Community center with hot meals, drop-in programs, mental health support, and social activities.",
                hours: "Mon-Fri 8am-4pm",
                phone: "604-251-6484",
                address: "1725 Venables St"
            },
            {
                name: "St. James Community Service Society",
                lat: 49.2789,
                lng: -123.1027,
                type: "Food",
                description: "Social services, food programs, counseling, and community development initiatives.",
                hours: "Mon-Fri 9am-4:30pm",
                phone: "604-685-4944",
                address: "303 E Cordova St"
            },
            
            // ================= URGENT CARE & MEDICAL =================
            {
                name: "St. Paul's Hospital Emergency",
                lat: 49.2757,
                lng: -123.1267,
                type: "Urgent",
                description: "24/7 full-service emergency department. Specialized in trauma care, cardiac emergencies, and substance use complications.",
                hours: "24/7 Emergency",
                phone: "604-682-2344",
                address: "1081 Burrard St"
            },
            {
                name: "Vancouver General Hospital Emergency",
                lat: 49.2624,
                lng: -123.1221,
                type: "Urgent",
                description: "Major trauma center with comprehensive emergency services, specialized care units, and 24/7 psychiatric emergency.",
                hours: "24/7 Emergency",
                phone: "604-875-4111",
                address: "899 W 12th Ave"
            },
            {
                name: "Cool Aid Community Health Centre",
                lat: 49.2795,
                lng: -123.0985,
                type: "Urgent",
                description: "Walk-in primary care for urgent health needs, mental health support, addiction services, and chronic disease management.",
                hours: "Mon-Fri 8:30am-8pm, Sat 9am-5pm",
                phone: "604-215-8437",
                address: "398 Powell St"
            },
            
            // ================= PUBLIC WASHROOMS =================
            {
                name: "Carnegie Centre Washroom",
                lat: 49.2817,
                lng: -123.1000,
                type: "Washrooms",
                description: "Clean public washroom facilities inside Carnegie Community Centre. Accessible during operating hours.",
                hours: "Daily 9am-10pm",
                phone: "604-665-3010",
                address: "401 Main St (inside)"
            },
            {
                name: "Oppenheimer Park Washroom",
                lat: 49.2816,
                lng: -123.0975,
                type: "Washrooms",
                description: "Outdoor public washroom facility in Oppenheimer Park. Seasonal hours may vary.",
                hours: "Daily 6am-10pm (seasonal)",
                phone: "311",
                address: "400 block Powell St"
            },
            {
                name: "Pigeon Park Washroom",
                lat: 49.2820,
                lng: -123.1007,
                type: "Washrooms",
                description: "Public washroom near Pigeon Park community plaza and gathering space.",
                hours: "Daily 7am-9pm",
                phone: "311",
                address: "Carrall St & W Hastings St"
            },
            {
                name: "DTES Street Market Washroom",
                lat: 49.2819,
                lng: -123.0989,
                type: "Washrooms",
                description: "Washroom facilities available at DTES Street Market during market hours.",
                hours: "Daily 10am-6pm",
                phone: "604-682-8119",
                address: "501 E Hastings St"
            }
        ];

        // ===================================================================
        // GLOBAL VARIABLES
        // ===================================================================
        let map;
        let markers = [];
        let userLocationMarker;
        let userLat, userLng;
        let routingControl;

        // ===================================================================
        // MAP INITIALIZATION
        // ===================================================================
        function initMap() {
            try {
                // Check if Leaflet library loaded successfully
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet library failed to load');
                }

                // Initialize map centered on DTES
                map = L.map('map', {
                    zoomControl: true,
                    dragging: true,
                    touchZoom: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true
                }).setView([49.2819, -123.1000], 15);

                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19,
                    minZoom: 12
                }).addTo(map);

                // Add all resource markers to map
                dtesResources.forEach(resource => {
                    addMarker(resource);
                });

                // Hide loading overlay and show app
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('mainAppContent').style.opacity = '1';
                        document.getElementById('map').style.opacity = '1';
                    }, 500);
                }, 1200);

            } catch (error) {
                console.error('Map initialization error:', error);
                // Show user-friendly error message
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="text-center px-8">
                        <p class="text-gray-800 font-bold text-xl mb-4">Map Loading Issue</p>
                        <p class="text-gray-600 mb-4">
                            The map preview may not work in this editor environment,
                            but it will work perfectly when deployed to GitHub Pages.
                        </p>
                        <p class="text-blue-600 font-semibold">
                            ‚úÖ Deploy to see the full interactive map with 25+ locations!
                        </p>
                    </div>
                `;
            }
        }

        // ===================================================================
        // ADD MARKER TO MAP
        // ===================================================================
        function addMarker(resource) {
            // Define color scheme for different resource types
            const iconColors = {
                'Naloxone': '#3B82F6',      // Blue
                'Injection Site': '#10B981', // Green
                'Detox': '#F97316',          // Orange
                'Food': '#9333EA',           // Purple
                'Urgent': '#EF4444',         // Red
                'Washrooms': '#14B8A6'       // Teal
            };

            // Create custom marker icon
            const customIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${iconColors[resource.type] || '#6B7280'};
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                "></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            // Create marker with popup
            const marker = L.marker([resource.lat, resource.lng], { icon: customIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="max-width: 280px; font-family: 'Nunito Sans', sans-serif;">
                        <h3 style="font-weight: bold; margin-bottom: 10px; font-size: 17px; color: #1F2937;">
                            ${resource.name}
                        </h3>
                        <p style="margin-bottom: 8px; font-size: 13px;">
                            <strong style="color: ${iconColors[resource.type]};">Type:</strong> ${resource.type}
                        </p>
                        <p style="margin-bottom: 8px; font-size: 13px; line-height: 1.5;">
                            ${resource.description}
                        </p>
                        <p style="margin-bottom: 8px; font-size: 13px;">
                            <strong>Hours:</strong> ${resource.hours}
                        </p>
                        <p style="margin-bottom: 12px; font-size: 13px;">
                            <strong>Phone:</strong> 
                            <a href="tel:${resource.phone}" style="color: #2563EB; text-decoration: underline;">
                                ${resource.phone}
                            </a>
                        </p>
                        <p style="margin-bottom: 12px; font-size: 12px; color: #6B7280;">
                            <i class="fas fa-map-marker-alt"></i> ${resource.address}
                        </p>
                        <button 
                            onclick="getDirections(${resource.lat}, ${resource.lng}, '${resource.name.replace(/'/g, "\\'")}');" 
                            class="popup-btn direction-btn"
                        >
                            <i class="fas fa-directions mr-1"></i> Get Walking Directions
                        </button>
                    </div>
                `, {
                    maxWidth: 300,
                    closeButton: true
                });

            // Store resource data with marker
            marker.resourceData = resource;
            markers.push(marker);
        }

        // ===================================================================
        // USER LOCATION FEATURE
        // ===================================================================
        document.getElementById('locateUserButton').addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            document.getElementById('userLocationStatus').textContent = 'Locating you...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;

                    // Remove old user location marker if exists
                    if (userLocationMarker) {
                        map.removeLayer(userLocationMarker);
                    }

                    // Create pulsing blue dot for user location
                    const userIcon = L.divIcon({
                        className: 'user-location-icon',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    userLocationMarker = L.marker([userLat, userLng], { icon: userIcon })
                        .addTo(map)
                        .bindPopup('<strong>You are here</strong><br>Your current location');

                    // Center map on user location
                    map.setView([userLat, userLng], 16);
                    document.getElementById('userLocationStatus').textContent = '‚úì Location found';

                    // Auto-open popup
                    userLocationMarker.openPopup();
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    let errorMsg = 'Could not get your location. ';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Please enable location permissions.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Location request timed out.';
                            break;
                        default:
                            errorMsg += 'An unknown error occurred.';
                    }
                    
                    alert(errorMsg);
                    document.getElementById('userLocationStatus').textContent = '‚úó Location unavailable';
                }
            );
        });

        // ===================================================================
        // DIRECTIONS FEATURE
        // ===================================================================
        window.getDirections = function(lat, lng, name) {
            if (!userLat || !userLng) {
                alert('Please click "Find My Location" first to enable turn-by-turn directions.');
                return;
            }

            // Remove existing route if present
            if (routingControl) {
                map.removeControl(routingControl);
            }

            // Create new routing control
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLat, userLng),
                    L.latLng(lat, lng)
                ],
                routeWhileDragging: false,
                lineOptions: {
                    styles: [{ 
                        color: '#EF4444', 
                        weight: 5,
                        opacity: 0.8
                    }]
                },
                createMarker: () => null, // Don't create route markers
                show: true,
                collapsible: false
            }).addTo(map);

            // Show success message
            alert(`üó∫Ô∏è Directions to ${name}\n\nFollow the red line on the map for walking directions.`);
        };

        // ===================================================================
        // FILTER BUTTONS
        // ===================================================================
        document.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                document.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-pressed', 'false');
                });

                // Add active class to clicked button
                button.classList.add('active');
                button.setAttribute('aria-pressed', 'true');

                const filterType = button.dataset.filter;

                // Filter markers based on selection
                markers.forEach(marker => {
                    if (filterType === 'all' || marker.resourceData.type === filterType) {
                        marker.addTo(map);
                    } else {
                        map.removeLayer(marker);
                    }
                });

                // Update count
                const visibleCount = markers.filter(m => 
                    filterType === 'all' || m.resourceData.type === filterType
                ).length;
                
                document.getElementById('resourceCount').textContent = 
                    `${visibleCount} location${visibleCount !== 1 ? 's' : ''} shown`;
            });
        });

        // ===================================================================
        // SEARCH FUNCTIONALITY
        // ===================================================================
        document.getElementById('searchBar').addEventListener('input', (event) => {
            const searchQuery = event.target.value.toLowerCase().trim();

            markers.forEach(marker => {
                const resource = marker.resourceData;
                const matchesSearch = 
                    resource.name.toLowerCase().includes(searchQuery) ||
                    resource.description.toLowerCase().includes(searchQuery) ||
                    resource.type.toLowerCase().includes(searchQuery) ||
                    resource.address.toLowerCase().includes(searchQuery);

                if (matchesSearch || searchQuery === '') {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });

            // Update count
            const visibleCount = markers.filter(m => map.hasLayer(m)).length;
            document.getElementById('resourceCount').textContent = 
                `${visibleCount} location${visibleCount !== 1 ? 's' : ''} shown`;
        });

        // ===================================================================
        // TIME SLIDER
        // ===================================================================
        document.getElementById('timeSlider').addEventListener('input', (event) => {
            const selectedHour = parseInt(event.target.value);
            const timeDisplay = selectedHour.toString().padStart(2, '0') + ':00';
            document.getElementById('timeValue').textContent = timeDisplay;

            // TODO: Add logic to filter by operating hours
            // This would require parsing the hours field and comparing times
        });

        // ===================================================================
        // EMERGENCY BUTTON
        // ===================================================================
        document.getElementById('emergencyButton').addEventListener('click', () => {
            // Show emergency alert
            const emergencyMsg = document.getElementById('emergencyMessage');
            emergencyMsg.classList.remove('hidden');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                emergencyMsg.classList.add('hidden');
            }, 5000);

            // In production, this could trigger actual emergency services
            console.log('Emergency button clicked - In production, this would initiate emergency contact');
        });

        // ===================================================================
        // NALOXONE INSTRUCTIONS
        // ===================================================================
        document.getElementById('instructionsButton').addEventListener('click', () => {
            alert(`
üÜò NALOXONE (NARCAN) ADMINISTRATION INSTRUCTIONS

1Ô∏è‚É£ RECOGNIZE OVERDOSE SIGNS:
   ‚Ä¢ No breathing or very slow breathing
   ‚Ä¢ Blue lips or fingernails
   ‚Ä¢ Unconscious or unresponsive
   ‚Ä¢ Gurgling or choking sounds

2Ô∏è‚É£ CALL 911 IMMEDIATELY
   ‚Ä¢ Stay on the line
   ‚Ä¢ Give exact location
   ‚Ä¢ Good Samaritan Law protects you

3Ô∏è‚É£ GIVE NALOXONE:
   Nasal Spray: Insert in nostril, press plunger
   Injectable: Inject into upper arm or thigh muscle

4Ô∏è‚É£ PROVIDE RESCUE BREATHS (if trained):
   ‚Ä¢ Tilt head back
   ‚Ä¢ Give 1 breath every 5 seconds

5Ô∏è‚É£ STAY WITH PERSON:
   ‚Ä¢ Do NOT leave them alone
   ‚Ä¢ Put in recovery position (on side)
   
6Ô∏è‚É£ SECOND DOSE:
   ‚Ä¢ Give after 3-5 minutes if no response
   ‚Ä¢ Continue until help arrives

üìû Free naloxone kits available at locations marked with blue pins on map.

‚öñÔ∏è Good Samaritan Drug Overdose Act protects you from simple possession charges when calling 911.
            `.trim());
        });

        // ===================================================================
        // REPORT STATUS BUTTON
        // ===================================================================
        document.getElementById('reportStatusButton').addEventListener('click', () => {
            alert(`
üì¢ REPORT SERVICE CHANGES

Help us keep information accurate by reporting:

‚úÖ Service closures or changes
‚úÖ Updated hours of operation  
‚úÖ New resources in the community
‚úÖ Incorrect contact information

How to report:
‚Ä¢ Email: afeefa.anwar3a@gmail.com
‚Ä¢ GitHub: Open an issue at our repository
‚Ä¢ In person: Visit any resource location

Your feedback helps the community!

Thank you for your contribution. üôè
            `.trim());
        });

        // ===================================================================
        // INITIALIZE ON PAGE LOAD
        // ===================================================================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMap);
        } else {
            // DOM already loaded
            initMap();
        }
    </script>
</body>
</html>
