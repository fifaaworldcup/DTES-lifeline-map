<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vancouver DTES Lifeline Map</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- Local libraries (for offline use, put these under /libs/) -->
  <link rel="stylesheet" href="libs/leaflet/leaflet.css">
  <link rel="stylesheet" href="libs/leaflet-routing-machine/leaflet-routing-machine.css">
  <link rel="stylesheet" href="libs/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="css/tailwind.min.css">

  <style>
    :root { --accent: #1d4ed8; --muted:#6b7280; --bg:#f6f7fb; --card:#fff; }
    html,body{ height:100%; margin:0; font-family: "Nunito Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#111; }
    .container { max-width:1100px; margin:18px auto; padding:12px; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px; }
    #map { height:70vh; min-height:380px; border-radius:12px; background:var(--card); box-shadow:0 8px 30px rgba(12,12,13,.06); overflow:hidden; }
    .chip{ display:inline-flex; gap:.5rem; align-items:center; padding:.45rem .7rem; border-radius:999px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.06); font-weight:700; cursor:pointer; border:1px solid rgba(0,0,0,.04); }
    .btn { padding:.6rem .9rem; border-radius:8px; font-weight:700; cursor:pointer; }
    .hidden { display:none !important; }
    .rtl { direction:rtl; }
    #offlineBanner { display:none; background:#ffedd5; color:#7c2d12; padding:8px 12px; border-radius:8px; margin-bottom:12px; }
    #listView { display:none; background:var(--card); padding:12px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.06); max-height:60vh; overflow:auto; }
    .resource-card { border-bottom:1px solid #eef2f7; padding:10px 0; }
    .resource-card:last-child { border-bottom:none; }
    #accessibilityPanel { position:fixed; left:18px; bottom:18px; z-index:1100; background:rgba(255,255,255,.98); padding:10px; border-radius:10px; box-shadow:0 8px 24px rgba(12,12,13,.12); }
    #accessibilityPanel.minimized { height:40px; overflow:hidden; width:60px; padding:6px; border-radius:8px; }
    .access-item { margin-bottom:8px; display:flex; gap:8px; align-items:center; }
    .high-contrast { background:#000 !important; color:#fff !important; }
    .dyslexic-font { font-family: "OpenDyslexic", "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial !important; }
    .skip-link { position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
    .skip-link:focus { left:10px; top:10px; width:auto; height:auto; padding:8px 12px; background:#111; color:#fff; border-radius:6px; z-index:3000; }
    .filter-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .filter-button { padding:.45rem .6rem; border-radius:8px; border:1px solid rgba(0,0,0,.06); background:#fff; cursor:pointer; font-weight:700; }
    .filter-button.active { outline:3px solid rgba(29,78,216,.12); transform:translateY(-2px); }
    .popup-btn { padding:0.4rem 0.7rem; border-radius:0.5rem; font-weight:600; display:inline-flex; align-items:center; justify-content:center; margin-top:10px; margin-right:5px; font-size:0.85rem; cursor:pointer; border:none; }
    .error-message { background:#fee; color:#c00; padding:8px; border-radius:4px; margin:8px 0; }
    .loading { display:inline-block; width:20px; height:20px; border:3px solid rgba(0,0,0,0.1); border-radius:50%; border-top-color:var(--accent); animation:spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<a href="#main" class="skip-link">Skip to content</a>

<div class="container" id="main" role="main" aria-live="polite">
  <header>
    <div style="flex:1;">
      <h1 id="mainTitle" style="margin:0;font-size:22px;">Vancouver DTES Lifeline Map</h1>
      <p id="subtitle" style="margin:6px 0;color:var(--muted);">Immediate access to food, shelters, harm reduction, and hotlines.</p>
      <div id="statusLine" style="font-size:13px;color:var(--muted);">Verified resources — call before you go.</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <select id="languageSelect" aria-label="Choose language" class="chip" title="Language">
        <option value="en">English</option>
        <option value="zh">中文</option>
        <option value="es">Español</option>
        <option value="fr">Français</option>
        <option value="bn">বাংলা</option>
        <option value="tl">Tagalog</option>
        <option value="ar">العربية</option>
        <option value="fa">فارسی</option>
        <option value="hi">हिन्दी</option>
        <option value="ur">اردو</option>
        <option value="pa">ਪੰਜਾਬੀ</option>
        <option value="nl">Nederlands</option>
        <option value="it">Italiano</option>
        <option value="sv">Svenska</option>
        <option value="de">Deutsch</option>
        <option value="pt">Português</option>
      </select>
      <button id="toggleListView" class="chip" title="Toggle list view">List view</button>
    </div>
  </header>

  <div id="offlineBanner" role="status"></div>
  <div id="errorMessage" class="error-message hidden" role="alert"></div>

  <!-- Search and quick actions -->
  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px; align-items:center;">
    <input id="searchBar" placeholder="Search by name, type, or service" style="flex:1;padding:10px;border-radius:10px;border:1px solid #e6edf3;" aria-label="Search resources" />
    <button id="locateUserButton" class="chip btn" title="Find my location"><i class="fas fa-crosshairs"></i>&nbsp; Find me</button>
    <button id="emergencyButton" class="chip btn" style="background:#ef4444;color:#fff;"><i class="fas fa-phone-alt"></i>&nbsp; 911</button>
  </div>

  <!-- Filters -->
  <div class="filter-row" id="filterRow" aria-label="Category filters" role="toolbar">
    <button class="filter-button active" data-filter="all">All</button>
    <button class="filter-button" data-filter="Naloxone">Naloxone</button>
    <button class="filter-button" data-filter="Injection Site">Sites</button>
    <button class="filter-button" data-filter="Detox">Detox</button>
    <button class="filter-button" data-filter="Food">Food</button>
    <button class="filter-button" data-filter="Shelter">Shelter</button>
    <button class="filter-button" data-filter="Washrooms">Washrooms</button>
    <button class="filter-button" data-filter="Clothing">Clothing</button>
    <button class="filter-button" data-filter="Mental Health">Mental</button>
    <button class="filter-button" data-filter="Hotline">Hotlines</button>
  </div>

  <!-- Map -->
  <div id="map" aria-label="Map">
    <div id="mapLoading" class="loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);"></div>
  </div>

  <!-- OFFLINE LIST (fallback) -->
  <div id="listView" aria-live="polite"></div>

  <!-- Hotlines -->
  <footer style="margin-top:12px;">
    <h2 id="hotlinesTitle" style="margin:6px 0 12px 0;">Hotlines & Support</h2>
    <div id="hotlinesGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;"></div>
    <div style="color:var(--muted);font-size:12px;margin-top:10px;">Made for the DTES community — verify hours by calling first.</div>
  </footer>
</div>

<!-- QR Modal -->
<div id="qrModal" class="hidden" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9000;">
  <div style="background:#fff;padding:18px;border-radius:12px;max-width:420px;width:92%;">
    <button id="closeQr" style="float:right;background:none;border:none;font-size:20px;">×</button>
    <h3 id="qrTitle">QR Code</h3>
    <div id="qrcode" style="margin:12px auto;"></div>
    <div id="qrName" style="color:var(--muted);font-size:13px;"></div>
  </div>
</div>

<!-- Accessibility panel (minimizable) -->
<div id="accessibilityPanel" role="region" aria-label="Accessibility controls">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <strong>Accessibility</strong>
    <button id="minimizeAccess" class="chip" title="Minimize accessibility panel">━</button>
  </div>

  <div id="accessControls">
    <div class="access-item">
      <label class="chip" for="contrastToggle"><i class="fas fa-adjust"></i>&nbsp; Contrast</label>
      <button id="contrastToggle" class="chip">Toggle</button>
    </div>

    <div class="access-item">
      <label class="chip"><i class="fas fa-text-height"></i>&nbsp; Font Size</label>
      <div style="display:flex;gap:6px">
        <button id="fontDec" class="chip">A-</button>
        <button id="fontInc" class="chip">A+</button>
      </div>
    </div>

    <div class="access-item">
      <label class="chip"><i class="fas fa-font"></i>&nbsp; Dyslexic Font</label>
      <button id="dyslexicToggle" class="chip">Toggle</button>
    </div>

    <div class="access-item">
      <label class="chip"><i class="fas fa-volume-up"></i>&nbsp; Read Popup</label>
      <button id="readPopupBtn" class="chip">Read</button>
    </div>

    <div class="access-item">
      <label class="chip"><i class="fas fa-arrows-alt-h"></i>&nbsp; Reduce Motion</label>
      <button id="reducedMotionToggle" class="chip">Toggle</button>
    </div>
  </div>
</div>

<!-- Required libraries (put local copies here for offline): -->
<script src="libs/leaflet/leaflet.js"></script>
<script src="libs/leaflet-routing-machine/leaflet-routing-machine.js"></script>
<script src="libs/qrcode/qrcode.min.js"></script>

<script>
/* ===========================
   DTES Lifeline Map — main JS
   - Loads dtes-resources.json (single source of truth)
   - Registers service worker /sw.js
   - Supports translations + RTL
   - Accessibility panel + TTS helper
   - Filters, search, find-me, QR, routing
   - Offline fallback (list view)
   =========================== */

/* ---------- Translations ---------- */
const translations = {
  en: { 
    title: "Vancouver DTES Lifeline Map", 
    subtitle: "Immediate access to food, shelters, harm reduction, and hotlines.", 
    searchPlaceholder: "Search by name, type, or service", 
    offlineBanner: "You are offline — map tiles may be unavailable. Use list view for full access.", 
    popup: {
      type: "Type", 
      hours: "Hours", 
      call: "Call", 
      getDirections: "Get Directions", 
      openInMaps: "Open in Maps", 
      showQRCode: "Show QR"
    }, 
    locate: "Find My Location", 
    locationFound: "Location found!", 
    enableLocationFirst: "Enable your location first", 
    directionsTo: "Directions to", 
    followRedLine: "Follow the red line on the map",
    hotlinesTitle: "Hotlines & Support",
    listView: "List view",
    mapView: "Map view",
    loading: "Loading...",
    error: "Error"
  }, 
  ar: { 
    title: "خريطة موارد DTES - فانكوفر", 
    subtitle: "الوصول الفوري إلى خفض الأذى والملاجئ وخدمات الدعم", 
    searchPlaceholder: "ابحث بالاسم أو النوع أو الخدمة", 
    offlineBanner: "أنت في وضع عدم الاتصال — قد لا تتوفر بلاطات الخريطة. استخدم عرض القائمة.", 
    popup: {
      type: "النوع", 
      hours: "الساعات", 
      call: "اتصل", 
      getDirections: "الاتجاهات", 
      openInMaps: "فتح الخرائط", 
      showQRCode: "رمز QR"
    }, 
    locate: "موقعي", 
    locationFound: "تم العثور على الموقع!", 
    enableLocationFirst: "فعّل موقعك أولاً", 
    directionsTo: "اتجه إلى", 
    followRedLine: "اتبع الخط الأحمر",
    hotlinesTitle: "خطوط المساعدة والدعم",
    listView: "عرض القائمة",
    mapView: "عرض الخريطة",
    loading: "جاري التحميل...",
    error: "خطأ"
  }, 
  zh: { 
    title: "DTES 资源地图", 
    subtitle: "即时获取社区资源", 
    searchPlaceholder: "按名称、类型或服务搜索", 
    offlineBanner: "您处于离线状态 —— 地图切片可能无法使用。", 
    popup: {
      type: "类型", 
      hours: "时间", 
      call: "致电", 
      getDirections: "获取路线", 
      openInMaps: "在地图中打开", 
      showQRCode: "显示二维码"
    }, 
    locate: "定位", 
    locationFound: "找到位置！", 
    enableLocationFirst: "请先启用位置", 
    directionsTo: "前往", 
    followRedLine: "沿着红线走",
    hotlinesTitle: "热线与支持",
    listView: "列表视图",
    mapView: "地图视图",
    loading: "加载中...",
    error: "错误"
  },
  es: { 
    title: "Mapa DTES", 
    subtitle: "Recursos comunitarios", 
    searchPlaceholder: "Buscar por nombre, tipo o servicio", 
    offlineBanner: "Estás sin conexión.", 
    popup: {
      type: "Tipo", 
      hours: "Horario", 
      call: "Llamar", 
      getDirections: "Direcciones", 
      openInMaps: "Abrir en Mapas", 
      showQRCode: "Código QR"
    }, 
    locate: "Mi ubicación", 
    locationFound: "Ubicación encontrada", 
    enableLocationFirst: "Activa tu ubicación primero", 
    directionsTo: "Direcciones a", 
    followRedLine: "Sigue la línea roja en el mapa",
    hotlinesTitle: "Líneas de ayuda y apoyo",
    listView: "Vista de lista",
    mapView: "Vista de mapa",
    loading: "Cargando...",
    error: "Error"
  },
  fr: { 
    title: "Carte DTES", 
    subtitle: "Ressources communautaires", 
    searchPlaceholder: "Rechercher par nom, type ou service", 
    offlineBanner: "Hors ligne.", 
    popup: {
      type: "Type", 
      hours: "Heures", 
      call: "Appeler", 
      getDirections: "Itinéraire", 
      openInMaps: "Ouvrir Maps", 
      showQRCode: "Code QR"
    }, 
    locate: "Ma position", 
    locationFound: "Position trouvée", 
    enableLocationFirst: "Activez votre localisation d'abord", 
    directionsTo: "Itinéraire vers", 
    followRedLine: "Suivez la ligne rouge sur la carte",
    hotlinesTitle: "Lignes d'assistance et soutien",
    listView: "Vue liste",
    mapView: "Vue carte",
    loading: "Chargement...",
    error: "Erreur"
  },
  bn: { 
    title: "DTES রিসোর্স মানচিত্র", 
    subtitle: "কমিউনিটি রিসোর্স এক ক্লিকে", 
    searchPlaceholder: "নাম, কাস্ট বা সার্ভিস দিয়ে খুঁজুন", 
    offlineBanner: "অফলাইন।", 
    popup: {
      type: "ধরন", 
      hours: "ঘণ্টা", 
      call: "কল", 
      getDirections: "দিকনির্দেশ", 
      openInMaps: "মানচিত্রে খুলুন", 
      showQRCode: "QR কোড"
    }, 
    locate: "আমার অবস্থান", 
    locationFound: "অবস্থান পাওয়া গেছে", 
    enableLocationFirst: "প্রথমে আপনার অবস্থান সক্রিয় করুন", 
    directionsTo: "এর দিকনির্দেশ", 
    followRedLine: "মানচিত্রে লাল লাইন অনুসরণ করুন",
    hotlinesTitle: "হটলাইন এবং সহায়তা",
    listView: "তালিকা ভিউ",
    mapView: "মানচিত্র ভিউ",
    loading: "লোড হচ্ছে...",
    error: "ত্রুটি"
  },
  tl: { 
    title: "DTES Resource Map", 
    subtitle: "Mabilis na pag-access sa mga mapagkukunan ng komunidad", 
    searchPlaceholder: "Maghanap ayon sa pangalan, uri, o serbisyo", 
    offlineBanner: "Ikaw ay offline.", 
    popup: {
      type: "Uri", 
      hours: "Oras", 
      call: "Tawagan", 
      getDirections: "Mga Direksyon", 
      openInMaps: "Buksan sa Maps", 
      showQRCode: "QR Code"
    }, 
    locate: "Aking lokasyon", 
    locationFound: "Nahanap ang lokasyon", 
    enableLocationFirst: "I-activate muna ang iyong lokasyon", 
    directionsTo: "Mga direksyon patungo sa", 
    followRedLine: "Sundan ang pulang linya sa mapa",
    hotlinesTitle: "Mga Hotline at Suporta",
    listView: "Tingnan sa listahan",
    mapView: "Tingnan sa mapa",
    loading: "Naglo-load...",
    error: "Error"
  },
  fa: { 
    title: "نقشه منابع DTES", 
    subtitle: "دسترسی فوری به منابع جامعه", 
    searchPlaceholder: "جستجو بر اساس نام، نوع یا خدمات", 
    offlineBanner: "شما آفلاین هستید.", 
    popup: {
      type: "نوع", 
      hours: "ساعات", 
      call: "تماس", 
      getDirections: "مسیرها", 
      openInMaps: "باز کردن در نقشه", 
      showQRCode: "کد QR"
    }, 
    locate: "موقعیت من", 
    locationFound: "موقعیت پیدا شد", 
    enableLocationFirst: "ابتدا موقعیت خود را فعال کنید", 
    directionsTo: "مسیرها به", 
    followRedLine: "خط قرمز را روی نقشه دنبال کنید",
    hotlinesTitle: "خطوط فوری و پشتیبانی",
    listView: "نمای لیست",
    mapView: "نمای نقشه",
    loading: "در حال بارگذاری...",
    error: "خطا"
  },
  hi: { 
    title: "DTES संसाधन मानचित्र", 
    subtitle: "सामुदायिक संसाधनों तक तत्काल पहुंच", 
    searchPlaceholder: "नाम, प्रकार, या सेवा द्वारा खोजें", 
    offlineBanner: "आप ऑफ़लाइन हैं।", 
    popup: {
      type: "प्रकार", 
      hours: "घंटे", 
      call: "कॉल करें", 
      getDirections: "दिशाएं", 
      openInMaps: "मैप्स में खोलें", 
      showQRCode: "QR कोड"
    }, 
    locate: "मेरा स्थान", 
    locationFound: "स्थान मिल गया", 
    enableLocationFirst: "पहले अपना स्थान सक्षम करें", 
    directionsTo: "के लिए दिशाएं", 
    followRedLine: "मानचित्र पर लाल रेखा का पालन करें",
    hotlinesTitle: "हॉटलाइन और समर्थन",
    listView: "सूची दृश्य",
    mapView: "मानचित्र दृश्य",
    loading: "लोड हो रहा है...",
    error: "त्रुटि"
  },
  ur: { 
    title: "DTES وسائل کا نقشہ", 
    subtitle: "برادران کے وسائل تک فوری رسائی", 
    searchPlaceholder: "نام، قسم، یا سروس کے ذریعے تلاش کریں", 
    offlineBanner: "آپ آف لائن ہیں۔", 
    popup: {
      type: "قسم", 
      hours: "گھنٹے", 
      call: "کال کریں", 
      getDirections: "سمت", 
      openInMaps: "نقشے میں کھولیں", 
      showQRCode: "QR کوڈ"
    }, 
    locate: "میری جگہ", 
    locationFound: "جگہ مل گئی", 
    enableLocationFirst: "پہلے اپنی جگہ فعال کریں", 
    directionsTo: "کی سمت", 
    followRedLine: "نقشے پر لال لائن کی پیروی کریں",
    hotlinesTitle: "ہاٹ لائنز اور سپورٹ",
    listView: "فہرست کا نظارہ",
    mapView: "نقشے کا نظارہ",
    loading: "لوڈ ہو رہا ہے...",
    error: "خرابی"
  },
  pa: { 
    title: "DTES ਸਰੋਤ ਨਕਸ਼ਾ", 
    subtitle: "ਭਾਈਚਾਰਕ ਸਰੋਤਾਂ ਤਕ ਤੁਰੰਤ ਪਹੁੰਚ", 
    searchPlaceholder: "ਨਾਮ, ਕਿਸਮ, ਜਾਂ ਸੇਵਾ ਦੁਆਰਾ ਖੋਜੋ", 
    offlineBanner: "ਤੁਸੀਂ ਆਫਲਾਈਨ ਹੋ।", 
    popup: {
      type: "ਕਿਸਮ", 
      hours: "ਘੰਟੇ", 
      call: "ਕਾਲ ਕਰੋ", 
      getDirections: "ਦਿਸ਼ਾਵਾਂ", 
      openInMaps: "ਨਕਸ਼ਿਆਂ ਵਿੱਚ ਖੋਲ੍ਹੋ", 
      showQRCode: "QR ਕੋਡ"
    }, 
    locate: "ਮੇਰਾ ਟਿਕਾਣਾ", 
    locationFound: "ਟਿਕਾਣਾ ਲੱਭ ਗਿਆ", 
    enableLocationFirst: "ਪਹਿਲਾਂ ਆਪਣਾ ਟਿਕਾਣਾ ਯੋਗ ਕਰੋ", 
    directionsTo: "ਵੱਲ ਦਿਸ਼ਾਵਾਂ", 
    followRedLine: "ਨਕਸ਼ੇ 'ਤੇ ਲਾਲ ਲਾਈਨ ਦੀ ਪਾਲਣਾ ਕਰੋ",
    hotlinesTitle: "ਹਾਟਲਾਈਨਾਂ ਅਤੇ ਸਹਾਇਤਾ",
    listView: "ਸੂਚੀ ਦ੍ਰਿਸ਼",
    mapView: "ਨਕਸ਼ਾ ਦ੍ਰਿਸ਼",
    loading: "ਲੋਡ ਹੋ ਰਿਹਾ ਹੈ...",
    error: "ਗਲਤੀ"
  },
  nl: { 
    title: "DTES Bronnenkaart", 
    subtitle: "Onmiddellijke toegang tot gemeenschapsbronnen", 
    searchPlaceholder: "Zoek op naam, type of dienst", 
    offlineBanner: "Je bent offline.", 
    popup: {
      type: "Type", 
      hours: "Uren", 
      call: "Bel", 
      getDirections: "Routebeschrijving", 
      openInMaps: "Openen in Kaarten", 
      showQRCode: "QR Code"
    }, 
    locate: "Mijn locatie", 
    locationFound: "Locatie gevonden", 
    enableLocationFirst: "Activeer eerst je locatie", 
    directionsTo: "Routebeschrijving naar", 
    followRedLine: "Volg de rode lijn op de kaart",
    hotlinesTitle: "Hulplijnen en ondersteuning",
    listView: "Lijstweergave",
    mapView: "Kaartweergave",
    loading: "Laden...",
    error: "Fout"
  },
  it: { 
    title: "Mappa Risorse DTES", 
    subtitle: "Accesso immediato alle risorse della comunità", 
    searchPlaceholder: "Cerca per nome, tipo o servizio", 
    offlineBanner: "Sei offline.", 
    popup: {
      type: "Tipo", 
      hours: "Orari", 
      call: "Chiama", 
      getDirections: "Indicazioni", 
      openInMaps: "Apri in Mappe", 
      showQRCode: "Codice QR"
    }, 
    locate: "La mia posizione", 
    locationFound: "Posizione trovata", 
    enableLocationFirst: "Attiva prima la tua posizione", 
    directionsTo: "Indicazioni per", 
    followRedLine: "Segui la linea rossa sulla mappa",
    hotlinesTitle: "Linee di aiuto e supporto",
    listView: "Vista elenco",
    mapView: "Vista mappa",
    loading: "Caricamento...",
    error: "Errore"
  },
  sv: { 
    title: "DTES Resurskarta", 
    subtitle: "Omedelbar tillgång till gemenskapsresurser", 
    searchPlaceholder: "Sök efter namn, typ eller tjänst", 
    offlineBanner: "Du är offline.", 
    popup: {
      type: "Typ", 
      hours: "Tider", 
      call: "Ring", 
      getDirections: "Vägbeskrivning", 
      openInMaps: "Öppna i Kartor", 
      showQRCode: "QR-kod"
    }, 
    locate: "Min plats", 
    locationFound: "Plats hittad", 
    enableLocationFirst: "Aktivera din plats först", 
    directionsTo: "Vägbeskrivning till", 
    followRedLine: "Följ den röda linjen på kartan",
    hotlinesTitle: "Jourtelefoner och stöd",
    listView: "Listvy",
    mapView: "Kartvy",
    loading: "Laddar...",
    error: "Fel"
  },
  de: { 
    title: "DTES Ressourcenkarte", 
    subtitle: "Sofortiger Zugang zu Gemeinschaftsressourcen", 
    searchPlaceholder: "Nach Name, Typ oder Dienst suchen", 
    offlineBanner: "Sie sind offline.", 
    popup: {
      type: "Typ", 
      hours: "Öffnungszeiten", 
      call: "Anrufen", 
      getDirections: "Wegbeschreibung", 
      openInMaps: "In Karten öffnen", 
      showQRCode: "QR-Code"
    }, 
    locate: "Mein Standort", 
    locationFound: "Standort gefunden", 
    enableLocationFirst: "Aktivieren Sie zuerst Ihren Standort", 
    directionsTo: "Wegbeschreibung zu", 
    followRedLine: "Folgen Sie der roten Linie auf der Karte",
    hotlinesTitle: "Hotlines und Unterstützung",
    listView: "Listenansicht",
    mapView: "Kartenansicht",
    loading: "Laden...",
    error: "Fehler"
  },
  pt: { 
    title: "Mapa de Recursos DTES", 
    subtitle: "Acesso imediato a recursos da comunidade", 
    searchPlaceholder: "Pesquisar por nome, tipo ou serviço", 
    offlineBanner: "Você está offline.", 
    popup: {
      type: "Tipo", 
      hours: "Horas", 
      call: "Ligar", 
      getDirections: "Direções", 
      openInMaps: "Abrir no Mapas", 
      showQRCode: "Código QR"
    }, 
    locate: "Minha localização", 
    locationFound: "Localização encontrada", 
    enableLocationFirst: "Ative sua localização primeiro", 
    directionsTo: "Direções para", 
    followRedLine: "Siga a linha vermelha no mapa",
    hotlinesTitle: "Linhas de ajuda e suporte",
    listView: "Visualização de lista",
    mapView: "Visualização de mapa",
    loading: "Carregando...",
    error: "Erro"
  }
};

/* ---------- State ---------- */
let currentLang = 'en';
let map = null;
let markers = [];
let resources = [];
let userLoc = null;
let routingControl = null;
let lastOpenPopupText = '';

/* ---------- Utils ---------- */
const $ = id => document.getElementById(id);
const safe = v => v === null || v === undefined ? '' : String(v);

/* ---------- Error handling ---------- */
function showError(message) {
  const errorEl = $('errorMessage');
  errorEl.textContent = message;
  errorEl.classList.remove('hidden');
  setTimeout(() => errorEl.classList.add('hidden'), 5000);
}

/* ---------- Load JSON resources ---------- */
async function loadResources(){
  try {
    showLoading(true);
    const resp = await fetch('dtes-resources.json', { cache: 'no-store' });
    if(!resp.ok) throw new Error('Fetch failed ' + resp.status);
    resources = await resp.json();
  } catch (err) {
    console.warn('Primary fetch failed, trying cache', err);
    try {
      const cached = await caches.match('/dtes-resources.json');
      if(cached){
        resources = JSON.parse(await cached.text());
      } else {
        throw new Error('No cached data available');
      }
    } catch (cacheErr) {
      console.error('No data available', cacheErr);
      showError('Failed to load resources. Please try again later.');
      resources = [];
    }
  } finally {
    showLoading(false);
    renderHotlines();
    renderList();
    addMarkersFromResources();
    updateStatusLine();
  }
}

function showLoading(show) {
  const loadingEl = $('mapLoading');
  if (loadingEl) {
    loadingEl.style.display = show ? 'block' : 'none';
  }
}

/* ---------- Map init ---------- */
function initMap(){
  if(map) return;
  try {
    map = L.map('map').setView([49.2819, -123.1000], 14);
    const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap', maxZoom:19 });
    tileLayer.addTo(map);
    tileLayer.on('tileerror', () => showOfflineFallback());
  } catch (err) {
    console.error('Failed to initialize map', err);
    showError('Failed to load map. Please check your internet connection.');
    showOfflineFallback();
  }
}

/* ---------- Add markers ---------- */
function addMarkersFromResources(){
  if(!map) initMap();
  // remove previous markers
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  resources.forEach(r => {
    if(typeof r.lat === 'number' && typeof r.lng === 'number'){
      const colorMap = {'Food':'#9333EA','Shelter':'#b45309','Detox':'#F97316','Naloxone':'#3B82F6','Hotline':'#6B7280','Washrooms':'#14B8A6','Mental Health':'#EC4899','Injection Site':'#10B981','Clothing':'#0ea5a4'};
      const color = colorMap[r.type] || '#6B7280';
      const icon = L.divIcon({ html:`<div style="background:${color};width:28px;height:28px;border-radius:50%;border:3px solid white"></div>`, className:'', iconSize:[28,28], iconAnchor:[14,14] });
      const m = L.marker([r.lat, r.lng], { icon }).addTo(map);
      m.resource = r;
      m.bindPopup(createPopup(r), { maxWidth:340 });
      m.on('popupopen', () => { lastOpenPopupText = stripHtml(createPopup(r)); });
      markers.push(m);
    }
  });
}

/* ---------- Popup HTML ---------- */
function createPopup(r){
  const t = translations[currentLang] ? translations[currentLang].popup : translations.en.popup;
  const phone = r.phone ? `<a href="tel:${safe(r.phone)}">${safe(r.phone)}</a>` : 'N/A';
  const addr = safe(r.address||'');
  return `
    <div style="font-family:inherit;">
      <h3 style="margin:0 0 6px 0;font-weight:800">${safe(r.name)}</h3>
      <div style="font-size:13px;margin-bottom:6px;"><strong>${t.type}:</strong> ${safe(r.type)}</div>
      <div style="font-size:13px;margin-bottom:6px;"><strong>${t.hours}:</strong> ${safe(r.hours||'N/A')}</div>
      <div style="font-size:13px;margin-bottom:8px;"><strong>${t.call}:</strong> ${phone}</div>
      <div style="color:var(--muted);font-size:13px;margin-bottom:8px;">${addr}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button onclick="getDirections(${r.lat}, ${r.lng}, '${escapeForJS(r.name)}')" class="popup-btn" style="background:#ef4444;color:#fff;"><i class="fas fa-directions"></i>&nbsp; ${t.getDirections}</button>
        <button onclick="openInMaps(${r.lat}, ${r.lng}, '${escapeForJS(r.name)}')" class="popup-btn" style="background:#2563EB;color:#fff;"><i class="fas fa-external-link-alt"></i>&nbsp; ${t.openInMaps}</button>
        <button onclick="showQR(${r.lat}, ${r.lng}, '${escapeForJS(r.name)}')" class="popup-btn" style="background:#10B981;color:#fff;"><i class="fas fa-qrcode"></i>&nbsp; ${t.showQRCode}</button>
      </div>
    </div>
  `;
}

/* ---------- Helpers ---------- */
function escapeForJS(s){ return String(s).replace(/'/g,"\\'").replace(/"/g,'&quot;'); }
function stripHtml(html){ 
  const div = document.createElement('div');
  div.innerHTML = html;
  return div.textContent || div.innerText || ''; 
}

/* ---------- Directions & External Maps ---------- */
function getDirections(lat,lng,name){
  if(!userLoc) { 
    alert(translations[currentLang].enableLocationFirst || translations.en.enableLocationFirst); 
    return; 
  }
  try {
    if(routingControl) routingControl.remove();
    routingControl = L.Routing.control({
      waypoints: [L.latLng(userLoc.lat, userLoc.lng), L.latLng(lat,lng)],
      lineOptions: { styles: [{ color: '#ef4444', weight: 5, opacity: .9 }]},
      createMarker: () => null
    }).addTo(map);
    alert((translations[currentLang].directionsTo || translations.en.directionsTo) + ' ' + name);
  } catch (err) {
    console.error('Failed to get directions', err);
    showError('Failed to calculate directions. Please try again.');
  }
}

function openInMaps(lat,lng,name){
  try {
    const url = `https://maps.google.com/?q=${lat},${lng}(${encodeURIComponent(name)})`;
    window.open(url, '_blank');
  } catch (err) {
    console.error('Failed to open maps', err);
    showError('Failed to open external maps. Please try again.');
  }
}

/* ---------- QR ---------- */
function showQR(lat,lng,name){
  try {
    const url = `https://maps.google.com/?q=${lat},${lng}(${encodeURIComponent(name)})`;
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), { text: url, width:200, height:200 });
    document.getElementById('qrName').textContent = name;
    document.getElementById('qrModal').classList.remove('hidden');
  } catch (err) {
    console.error('Failed to generate QR code', err);
    showError('Failed to generate QR code. Please try again.');
  }
}

/* ---------- List view ---------- */
function renderList(){
  const list = document.getElementById('listView');
  list.innerHTML = '';
  resources.forEach(r => {
    const d = document.createElement('div');
    d.className = 'resource-card';
    d.innerHTML = `<div style="font-weight:800">${safe(r.name)}</div>
                   <div style="color:var(--muted);font-size:13px">${safe(r.type)} • ${safe(r.address||'')}</div>
                   <div style="margin-top:6px;"><a href="tel:${safe(r.phone)}">${safe(r.phone||'')}</a></div>`;
    list.appendChild(d);
  });
}

/* ---------- Hotlines ---------- */
function renderHotlines(){
  const grid = document.getElementById('hotlinesGrid');
  grid.innerHTML = '';
  const hotlines = resources.filter(r => r.type && String(r.type).toLowerCase().includes('hotline'));
  const arr = hotlines.length ? hotlines : [
    { name:"BC Mental Health", phone:"310-6789", description:"Provincial mental health support" },
    { name:"Suicide Crisis (9-8-8)", phone:"988", description:"24/7 support" },
    { name:"Kids Help Phone", phone:"1-800-668-6868", description:"24/7 support for youth" }
  ];
  arr.forEach(h => {
    const el = document.createElement('div');
    el.innerHTML = `<div style="font-weight:800;color:#0ea5a4">${safe(h.name)}</div><div style="font-weight:800"><a href="tel:${safe(h.phone)}">${safe(h.phone)}</a></div><div style="font-size:12px;color:var(--muted)">${safe(h.description||'')}</div>`;
    grid.appendChild(el);
  });
}

/* ---------- Search & Filters ---------- */
document.getElementById('searchBar').addEventListener('input', e => {
  const q = e.target.value.toLowerCase().trim();
  markers.forEach(m => {
    const r = m.resource || {};
    const hay = `${safe(r.name)} ${safe(r.type)} ${safe(r.address||'')} ${safe(r.description||'')} ${safe(r.phone||'')}`.toLowerCase();
    if(q === '' || hay.includes(q)) m.addTo(map); else map.removeLayer(m);
  });
});

document.querySelectorAll('.filter-button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const filter = btn.dataset.filter;
    markers.forEach(m => {
      if(filter === 'all' || (m.resource && m.resource.type === filter)) m.addTo(map); else map.removeLayer(m);
    });
  });
});

/* ---------- Geolocation ---------- */
document.getElementById('locateUserButton').addEventListener('click', () => {
  if(!navigator.geolocation) {
    showError('Geolocation is not supported by your browser');
    return;
  }
  
  navigator.geolocation.getCurrentPosition(pos => {
    userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    if(window._you) map.removeLayer(window._you);
    window._you = L.circleMarker([userLoc.lat, userLoc.lng], { radius:8, color:'#2563EB', fillColor:'#3B82F6', fillOpacity:1 }).addTo(map).bindPopup(translations[currentLang].locationFound || translations.en.locationFound);
    map.setView([userLoc.lat, userLoc.lng], 15);
  }, err => { 
    console.error('Geolocation error', err);
    showError('Unable to get location: ' + err.message); 
  });
});

/* ---------- QR modal close ---------- */
document.getElementById('closeQr').addEventListener('click', ()=> document.getElementById('qrModal').classList.add('hidden'));
window.addEventListener('click', e => { if(e.target === document.getElementById('qrModal')) document.getElementById('qrModal').classList.add('hidden'); });

/* ---------- Accessibility controls ---------- */
document.getElementById('contrastToggle').addEventListener('click', () => {
  document.body.classList.toggle('high-contrast');
});
document.getElementById('fontInc').addEventListener('click', () => {
  const root = document.documentElement;
  const size = parseFloat(getComputedStyle(root).fontSize || 16);
  root.style.fontSize = (size + 1) + 'px';
});
document.getElementById('fontDec').addEventListener('click', () => {
  const root = document.documentElement;
  const size = parseFloat(getComputedStyle(root).fontSize || 16);
  root.style.fontSize = Math.max(12, size - 1) + 'px';
});
document.getElementById('dyslexicToggle').addEventListener('click', () => {
  document.body.classList.toggle('dyslexic-font');
});
document.getElementById('readPopupBtn').addEventListener('click', () => {
  if(!lastOpenPopupText) { 
    alert('Open a resource popup first'); 
    return; 
  }
  speak(lastOpenPopupText);
});
document.getElementById('reducedMotionToggle').addEventListener('click', () => {
  if(window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    alert('Your system already requests reduced motion.');
  } else {
    // best-effort: add class to reduce CSS transitions
    document.body.classList.toggle('reduced-motion');
  }
});
document.getElementById('minimizeAccess').addEventListener('click', () => {
  const p = document.getElementById('accessibilityPanel');
  p.classList.toggle('minimized');
});

/* ---------- Text-to-speech ---------- */
function speak(text){
  if(!('speechSynthesis' in window)) {
    showError('Text-to-speech is not supported by your browser');
    return;
  }
  const ut = new SpeechSynthesisUtterance(text);
  const langMap = { ar: 'ar-SA', fa:'fa-IR', ur:'ur-PK', zh:'zh-CN', hi:'hi-IN', en:'en-US', fr:'fr-FR', es:'es-ES', bn:'bn-BD' };
  ut.lang = langMap[currentLang] || currentLang || 'en-US';
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(ut);
}

/* ---------- Read open popup (dev helper) ---------- */
window.readOpenPopup = () => { 
  if(!lastOpenPopupText) alert('No open popup'); 
  else speak(lastOpenPopupText); 
};

/* ---------- Offline fallback ---------- */
function showOfflineFallback(){
  // hide map, show list
  document.getElementById('map').style.display = 'none';
  document.getElementById('listView').style.display = 'block';
}
document.getElementById('toggleListView').addEventListener('click', () => {
  const lv = document.getElementById('listView');
  if(lv.style.display === 'block') { 
    lv.style.display = 'none'; 
    document.getElementById('map').style.display = ''; 
    document.getElementById('toggleListView').textContent = translations[currentLang].listView || translations.en.listView; 
  }
  else { 
    lv.style.display = 'block'; 
    document.getElementById('map').style.display = 'none'; 
    document.getElementById('toggleListView').textContent = translations[currentLang].mapView || translations.en.mapView; 
  }
});

/* ---------- Online status ---------- */
function updateOnlineUI(){
  const offline = !navigator.onLine;
  const banner = document.getElementById('offlineBanner');
  banner.style.display = offline ? 'block' : 'none';
  if(offline) banner.textContent = translations[currentLang].offlineBanner || translations.en.offlineBanner;
}
window.addEventListener('online', updateOnlineUI);
window.addEventListener('offline', updateOnlineUI);

/* ---------- Language switch ---------- */
document.getElementById('languageSelect').addEventListener('change', (e) => {
  currentLang = e.target.value || 'en';
  if(['ar','fa','ur','he'].includes(currentLang)) { 
    document.documentElement.dir = 'rtl'; 
    document.body.classList.add('rtl'); 
  } else { 
    document.documentElement.dir = 'ltr'; 
    document.body.classList.remove('rtl'); 
  }
  applyTranslations();
  markers.forEach(m => m.bindPopup(createPopup(m.resource)));
});

function applyTranslations(){
  const t = translations[currentLang] || translations.en;
  document.getElementById('mainTitle').textContent = t.title;
  document.getElementById('subtitle').textContent = t.subtitle;
  document.getElementById('searchBar').placeholder = t.searchPlaceholder || '';
  document.getElementById('hotlinesTitle').textContent = t.hotlinesTitle || 'Hotlines & Support';
  document.getElementById('toggleListView').textContent = t.listView || 'List view';
  updateOnlineUI();
}

/* ---------- Status line ---------- */
function updateStatusLine(){
  document.getElementById('statusLine').textContent = `${resources.length} verified locations — call before you go.`;
}

/* ---------- Service Worker registration ---------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(() => console.log('Service worker registered')).catch(err => console.warn('SW failed', err));
}

/* ---------- Init on DOM ready ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  applyTranslations();
  initMap();
  await loadResources();
  updateOnlineUI();
});
</script>
</body>
</html>
