<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Vancouver DTES Lifeline Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Nunito Sans', sans-serif; margin: 0; padding: 0; background:#f6f7fb; }
        #map { height: 70vh; width: 100%; min-height:400px; border-radius: .75rem; background-color: #f3f4f6; }
        .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.15); }
        .popup-btn { padding: .4rem .7rem; border-radius:.5rem; font-weight:600; display:inline-flex; align-items:center; margin-top:10px; margin-right:5px; font-size:.85rem; cursor:pointer; border:none; transition:all .2s ease; }
        .popup-btn:hover{ transform: translateY(-1px); box-shadow:0 2px 8px rgba(0,0,0,.15); }
        .direction-btn{ background-color:#EF4444; color:white; width:100%; margin-top:12px !important; }
        .filter-button{ transition:all .2s ease-in-out; box-shadow:0 1px 3px rgba(0,0,0,.08); border:2px solid transparent; }
        .filter-button.active{ box-shadow:0 0 0 3px rgba(29,78,216,.15); border-color:#1D4ED8; background-color:#1D4ED8 !important; transform:scale(1.03); }
        .filter-button:hover{ transform: translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,.12); }
        .user-location-icon{ background-color:#3B82F6; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow:0 0 10px rgba(0,0,0,.6); animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%{ box-shadow:0 0 0 0 rgba(59,130,246,.7);} 70%{ box-shadow:0 0 0 10px rgba(59,130,246,0);} 100%{ box-shadow:0 0 0 0 rgba(59,130,246,0);} }
        #loadingOverlay{ position:fixed; inset:0; background:rgba(255,255,255,.98); z-index:1010; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:opacity .5s; }
        .spinner{ border:4px solid rgba(0,0,0,.08); width:40px; height:40px; border-radius:50%; border-left-color:#1D4ED8; animation:spin 1s ease infinite; }
        @keyframes spin{ 0%{ transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }
        .status-indicator{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:5px; vertical-align:middle; }
        .status-open{ background-color:#10B981; }
        .status-closed{ background-color:#EF4444; }
        #quickExitBtn{ position:fixed; bottom:20px; right:20px; background-color:#EF4444; color:white; padding:10px 15px; border-radius:6px; cursor:pointer; z-index:1000; display:none; }
        .language-selector{ position:fixed; top:10px; right:10px; z-index:1000; }
        .qr-modal{ display:none; position:fixed; z-index:1050; inset:0; background-color:rgba(0,0,0,.5); align-items:center; justify-content:center; }
        .qr-modal-content{ background:#fff; padding:20px; border-radius:10px; width:90%; max-width:420px; text-align:center; }
        .close-modal{ color:#aaa; font-size:24px; font-weight:bold; cursor:pointer; }
        /* Accessibility widget */
        #a11yWidget{ position:fixed; right:16px; bottom:16px; width:320px; background:#fff; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.12); padding:12px; z-index:2200; transition: transform .18s ease, opacity .18s ease; }
        #a11yWidget.minimized{ width:52px; height:52px; padding:6px; border-radius:50%; overflow:hidden; display:flex; align-items:center; justify-content:center; }
        #a11yWidget button{ cursor:pointer; }
        .cat-list{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        .cat-chk{ display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; background:#f3f4f6; cursor:pointer; user-select:none; }
        .cat-chk input{ margin:0; transform:scale(1.05); }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner mb-4"></div>
    <div class="text-2xl font-bold text-gray-800">DTES Lifeline Map</div>
    <div class="text-sm text-gray-500 mt-2">Loading verified community resources...</div>
</div>

<div class="language-selector">
    <select id="languageSelect" class="bg-white border border-gray-300 rounded px-3 py-1 text-sm shadow-lg">
        <option value="en">English</option>
        <option value="zh">‰∏≠Êñá</option>
        <option value="es">Espa√±ol</option>
        <option value="fr">Fran√ßais</option>
        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
        <option value="tl">Tagalog</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="fa">ŸÅÿßÿ±ÿ≥€å</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
        <option value="ur">ÿßÿ±ÿØŸà</option>
        <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
    </select>
</div>

<div id="qrModal" class="qr-modal">
    <div class="qr-modal-content">
        <span class="close-modal">√ó</span>
        <h2 class="text-lg font-bold mb-4">Location QR Code</h2>
        <p class="mb-4">Scan this code to get directions on your phone</p>
        <div id="qrcode"></div>
        <p id="qrLocationName" class="mt-4 text-sm text-gray-600"></p>
    </div>
</div>

<button id="quickExitBtn" aria-label="Quick Exit">
    <i class="fas fa-times mr-2"></i> Quick Exit
</button>

<div id="mainAppContent" class="container mx-auto p-4 md:p-8 opacity-0 transition-opacity duration-500">

    <header class="bg-white p-6 shadow-xl rounded-xl mb-6">
        <h1 id="mainTitle" class="text-4xl font-extrabold text-gray-900 mb-2">Vancouver DTES Lifeline Map</h1>
        <p id="subtitle" class="text-gray-600 mb-2">Instant access to harm reduction, supervised consumption, food banks, shelters, detox centers, and urgent care services.</p>
        <p class="text-sm text-gray-500 mb-2">
            <span id="userLocationStatus" class="font-semibold text-gray-700">Ready to use</span>
            <span class="mx-2">|</span>
            <span id="resourceCount" class="text-blue-600 font-semibold">0 verified locations</span>
        </p>
        <div id="alertBanner" class="text-xs text-red-600 font-semibold mt-3 bg-red-50 p-3 rounded-lg border border-red-200">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span id="alertText">Important: Service hours may change. Always call ahead.</span>
        </div>
    </header>

    <div class="grid grid-cols-1 gap-4 mb-6">
        <div class="bg-white p-5 shadow-lg rounded-xl border border-gray-200">
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="flex-grow">
                    <label for="searchBar" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-search mr-1"></i> <span id="searchLabel">Search Resources:</span>
                    </label>
                    <input id="searchBar" type="text" placeholder="Search by name, type, or service" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
            </div>

            <div class="mb-2">
                <span class="text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-filter mr-1"></i> <span id="filterLabel">Filter by Category:</span>
                </span>
            </div>

            <div id="filterButtons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-3">
                <button data-filter="all" class="filter-button bg-gray-600 hover:bg-gray-700 text-white py-2.5 px-3 rounded-lg active">
                    <i class="fas fa-globe mr-1"></i> All (<span id="allCount">0</span>)
                </button>
                <button data-filter="Naloxone" class="filter-button bg-blue-500 hover:bg-blue-600 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-kit-medical mr-1"></i> Naloxone
                </button>
                <button data-filter="Injection Site" class="filter-button bg-green-500 hover:bg-green-600 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-syringe mr-1"></i> Sites
                </button>
                <button data-filter="Detox" class="filter-button bg-orange-500 hover:bg-orange-600 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-house-medical-flag mr-1"></i> Detox
                </button>
                <button data-filter="Food" class="filter-button bg-purple-600 hover:bg-purple-700 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-utensils mr-1"></i> Food
                </button>
                <button data-filter="Shelter" class="filter-button bg-yellow-700 hover:bg-yellow-800 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-bed mr-1"></i> Shelter
                </button>
                <button data-filter="Urgent" class="filter-button bg-red-600 hover:bg-red-700 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-hospital mr-1"></i> Urgent
                </button>
                <button data-filter="Washrooms" class="filter-button bg-teal-600 hover:bg-teal-700 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-restroom mr-1"></i> Washrooms
                </button>
                <button data-filter="Mental Health" class="filter-button bg-pink-600 hover:bg-pink-700 text-white py-2.5 px-3 rounded-lg">
                    <i class="fas fa-brain mr-1"></i> Mental
                </button>
            </div>

            <div>
                <div class="text-sm font-medium text-gray-700">Select categories (multi-select):</div>
                <div id="categoryCheckboxes" class="cat-list" aria-live="polite"></div>
            </div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <button id="locateUserButton" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg">
                <i class="fas fa-crosshairs mr-2"></i> <span id="locateBtnLabel">Find My Location</span>
            </button>
            <button id="instructionsButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg">
                <i class="fas fa-hand-holding-medical mr-2"></i> <span id="naloxoneBtnLabel">Naloxone Guide</span>
            </button>
            <button id="reportStatusButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg shadow-lg">
                <i class="fas fa-bullhorn mr-2"></i> <span id="reportBtnLabel">Report Issue</span>
            </button>
            <button id="emergencyButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg">
                <i class="fas fa-phone-alt mr-2"></i> <span id="emergencyBtnLabel">Emergency 911</span>
            </button>
        </div>
    </div>

    <div id="emergencyMessage" class="hidden bg-red-200 border-2 border-red-500 text-red-800 px-4 py-3 rounded-lg mb-4 font-bold">
        <i class="fas fa-exclamation-circle mr-2"></i> EMERGENCY: Please call 911 immediately.
    </div>

    <div id="map" class="shadow-2xl border-4 border-white"></div>

    <footer class="mt-6 bg-gray-800 text-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">
            <i class="fas fa-phone-volume mr-2"></i> 24/7 Crisis Support Hotlines
        </h2>
        <div id="hotlinesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5 text-sm">
            <!-- hotlines will be generated from JSON - fallback content added client-side -->
        </div>

        <div class="text-center text-xs text-gray-400 mt-6 pt-4 border-t border-gray-700">
            <p>Made with ‚ù§Ô∏è for the DTES community ‚Äî call first to confirm hours and availability.</p>
        </div>
    </footer>
</div>

<!-- Accessibility widget (minimizable) -->
<div id="a11yWidget" role="region" aria-label="Accessibility">
    <div id="a11yContent">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>Accessibility</strong>
            <div style="display:flex; gap:6px; align-items:center;">
                <button id="minimizeA11y" class="text-sm text-gray-600" title="Minimize accessibility">‚Äì</button>
            </div>
        </div>

        <div style="margin-top:8px; display:flex; gap:6px;">
            <button id="increaseFont" class="bg-gray-100 px-3 py-1 rounded text-sm">A+</button>
            <button id="decreaseFont" class="bg-gray-100 px-3 py-1 rounded text-sm">A-</button>
            <button id="toggleContrast" class="bg-gray-100 px-3 py-1 rounded text-sm">High contrast</button>
        </div>

        <div style="margin-top:8px;">
            <small class="text-gray-500">Plain language & screen reader tips available</small>
        </div>
    </div>
    <div id="a11yMinimized" style="display:none; text-align:center;">
        <button id="restoreA11y" title="Open accessibility" style="background:none; border:none; font-size:20px;"><i class="fas fa-universal-access"></i></button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
/* ===========================
   This file uses external JSON: dtes-resources.json
   Place that JSON in the same folder as this HTML.
   =========================== */

let dtesResources = [];          // populated by fetch
let map = null;
let markers = [];
let userLat = null, userLng = null;
let userLocationMarker = null;
let routingControl = null;
let currentLanguage = 'en';

/* UI text translations (keeps previous labels) */
const uiText = {
    en: { title: "Vancouver DTES Lifeline Map", subtitle: "Instant access to harm reduction, supervised consumption, food banks, shelters, detox centers, and urgent care services.", searchPlaceholder: "Search by name, type, or service", locate: "Find My Location", naloxone: "Naloxone Guide", report: "Report Issue", emergency: "Emergency 911", filterLabel: "Filter by Category:", searchLabel: "Search Resources:", alert: "Important: Service hours may change. Always call ahead.", resourceCountSuffix: "verified locations", locating: "Locating...", locationFound: "Location found!", enableLocationFirst: "Enable your location first", directionsTo: "Directions to", followRedLine: "Follow the red line on map"},
    zh: { title:"Ê∏©Âì•Âçé DTES ËµÑÊ∫êÂú∞Âõæ", subtitle:"Âç≥Êó∂ËÆøÈóÆÂáèÂÆ≥„ÄÅÊ≥®Â∞ÑÁ´ô„ÄÅÈ£üÁâ©Èì∂Ë°å„ÄÅÊî∂ÂÆπÊâÄ„ÄÅÊàíÊØí‰∏≠ÂøÉÂíåÊÄ•ËØäÊúçÂä°„ÄÇ", searchPlaceholder:"ÊåâÂêçÁß∞„ÄÅÁ±ªÂûãÊàñÊúçÂä°ÊêúÁ¥¢", locate:"Êü•ÊâæÊàëÁöÑ‰ΩçÁΩÆ", naloxone:"Á∫≥Ê¥õÈÖÆ ÊåáÂØº", report:"Êä•ÂëäÈóÆÈ¢ò", emergency:"Á¥ßÊÄ• 911", filterLabel:"ÊåâÁ±ªÂà´Á≠õÈÄâ:", searchLabel:"ÊêúÁ¥¢ËµÑÊ∫ê:", alert:"ÈáçË¶ÅÔºöÊúçÂä°Êó∂Èó¥ÂèØËÉΩ‰ºöÊõ¥Êîπ„ÄÇËØ∑ÂÖàËá¥ÁîµÁ°ÆËÆ§„ÄÇ", resourceCountSuffix:"Â∑≤È™åËØÅÂú∞ÁÇπ", locating:"Ê≠£Âú®ÂÆö‰Ωç...", locationFound:"ÊâæÂà∞‰ΩçÁΩÆ!", enableLocationFirst:"ËØ∑ÂÖàÂêØÁî®‰ΩçÁΩÆ", directionsTo:"ÂâçÂæÄ", followRedLine:"ÊåâÁÖßÂú∞Âõæ‰∏äÁöÑÁ∫¢Á∫ø"},
    es: { title:"Mapa de Recursos DTES Vancouver", subtitle:"Acceso instant√°neo a reducci√≥n de da√±os, sitios de consumo supervisado, bancos de alimentos, refugios, centros de desintoxicaci√≥n y atenci√≥n urgente.", searchPlaceholder:"Buscar por nombre, tipo o servicio", locate:"Mi ubicaci√≥n", naloxone:"Gu√≠a Naloxona", report:"Reportar problema", emergency:"Emergencia 911", filterLabel:"Filtrar por categor√≠a:", searchLabel:"Buscar recursos:", alert:"Importante: Los horarios pueden cambiar. Llame antes.", resourceCountSuffix:"ubicaciones verificadas", locating:"Localizando...", locationFound:"¬°Ubicaci√≥n encontrada!", enableLocationFirst:"Active su ubicaci√≥n primero", directionsTo:"Direcciones a", followRedLine:"Siga la l√≠nea roja"}
};

/* small popup label translations */
const popText = {
    en: { type: "Type", hours: "Hours", call: "Call", getDirections: "Get Directions", openInMaps: "Open in Maps", showQRCode: "Show QR" },
    zh: { type: "Á±ªÂûã", hours: "Êó∂Èó¥", call: "Ëá¥Áîµ", getDirections: "Ëé∑ÂèñË∑ØÁ∫ø", openInMaps: "Âú®Âú∞Âõæ‰∏≠ÊâìÂºÄ", showQRCode: "ÊòæÁ§∫‰∫åÁª¥Á†Å" },
    es: { type: "Tipo", hours: "Horario", call: "Llamar", getDirections: "Direcciones", openInMaps: "Abrir en Mapas", showQRCode: "C√≥digo QR" }
};

/* SAFE helper */
function safe(s){ return s === null || s === undefined ? '' : String(s); }

/* -------------------------
   Fetch external JSON and initialize
   ------------------------- */
async function loadResourcesJSON(url='dtes-resources.json'){
    try{
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok) throw new Error('Failed to fetch ' + url + ' (' + res.status + ')');
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error('JSON must be an array');
        dtesResources = data;
        // set hotlines area in footer
        renderHotlines();
        // update counts in UI and build checkboxes
        document.getElementById('allCount').textContent = dtesResources.length;
        buildCategoryCheckboxes();
        // init map when Leaflet ready
        waitForLeafletAndInit();
    } catch(err){
        console.error('loadResourcesJSON error', err);
        alert('Failed to load dtes-resources.json: ' + err.message);
        // still hide the loading overlay so user can see the page
        hideLoadingOverlay();
    }
}

/* wait for L then call initMap (avoid race) */
function waitForLeafletAndInit(){
    const tries = 0;
    (function poll(){
        if(typeof L !== 'undefined' && document.getElementById('map')){
            initMap();
        } else {
            setTimeout(poll, 100);
        }
    })();
}

/* -------------------------
   Map init + mounting markers
   ------------------------- */
function initMap(){
    // if already initialized, clear markers and re-add
    if(!map){
        map = L.map('map').setView([49.2819, -123.1000], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap', maxZoom:19 }).addTo(map);
    } else {
        // clear existing marker layers
        markers.forEach(m => map.removeLayer(m));
        markers = [];
    }

    // add markers from dtesResources (only if lat/lng provided)
    dtesResources.forEach(r => {
        if(typeof r.lat === 'number' && typeof r.lng === 'number'){
            addMarker(r);
        }
    });

    // update UI
    updateResourceCount();
    hideLoadingOverlay();
    applyUiTranslations(); // update UI language strings
}

/* add single marker */
function addMarker(r){
    const colors = {'Naloxone':'#3B82F6','Injection Site':'#10B981','Detox':'#F97316','Food':'#9333EA','Shelter':'#b45309','Urgent':'#EF4444','Washrooms':'#14B8A6','Mental Health':'#EC4899','Hotline':'#6B7280'};
    const color = colors[r.type] || '#6B7280';
    const icon = L.divIcon({ className: 'custom-marker', html:`<div style="background-color:${color}; width:28px; height:28px; border-radius:50%; border:3px solid white; box-shadow:0 2px 8px rgba(0,0,0,.3)"></div>`, iconSize:[28,28], iconAnchor:[14,14] });
    const marker = L.marker([r.lat, r.lng], { icon: icon }).addTo(map);
    marker.resourceData = r;
    marker.bindPopup(createPopupHtml(r), { maxWidth: 340 });
    markers.push(marker);
}

/* create popup html using translations */
function createPopupHtml(r){
    const t = popText[currentLanguage] || popText.en;
    const safeName = safe(r.name).replace(/"/g,'&quot;').replace(/'/g,"&#39;");
    const phoneHtml = r.phone ? `<a href="tel:${safe(r.phone)}" style="color:#2563EB">${safe(r.phone)}</a>` : 'N/A';
    return `
        <div style="max-width:320px; font-family:'Nunito Sans',sans-serif;">
            <h3 style="font-weight:bold; margin-bottom:8px; font-size:16px;">${safeName}</h3>
            <p style="margin-bottom:8px; font-size:13px;"><strong>${t.type}:</strong> ${safe(r.type)}</p>
            <p style="margin-bottom:8px; font-size:13px;">${safe(r.description || '')}</p>
            <p style="margin-bottom:8px; font-size:13px;"><strong>${t.hours}:</strong> ${safe(r.hours || 'N/A')}</p>
            <p style="margin-bottom:12px; font-size:13px;"><strong>${t.call}:</strong> ${phoneHtml}</p>
            <p style="margin-bottom:12px; font-size:12px; color:#6B7280;"><i class="fas fa-map-marker-alt"></i> ${safe(r.address || '')}</p>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
                <button onclick="getDirections(${r.lat},${r.lng},'${safeName}');" class="popup-btn direction-btn"><i class="fas fa-directions mr-1"></i> ${t.getDirections}</button>
                <button onclick="openInExternalMap(${r.lat},${r.lng},'${safeName}');" class="popup-btn" style="background-color:#3B82F6; color:white;"><i class="fas fa-external-link-alt mr-1"></i> ${t.openInMaps}</button>
                <button onclick="showQRCode(${r.lat},${r.lng},'${safeName}');" class="popup-btn" style="background-color:#10B981; color:white;"><i class="fas fa-qrcode mr-1"></i> ${t.showQRCode}</button>
            </div>
        </div>
    `;
}

/* -------------------------
   Search / filtering / categories
   ------------------------- */
function buildCategoryCheckboxes(){
    const container = document.getElementById('categoryCheckboxes');
    container.innerHTML = '';
    const types = Array.from(new Set(dtesResources.map(r => r.type))).sort();
    types.forEach(type => {
        const id = 'cat_' + type.replace(/\W+/g,'_');
        const wrapper = document.createElement('label');
        wrapper.className = 'cat-chk';
        wrapper.innerHTML = `<input type="checkbox" id="${id}" name="category" value="${type}" /><span style="font-size:13px;">${type}</span>`;
        container.appendChild(wrapper);
        wrapper.querySelector('input').addEventListener('change', applyCategoryFilters);
    });
}

function applyCategoryFilters(){
    const checked = Array.from(document.querySelectorAll('#categoryCheckboxes input:checked')).map(i => i.value);
    if(checked.length === 0){
        // fallback to single filter button
        const activeBtn = document.querySelector('.filter-button.active');
        const filter = activeBtn ? activeBtn.dataset.filter : 'all';
        markers.forEach(m => {
            if(filter === 'all' || m.resourceData.type === filter) m.addTo(map); else map.removeLayer(m);
        });
    } else {
        markers.forEach(m => {
            if(checked.includes(m.resourceData.type)) m.addTo(map); else map.removeLayer(m);
        });
    }
    updateResourceCount();
}

document.getElementById('searchBar').addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase().trim();
    markers.forEach(m => {
        const r = m.resourceData;
        const hay = `${r.name} ${r.description} ${r.type} ${r.address} ${r.phone}`.toLowerCase();
        const match = q === '' || hay.includes(q);
        if(match) m.addTo(map); else map.removeLayer(m);
    });
    updateResourceCount();
});

/* single filter buttons */
document.querySelectorAll('.filter-button').forEach(btn => {
    btn.addEventListener('click', () => {
        // if any category checkbox selected, ignore overriding filter
        const anyChecked = document.querySelectorAll('#categoryCheckboxes input:checked').length > 0;
        document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(anyChecked) return;
        const filter = btn.dataset.filter;
        markers.forEach(m => {
            if(filter === 'all' || m.resourceData.type === filter) m.addTo(map); else map.removeLayer(m);
        });
        updateResourceCount();
    });
});

/* resource count update */
function updateResourceCount(){
    const count = markers.filter(m => map.hasLayer(m)).length;
    document.getElementById('resourceCount').textContent = `${count} ${uiText[currentLanguage]?.resourceCountSuffix || 'verified locations'}`;
    document.getElementById('allCount').textContent = dtesResources.length;
}

/* -------------------------
   Directions / external maps / QR
   ------------------------- */
function getDirections(lat,lng,name){
    if(!userLat || !userLng){ alert(uiText[currentLanguage]?.enableLocationFirst || 'Enable your location first'); return; }
    if(routingControl) map.removeControl(routingControl);
    routingControl = L.Routing.control({
        waypoints: [ L.latLng(userLat,userLng), L.latLng(lat,lng) ],
        lineOptions: { styles: [{ color:'#EF4444', weight:5, opacity:0.8 }] },
        createMarker: ()=>null
    }).addTo(map);
    alert(`${uiText[currentLanguage]?.directionsTo || 'Directions to'} ${name}\n\n${uiText[currentLanguage]?.followRedLine || 'Follow the red line on map'}`);
}

function openInExternalMap(lat,lng,name){
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    let url;
    if(isMobile){
        if(/iPhone|iPad|iPod/.test(navigator.userAgent)) url = `maps://maps.google.com/maps?daddr=${lat},${lng}`;
        else if(/Android/.test(navigator.userAgent)) url = `geo:${lat},${lng}?q=${lat},${lng}(${encodeURIComponent(name)})`;
        else url = `https://maps.google.com/maps?daddr=${lat},${lng}`;
    } else {
        url = `https://maps.google.com/maps?daddr=${lat},${lng}`;
    }
    window.open(url,'_blank');
}

function showQRCode(lat,lng,name){
    const url = `https://maps.google.com/maps?q=${lat},${lng}(${encodeURIComponent(name)})`;
    const modal = document.getElementById('qrModal');
    const qrcodeDiv = document.getElementById('qrcode');
    qrcodeDiv.innerHTML = '';
    new QRCode(qrcodeDiv, { text: url, width:200, height:200 });
    document.getElementById('qrLocationName').textContent = name;
    modal.style.display = 'flex';
}

/* QR modal close */
document.querySelector('.close-modal').addEventListener('click', ()=> document.getElementById('qrModal').style.display='none');
window.addEventListener('click', (e) => { if(e.target === document.getElementById('qrModal')) document.getElementById('qrModal').style.display='none'; });

/* -------------------------
   Geolocation
   ------------------------- */
document.getElementById('locateUserButton').addEventListener('click', () => {
    if(!navigator.geolocation) { alert('Geolocation not supported'); return; }
    document.getElementById('userLocationStatus').textContent = uiText[currentLanguage]?.locating || 'Locating...';
    navigator.geolocation.getCurrentPosition((pos) => {
        userLat = pos.coords.latitude; userLng = pos.coords.longitude;
        if(userLocationMarker) map.removeLayer(userLocationMarker);
        const icon = L.divIcon({ className: 'user-location-icon', iconSize:[20,20], iconAnchor:[10,10] });
        userLocationMarker = L.marker([userLat,userLng], { icon: icon }).addTo(map).bindPopup('<strong>You are here</strong>');
        map.setView([userLat,userLng], 15);
        document.getElementById('userLocationStatus').textContent = uiText[currentLanguage]?.locationFound || 'Location found!';
        userLocationMarker.openPopup();
    }, (err) => {
        console.error('Geolocation error', err);
        alert('Unable to get location. Please enable location services.');
        document.getElementById('userLocationStatus').textContent = 'Location error';
    });
});

/* -------------------------
   UI Buttons: emergency/instructions/report
   ------------------------- */
document.getElementById('emergencyButton').addEventListener('click', () => {
    const msg = document.getElementById('emergencyMessage');
    msg.classList.remove('hidden');
    setTimeout(()=> msg.classList.add('hidden'), 5000);
});

document.getElementById('instructionsButton').addEventListener('click', () => {
    alert(`üÜò NALOXONE INSTRUCTIONS\n\n1) Recognize overdose (no/slow breathing, blue lips, unconscious)\n2) Call 911\n3) Give naloxone (nasal or injectable)\n4) Provide rescue breaths\n5) Stay with person & call for help\n\nFree naloxone kits available at many pins.`);
});

document.getElementById('reportStatusButton').addEventListener('click', () => {
    alert(`üì¢ REPORT SERVICE CHANGES\n\nPlease email info@dteslifeline.org or open a GitHub issue to suggest updates (closures, hours changes, new resources). Thank you.`);
});

/* -------------------------
   Accessibility widget
   ------------------------- */
const a11y = {
    el: document.getElementById('a11yWidget'),
    content: document.getElementById('a11yContent'),
    minimizedDiv: document.getElementById('a11yMinimized'),
    minimizeBtn: document.getElementById('minimizeA11y'),
    restoreBtn: document.getElementById('restoreA11y'),
    increase: document.getElementById('increaseFont'),
    decrease: document.getElementById('decreaseFont'),
    contrastBtn: document.getElementById('toggleContrast')
};

function setA11yMinimized(state){
    if(state){
        a11y.el.classList.add('minimized');
        a11y.content.style.display = 'none';
        if(a11y.minimizedDiv) a11y.minimizedDiv.style.display = 'block';
        sessionStorage.setItem('a11yMin', '1');
    } else {
        a11y.el.classList.remove('minimized');
        a11y.content.style.display = 'block';
        if(a11y.minimizedDiv) a11y.minimizedDiv.style.display = 'none';
        sessionStorage.removeItem('a11yMin');
    }
}

if(a11y.minimizeBtn) a11y.minimizeBtn.addEventListener('click', ()=> setA11yMinimized(true));
if(a11y.restoreBtn) a11y.restoreBtn.addEventListener('click', ()=> setA11yMinimized(false));
if(a11y.increase) a11y.increase.addEventListener('click', ()=> {
    const root = document.documentElement;
    const size = parseFloat(getComputedStyle(root).fontSize) || 16;
    const next = Math.min(28, size + 2);
    root.style.fontSize = next + 'px';
});
if(a11y.decrease) a11y.decrease.addEventListener('click', ()=> {
    const root = document.documentElement;
    const size = parseFloat(getComputedStyle(root).fontSize) || 16;
    const next = Math.max(12, size - 2);
    root.style.fontSize = next + 'px';
});
if(a11y.contrastBtn) a11y.contrastBtn.addEventListener('click', ()=> {
    document.body.classList.toggle('high-contrast');
    const on = document.body.classList.contains('high-contrast');
    a11y.contrastBtn.textContent = on ? 'Contrast: On' : 'High contrast';
});

if(sessionStorage.getItem('a11yMin')) setA11yMinimized(true);

/* -------------------------
   Hotlines rendering in footer
   (hotlines should be included in dtes-resources.json with type "Hotline" or we show fallback ones)
   ------------------------- */
function renderHotlines(){
    const grid = document.getElementById('hotlinesGrid');
    grid.innerHTML = '';
    const hotlines = dtesResources.filter(r => r.type && r.type.toLowerCase().includes('hotline'));
    if(hotlines.length === 0){
        // fallback hardcoded hotlines if JSON doesn't include them
        const fallback = [
            { name: "BC Mental Health", phone: "310-6789", description: "Provincial mental health support (BC)" },
            { name: "Suicide Crisis (9-8-8)", phone: "988", description: "24/7 suicide & crisis support ‚Äî call or text (Canada)" },
            { name: "Hope for Wellness", phone: "1-855-242-3310", description: "24/7 culturally-safe support for Indigenous peoples" },
            { name: "Kids Help Phone", phone: "1-800-668-6868", description: "24/7 support for young people (call/text/chat)" },
            { name: "BC211", phone: "211", description: "Information & referrals across BC ‚Äî interpretation available" },
            { name: "Crisis Services Canada", phone: "1-833-456-4566", description: "National crisis line ‚Äî call or text 45645" },
            { name: "Poison Control (Canada)", phone: "1-844-764-7669", description: "National poison centre (1-844-POISON-X)" },
            { name: "Vancouver Non-Emergency", phone: "604-717-3321", description: "Vancouver Police non-emergency reporting" }
        ];
        fallback.forEach(h => {
            const el = document.createElement('div');
            el.innerHTML = `<div class="font-semibold text-teal-400 mb-2"><i class="fas fa-headset mr-2"></i> ${safe(h.name)}</div>
                            <a href="tel:${safe(h.phone)}" class="hover:text-teal-300 block text-lg font-bold">${safe(h.phone)}</a>
                            <div class="text-xs text-gray-400 mt-1">${safe(h.description)}</div>`;
            grid.appendChild(el);
        });
        return;
    }
    hotlines.forEach(h => {
        const el = document.createElement('div');
        el.innerHTML = `<div class="font-semibold text-teal-400 mb-2"><i class="fas fa-headset mr-2"></i> ${safe(h.name)}</div>
                        <a href="tel:${safe(h.phone)}" class="hover:text-teal-300 block text-lg font-bold">${safe(h.phone)}</a>
                        <div class="text-xs text-gray-400 mt-1">${safe(h.description || '')}</div>`;
        grid.appendChild(el);
    });
}

/* -------------------------
   Loading overlay helpers
   ------------------------- */
function hideLoadingOverlay(){
    const overlay = document.getElementById('loadingOverlay');
    if(overlay){
        overlay.style.opacity = '0';
        setTimeout(()=> overlay.style.display = 'none', 400);
        document.getElementById('mainAppContent').style.opacity = '1';
    }
}

/* -------------------------
   Utility: hide/show quick exit
   ------------------------- */
window.addEventListener('scroll', ()=> { document.getElementById('quickExitBtn').style.display = window.scrollY > 200 ? 'block' : 'none'; });
document.getElementById('quickExitBtn').addEventListener('click', ()=> window.location.href = 'https://www.google.com');

/* -------------------------
   Initialize: load JSON on DOM ready
   ------------------------- */
document.addEventListener('DOMContentLoaded', () => {
    // set default language from browser if available
    const browser = (navigator.language || 'en').split('-')[0];
    if(uiText[browser]) { currentLanguage = browser; document.getElementById('languageSelect').value = browser; }
    document.getElementById('languageSelect').addEventListener('change', (e)=> {
        currentLanguage = e.target.value;
        applyUiTranslations();
        // update popups
        markers.forEach(m => {
            m.bindPopup(createPopupHtml(m.resourceData), { maxWidth: 340 });
        });
    });
    loadResourcesJSON('dtes-resources.json');
});

/* Apply UI translations for top-level labels */
function applyUiTranslations(){
    const t = uiText[currentLanguage] || uiText.en;
    document.getElementById('mainTitle').textContent = t.title;
    document.getElementById('subtitle').textContent = t.subtitle;
    document.getElementById('searchBar').setAttribute('placeholder', t.searchPlaceholder);
    document.getElementById('locateBtnLabel').textContent = t.locate;
    document.getElementById('naloxoneBtnLabel').textContent = t.naloxone;
    document.getElementById('reportBtnLabel').textContent = t.report;
    document.getElementById('emergencyBtnLabel').textContent = t.emergency;
    document.getElementById('filterLabel').textContent = t.filterLabel;
    document.getElementById('searchLabel').textContent = t.searchLabel;
    document.getElementById('alertText').textContent = t.alert;
    updateResourceCount();
}
</script>
</body>
</html>
