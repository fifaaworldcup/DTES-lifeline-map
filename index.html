<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1D4ED8">
    <meta name="description" content="DTES Lifeline Map - Offline capable resource locator for Vancouver.">
    <title>Vancouver DTES Lifeline Map - Real-Time Resource Locator</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%231D4ED8'/><text x='50%' y='50%' text-anchor='middle' dy='.3em' fill='white' font-size='48' font-family='Arial'>DTES</text></svg>">
    <link rel="manifest" href="data:application/json,{%22name%22:%22DTES%20Lifeline%20Map%22,%22short_name%22:%22DTES%20Map%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%231D4ED8%22,%22description%22:%22Offline-capable%20resource%20map%20for%20Vancouver's%20DTES.%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%231D4ED8'/><text x='50%' y='50%' text-anchor='middle' dy='.3em' fill='white' font-size='48' font-family='Arial'>DTES</text></svg>%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22},{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%231D4ED8'/><text x='50%' y='50%' text-anchor='middle' dy='.3em' fill='white' font-size='128' font-family='Arial'>DTES</text></svg>%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
    
    <!-- Inline critical CSS to avoid loading issues -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz,wght@6..12,400;6..12,600;6..12,700;6..12,800&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f9fafb;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        #map { 
            height: 70vh; 
            width: 100%; 
            min-height: 400px; 
            border-radius: 0.75rem; 
            transition: opacity 0.5s; 
            background-color: #e5e7eb;
            border: 2px solid #d1d5db;
        }
        
        .fallback-map {
            display: none;
            padding: 2rem;
            background: white;
            border-radius: 0.75rem;
            border: 2px solid #d1d5db;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .resource-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .resource-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .resource-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .type-naloxone { background-color: #3b82f6; }
        .type-injection { background-color: #10b981; }
        .type-detox { background-color: #f97316; }
        .type-food { background-color: #9333ea; }
        .type-shelter { background-color: #b45309; }
        .type-urgent { background-color: #ef4444; }
        .type-washrooms { background-color: #14b8a6; }
        .type-mental { background-color: #ec4899; }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .btn-primary { background-color: #1d4ed8; color: white; }
        .btn-primary:hover { background-color: #1e40af; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        
        .filter-button { 
            transition: all 0.2s ease-in-out; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
            border: 2px solid transparent; 
        }
        
        .filter-button.active { 
            box-shadow: 0 0 0 3px #1D4ED8, 0 2px 4px rgba(0, 0, 0, 0.1); 
            border-color: #1D4ED8; 
            background-color: #1D4ED8 !important; 
            transform: scale(1.05); 
        }
        
        .filter-button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
        }
        
        #loadingOverlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(255, 255, 255, 0.98); 
            z-index: 1010; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 0.5s; 
        }
        
        .spinner { 
            border: 4px solid rgba(0, 0, 0, 0.1); 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border-left-color: #1D4ED8; 
            animation: spin 1s ease infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .filters-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #1d4ed8;
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.1);
        }
        
        .grid {
            display: grid;
            gap: 1rem;
        }
        
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-cols-5 { grid-template-columns: repeat(5, 1fr); }
        
        @media (max-width: 768px) {
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4,
            .grid-cols-5 {
                grid-template-columns: 1fr;
            }
        }
        
        .text-center { text-align: center; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .rounded { border-radius: 0.375rem; }
        .shadow-lg { box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); }
        
        .hidden { display: none; }
        .opacity-0 { opacity: 0; }
        .transition-opacity { transition: opacity 0.5s; }
        
        .status-indicator { 
            display: inline-block; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            margin-right: 5px; 
        }
        
        .status-open { background-color: #10B981; }
        .status-closed { background-color: #EF4444; }
        .status-unknown { background-color: #F59E0B; }
        
        /* Font Awesome fallback icons */
        .icon::before {
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
        }
        
        .icon-search::before { content: "üîç"; }
        .icon-clock::before { content: "üïê"; }
        .icon-filter::before { content: "üéØ"; }
        .icon-location::before { content: "üìç"; }
        .icon-medical::before { content: "üè•"; }
        .icon-report::before { content: "üì¢"; }
        .icon-emergency::before { content: "üö®"; }
        .icon-phone::before { content: "üìû"; }
        .icon-directions::before { content: "üß≠"; }
        .icon-external::before { content: "üîó"; }
        .icon-qr::before { content: "üì±"; }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" role="status" aria-live="polite">
    <div class="spinner mb-4"></div>
    <div class="text-2xl font-bold text-gray-800">DTES Lifeline Map</div>
    <div class="text-sm text-gray-500 mt-2">Loading 60+ community resources...</div>
</div>

<!-- Main App Content -->
<div id="mainAppContent" class="container opacity-0 transition-opacity">
    
    <!-- Header -->
    <header class="header">
        <h1 class="text-4xl font-bold mb-2">Vancouver DTES Lifeline Map</h1>
        <p class="text-gray-600 mb-2">Instant access to harm reduction, supervised consumption, food banks, shelters, detox centers, and urgent care services in Vancouver's Downtown Eastside.</p>
        <p class="text-sm text-gray-500 mb-2">
            <span id="userLocationStatus" class="font-semibold text-gray-700">Ready to use</span>
            <span class="mx-2">|</span>
            <span id="resourceCount" class="text-blue-600 font-semibold">60 verified locations</span>
            <span class="mx-2">|</span>
            <span>Data from VCH, BC211, Community Partners</span>
        </p>
        <div class="text-xs text-red-600 font-semibold mt-3 bg-red-50 p-3 rounded-lg border border-red-200" role="alert">
            ‚ö†Ô∏è Important Notice: Service hours shown are typical schedules. Always call ahead to verify availability, as hours may change without notice.
        </div>
    </header>

    <!-- Search and Filters -->
    <div class="filters-section">
        <div class="mb-4">
            <label for="searchBar" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="icon icon-search"></span> Search Resources:
            </label>
            <input id="searchBar" type="text" placeholder="Search by name, type, or service (e.g., Insite, naloxone, food)" class="search-box" aria-label="Search resources">
        </div>
        
        <div class="mb-4">
            <span class="text-sm font-semibold text-gray-700 mb-3">
                <span class="icon icon-filter"></span> Filter by Category:
            </span>
        </div>
        
        <div id="filterButtons" class="grid grid-cols-3 md:grid-cols-5 gap-3 mb-4">
            <button data-filter="all" class="filter-button btn btn-secondary active" aria-pressed="true">
                <span class="icon icon-filter"></span> All (60)
            </button>
            <button data-filter="Naloxone" class="filter-button btn btn-primary" aria-pressed="false">
                <span class="icon icon-medical"></span> Naloxone
            </button>
            <button data-filter="Injection Site" class="filter-button btn btn-primary" aria-pressed="false">
                üíâ Sites
            </button>
            <button data-filter="Detox" class="filter-button btn btn-primary" aria-pressed="false">
                üè• Detox
            </button>
            <button data-filter="Food" class="filter-button btn btn-primary" aria-pressed="false">
                üçΩÔ∏è Food
            </button>
            <button data-filter="Shelter" class="filter-button btn btn-primary" aria-pressed="false">
                üõèÔ∏è Shelter
            </button>
            <button data-filter="Urgent" class="filter-button btn btn-danger" aria-pressed="false">
                üö® Urgent
            </button>
            <button data-filter="Washrooms" class="filter-button btn btn-primary" aria-pressed="false">
                üöª Washrooms
            </button>
            <button data-filter="Mental Health" class="filter-button btn btn-primary" aria-pressed="false">
                üß† Mental
            </button>
        </div>
        
        <!-- Action Buttons -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button id="locateUserButton" class="btn btn-primary">
                <span class="icon icon-location"></span> Find My Location
            </button>
            <button id="instructionsButton" class="btn btn-primary">
                <span class="icon icon-medical"></span> Naloxone Guide
            </button>
            <button id="reportStatusButton" class="btn btn-secondary">
                <span class="icon icon-report"></span> Report Issue
            </button>
            <button id="emergencyButton" class="btn btn-danger">
                <span class="icon icon-emergency"></span> Emergency 911
            </button>
        </div>
    </div>

    <!-- Map Container -->
    <div id="mapContainer">
        <div id="map" role="application" aria-label="Interactive map showing resource locations"></div>
        <div id="fallbackMap" class="fallback-map">
            <h2 class="text-2xl font-bold mb-4">üìç DTES Community Resources</h2>
            <p class="mb-4">Map temporarily unavailable. Here's a list of all resources:</p>
            <div id="resourceList"></div>
        </div>
    </div>

    <!-- Emergency Message -->
    <div id="emergencyMessage" class="hidden bg-red-200 border-2 border-red-500 text-red-800 px-4 py-3 rounded-lg mb-4 font-bold" role="alert">
        <span class="block sm:inline">
            üö® EMERGENCY: Please call 911 immediately for medical emergencies. (This button demonstrates the emergency feature)
        </span>
    </div>

    <!-- Footer -->
    <footer class="mt-6 bg-gray-800 text-white p-6 rounded-lg">
        <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">
            üìû 24/7 Crisis Support Hotlines (Free & Anonymous)
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
            <div>
                <div class="font-semibold text-teal-400 mb-2">üéß BC Crisis Line</div>
                <a href="tel:310-6789" class="hover:text-teal-300 transition block text-lg font-bold">310-6789</a>
                <div class="text-xs text-gray-400">No area code needed ‚Ä¢ 24/7</div>
            </div>
            
            <div>
                <div class="font-semibold text-red-400 mb-2">üíì Suicide Crisis</div>
                <a href="tel:988" class="hover:text-red-300 transition block text-lg font-bold">988</a>
                <div class="text-xs text-gray-400">24/7 call or text</div>
            </div>
            
            <div>
                <div class="font-semibold text-yellow-400 mb-2">üçÉ KUU-US Indigenous</div>
                <a href="tel:1-800-588-8717" class="hover:text-yellow-300 transition block text-lg font-bold">1-800-588-8717</a>
                <div class="text-xs text-gray-400">Indigenous crisis support</div>
            </div>
            
            <div>
                <div class="font-semibold text-blue-400 mb-2">üë∂ Kids Help Phone</div>
                <a href="tel:1-800-668-6868" class="hover:text-blue-300 transition block text-lg font-bold">1-800-668-6868</a>
                <div class="text-xs text-gray-400">Youth support 24/7</div>
            </div>
            
            <div>
                <div class="font-semibold text-orange-400 mb-2">üíä ADIRS</div>
                <a href="tel:1-800-663-1441" class="hover:text-orange-300 transition block text-lg font-bold">1-800-663-1441</a>
                <div class="text-xs text-gray-400">Alcohol & Drug info</div>
            </div>
            
            <div>
                <div class="font-semibold text-green-400 mb-2">üß™ Poison Control</div>
                <a href="tel:1-800-567-8911" class="hover:text-green-300 transition block text-lg font-bold">1-800-567-8911</a>
                <div class="text-xs text-gray-400">24/7 poison emergencies</div>
            </div>
        </div>
        
        <div class="text-center text-xs text-gray-400 mt-6 pt-4 border-t border-gray-700">
            <p class="mb-2">
                üíª Open source community project ‚Ä¢ Data verified from Vancouver Coastal Health, BC211, and community partners
            </p>
            <p>
                <a href="https://github.com/fifaaworldcup/DTESsupport.github.io" class="text-blue-400 hover:text-blue-300 transition underline">View on GitHub</a>
                <span class="mx-2">‚Ä¢</span>
                <span>Made with ‚ù§Ô∏è for the DTES community</span>
            </p>
        </div>
    </footer>
    
</div>

<script>
// ===================================================================
// DTES RESOURCES DATABASE (60+ VERIFIED LOCATIONS)
// ===================================================================

const dtesResources = [
    // SUPERVISED CONSUMPTION SITES
    {name: "Insite (Supervised Consumption)", lat: 49.2811, lng: -123.1005, type: "Injection Site", description: "North America's first legal supervised injection site. Medical supervision, sterile supplies, overdose prevention.", hours: "24/7", phone: "604-685-7677", address: "139 E Hastings St", status: "open"},
    {name: "Powell Street Getaway", lat: 49.2817, lng: -123.0982, type: "Injection Site", description: "Peer-run overdose prevention site. Safe consumption, oxygen, naloxone.", hours: "Daily 10am-10pm", phone: "778-379-2640", address: "528 Powell St", status: "open"},
    {name: "Dr. Peter Centre", lat: 49.2828, lng: -123.1056, type: "Injection Site", description: "Supervised consumption for people with HIV/AIDS. Medical staff on-site.", hours: "Mon-Fri 9am-5pm", phone: "604-677-6330", address: "1110 Comox St", status: "open"},
    {name: "Overdose Prevention Society", lat: 49.2805, lng: -123.1015, type: "Injection Site", description: "Community-led overdose prevention. Safe space, peer support, naloxone training.", hours: "Daily 8am-midnight", phone: "604-559-8873", address: "58 E Hastings St", status: "open"},
    
    // NALOXONE DISTRIBUTION
    {name: "VCH Naloxone Distribution", lat: 49.2819, lng: -123.1000, type: "Naloxone", description: "Free naloxone kits, training, harm reduction supplies. No ID required.", hours: "Mon-Fri 9am-5pm", phone: "604-675-3700", address: "601 W Broadway", status: "open"},
    {name: "BC Centre on Substance Use", lat: 49.2825, lng: -123.1208, type: "Naloxone", description: "Naloxone kits, overdose response training, addiction medicine resources.", hours: "Mon-Fri 8:30am-4:30pm", phone: "778-945-7619", address: "400-1045 Howe St", status: "open"},
    {name: "Carnegie Community Centre", lat: 49.2813, lng: -123.1003, type: "Naloxone", description: "Free naloxone kits at front desk. Community hub with multiple services.", hours: "Mon-Sun 9am-10pm", phone: "604-665-2289", address: "401 Main St", status: "open"},
    {name: "Portland Hotel Society", lat: 49.2816, lng: -123.0995, type: "Naloxone", description: "Naloxone distribution and harm reduction services for community members.", hours: "24/7", phone: "604-683-2911", address: "713 E Hastings St", status: "open"},
    {name: "VANDU", lat: 49.2814, lng: -123.1002, type: "Naloxone", description: "Peer-led advocacy, harm reduction supplies, naloxone training, community support.", hours: "Mon-Fri 10am-6pm", phone: "604-683-8595", address: "380 E Hastings St", status: "open"},
    {name: "Overdose Outreach Team", lat: 49.2815, lng: -123.1005, type: "Naloxone", description: "Mobile outreach providing naloxone, harm reduction supplies, peer support.", hours: "Daily 10am-8pm", phone: "778-379-1965", address: "Mobile service in DTES", status: "open"},
    
    // DETOX CENTERS
    {name: "Withdrawal Management Services", lat: 49.2823, lng: -123.1012, type: "Detox", description: "Medical detox services, 24-hour nursing care, medication-assisted withdrawal.", hours: "24/7 admission", phone: "604-675-3900", address: "1081 Burrard St", status: "open"},
    {name: "Strathcona Mental Health", lat: 49.2790, lng: -123.0987, type: "Detox", description: "Mental health and substance use detox support. Walk-in and referral services.", hours: "Mon-Fri 8:30am-4:30pm", phone: "604-675-2237", address: "565 E Cordova St", status: "open"},
    {name: "Harbour Light Detox", lat: 49.2801, lng: -123.1008, type: "Detox", description: "Faith-based detox and recovery program. Medical supervision, counseling.", hours: "24/7 admission", phone: "604-681-3405", address: "119 E Cordova St", status: "open"},
    {name: "Onsite Detox Centre", lat: 49.2811, lng: -123.1005, type: "Detox", description: "Medical withdrawal management adjacent to Insite. 24/7 nursing care.", hours: "24/7", phone: "604-696-3134", address: "139 E Hastings St", status: "open"},
    
    // FOOD BANKS & MEAL PROGRAMS
    {name: "Union Gospel Mission", lat: 49.2809, lng: -123.0998, type: "Food", description: "Free hot meals daily. No ID required. Breakfast, lunch, and dinner.", hours: "Breakfast 7-9am, Lunch 12-2pm, Dinner 5-7pm", phone: "604-253-3323", address: "616 E Cordova St", status: "open"},
    {name: "First United Church Kitchen", lat: 49.2815, lng: -123.1003, type: "Food", description: "Free meals, food hampers, clothing, social services. Welcoming to all.", hours: "Mon-Fri 9am-4pm", phone: "604-681-8365", address: "320 E Hastings St", status: "open"},
    {name: "Carnegie Centre Lunch", lat: 49.2813, lng: -123.1003, type: "Food", description: "Free community lunch program. Computer lab, library, recreation.", hours: "Lunch Mon-Fri 11:30am-1pm", phone: "604-665-2289", address: "401 Main St", status: "open"},
    {name: "St. James Community Service", lat: 49.2807, lng: -123.1018, type: "Food", description: "Food bank, meal service, housing support, community programs.", hours: "Mon-Fri 10am-3pm", phone: "604-685-8565", address: "303 E Cordova St", status: "open"},
    {name: "DTES Neighbourhood House", lat: 49.2800, lng: -123.0990, type: "Food", description: "Hot meals, food hampers, community kitchen, family programs.", hours: "Mon-Fri 9am-5pm", phone: "604-683-2554", address: "573 E Hastings St", status: "open"},
    {name: "Kettle Friendship Society", lat: 49.2795, lng: -123.0980, type: "Food", description: "Affordable meals, food bank, community support for low-income residents.", hours: "Mon-Sun 8am-9pm", phone: "604-251-1258", address: "1725 Venables St", status: "open"},
    {name: "Gospel Mission Free Meals", lat: 49.2812, lng: -123.1001, type: "Food", description: "Daily hot meals, no questions asked. Welcoming community atmosphere.", hours: "Daily 7am-8pm", phone: "604-872-3464", address: "331 Carrall St", status: "open"},
    {name: "Evelyn Saller Centre", lat: 49.2819, lng: -123.1012, type: "Food", description: "Drop-in centre with meals, showers, laundry, medical clinic.", hours: "Mon-Fri 8am-4pm", phone: "604-215-4917", address: "320 Alexander St", status: "open"},
    {name: "Ray-Cam Co-op Centre", lat: 49.2756, lng: -123.0712, type: "Food", description: "Community centre with food programs, recreation, childcare, family support.", hours: "Mon-Fri 9am-9pm", phone: "604-257-6933", address: "920 E Hastings St", status: "open"},
    
    // SHELTERS & HOUSING
    {name: "Triage Emergency Shelter", lat: 49.2821, lng: -123.1009, type: "Shelter", description: "24/7 emergency shelter, meals, showers, clothing, housing support.", hours: "24/7", phone: "604-215-6285", address: "655 Dunlevy Ave", status: "open"},
    {name: "Salvation Army Harbour Light", lat: 49.2801, lng: -123.1008, type: "Shelter", description: "Men's shelter with addiction recovery programs, meals, support services.", hours: "24/7", phone: "604-681-3405", address: "119 E Cordova St", status: "open"},
    {name: "Salvation Army Shield Centre", lat: 49.2798, lng: -123.1012, type: "Shelter", description: "Women's shelter with childcare, meals, showers, housing navigation.", hours: "24/7", phone: "604-872-7705", address: "209 Carrall St", status: "open"},
    {name: "Lookout Emergency Aid", lat: 49.2803, lng: -123.0997, type: "Shelter", description: "Emergency shelter beds, meals, showers, connection to housing resources.", hours: "24/7", phone: "604-681-4844", address: "320 Alexander St", status: "open"},
    {name: "Directions Youth Centre", lat: 49.2788, lng: -123.0975, type: "Shelter", description: "Youth shelter (ages 13-24), meals, counseling, life skills support.", hours: "24/7", phone: "604-251-3310", address: "1575 Vernon Dr", status: "open"},
    {name: "Covenant House", lat: 49.2782, lng: -123.0968, type: "Shelter", description: "Youth shelter (16-24), crisis intervention, housing, education, job training.", hours: "24/7", phone: "604-685-7474", address: "575 Drake St", status: "open"},
    {name: "Aboriginal Front Door", lat: 49.2818, lng: -123.1005, type: "Shelter", description: "Culturally-appropriate shelter and support for Indigenous people.", hours: "24/7", phone: "604-876-7600", address: "1 W Hastings St", status: "open"},
    {name: "Urban Native Youth Assoc", lat: 49.2742, lng: -123.1158, type: "Shelter", description: "Youth services, housing support, cultural programs for Indigenous youth.", hours: "Mon-Fri 9am-5pm", phone: "604-254-7732", address: "1618 E Hastings St", status: "open"},
    {name: "WISH Drop-In Centre", lat: 49.2808, lng: -123.0992, type: "Shelter", description: "Women-only drop-in with harm reduction, meals, showers, clothing, support.", hours: "Daily 7pm-7am", phone: "604-255-7779", address: "334 Alexander St", status: "open"},
    
    // URGENT CARE & MEDICAL
    {name: "St. Paul's Hospital ER", lat: 49.2828, lng: -123.1056, type: "Urgent", description: "Full-service hospital emergency department. 24/7 emergency medical care.", hours: "24/7", phone: "604-682-2344", address: "1081 Burrard St", status: "open"},
    {name: "Vancouver Native Health", lat: 49.2816, lng: -123.1002, type: "Urgent", description: "Primary care, dental, traditional healing, cultural support for Indigenous people.", hours: "Mon-Fri 8:30am-5pm", phone: "604-254-9949", address: "441 E Hastings St", status: "open"},
    {name: "Dr. Peter AIDS Foundation", lat: 49.2828, lng: -123.1056, type: "Urgent", description: "Medical care for people living with HIV/AIDS. Day health, meals, support.", hours: "Mon-Fri 9am-5pm", phone: "604-677-6330", address: "1110 Comox St", status: "open"},
    {name: "Downtown Community Health", lat: 49.2819, lng: -123.1008, type: "Urgent", description: "Primary care, mental health, addiction medicine. Walk-ins welcome.", hours: "Mon-Fri 8:30am-4:30pm", phone: "604-675-3700", address: "569 Powell St", status: "open"},
    {name: "Pender Community Health", lat: 49.2795, lng: -123.1035, type: "Urgent", description: "Primary care, mental health, harm reduction, chronic disease management.", hours: "Mon-Fri 8am-6pm", phone: "604-669-9181", address: "59 W Pender St", status: "open"},
    {name: "Three Bridges Health Centre", lat: 49.2802, lng: -123.1005, type: "Urgent", description: "Primary care for homeless and vulnerably housed. Walk-in clinic.", hours: "Mon-Fri 9am-5pm", phone: "604-875-5511", address: "1292 Hornby St", status: "open"},
    {name: "VCH Mobile Health Unit", lat: 49.2812, lng: -123.1000, type: "Urgent", description: "Mobile medical services, wound care, immunizations, health screenings.", hours: "Various locations daily 9am-5pm", phone: "604-675-3700", address: "Mobile service throughout DTES", status: "open"},
    {name: "Pacific Spirit Health", lat: 49.2819, lng: -123.1015, type: "Urgent", description: "Primary care, HIV/AIDS services, addiction medicine, mental health support.", hours: "Mon-Fri 9am-5pm", phone: "604-742-1482", address: "1125 Howe St", status: "open"},
    
    // PUBLIC WASHROOMS
    {name: "Carnegie Centre Washrooms", lat: 49.2813, lng: -123.1003, type: "Washrooms", description: "Free public washrooms, accessible, no questions asked.", hours: "Mon-Sun 9am-10pm", phone: "604-665-2289", address: "401 Main St", status: "open"},
    {name: "Oppenheimer Park", lat: 49.2810, lng: -123.0975, type: "Washrooms", description: "Public park washrooms with accessibility features.", hours: "Daily 7am-10pm", phone: "311", address: "400 Powell St", status: "open"},
    {name: "Pigeon Park Washrooms", lat: 49.2815, lng: -123.1005, type: "Washrooms", description: "24/7 accessible public washrooms maintained by the city.", hours: "24/7", phone: "311", address: "Carrall St & W Hastings St", status: "open"},
    {name: "CRAB Park Washrooms", lat: 49.2860, lng: -123.0965, type: "Washrooms", description: "Waterfront park with accessible washrooms and shower facilities.", hours: "Daily 6am-11pm", phone: "311", address: "101 E Waterfront Rd", status: "open"},
    {name: "Main St SkyTrain Station", lat: 49.2729, lng: -123.1005, type: "Washrooms", description: "Public transit station washrooms, accessible 24/7.", hours: "24/7", phone: "604-953-3333", address: "Main St & Terminal Ave", status: "open"},
    {name: "Carnegie Library", lat: 49.2813, lng: -123.1003, type: "Washrooms", description: "Free computer access, wifi, washrooms, quiet space, community programs.", hours: "Mon-Sun 9am-9pm", phone: "604-665-3010", address: "401 Main St", status: "open"},
    
    // MENTAL HEALTH SERVICES
    {name: "Vancouver Mental Health", lat: 49.2820, lng: -123.1015, type: "Mental Health", description: "Crisis intervention, assessment, counseling, psychiatric services.", hours: "Mon-Fri 8:30am-4:30pm", phone: "604-675-3700", address: "803 W 12th Ave", status: "open"},
    {name: "Coast Mental Health", lat: 49.2808, lng: -123.1012, type: "Mental Health", description: "Mental health support, peer counseling, employment, housing assistance.", hours: "Mon-Fri 9am-5pm", phone: "604-872-3502", address: "1155 Burrard St", status: "open"},
    {name: "Access & Assessment Centre", lat: 49.2825, lng: -123.1018, type: "Mental Health", description: "Walk-in mental health assessments, crisis support, referrals.", hours: "Mon-Fri 8am-9pm, Sat-Sun 10am-6pm", phone: "604-675-3700", address: "803 W 12th Ave", status: "open"},
    {name: "CMHA Vancouver", lat: 49.2795, lng: -123.1025, type: "Mental Health", description: "Mental health education, peer support groups, advocacy, resource navigation.", hours: "Mon-Fri 9am-5pm", phone: "604-872-4902", address: "1301 E 41st Ave", status: "open"},
    {name: "RainCity Housing Support", lat: 49.2811, lng: -123.0998, type: "Mental Health", description: "Mental health outreach, housing support, case management services.", hours: "Mon-Fri 9am-5pm", phone: "604-685-7699", address: "520 E Hastings St", status: "open"},
    {name: "BC Women's Hospital Crisis", lat: 49.2633, lng: -123.1238, type: "Mental Health", description: "24/7 crisis support for women, reproductive health, mental health services.", hours: "24/7", phone: "604-875-2025", address: "4500 Oak St", status: "open"},
    {name: "Vancouver Recovery Club", lat: 49.2762, lng: -123.1045, type: "Mental Health", description: "Peer support, recovery meetings, social activities for mental health and addiction.", hours: "Mon-Fri 9am-9pm", phone: "604-874-8244", address: "1212 W Broadway", status: "open"},
    {name: "Battered Women's Support", lat: 49.2635, lng: -123.1158, type: "Mental Health", description: "24/7 crisis line, counseling, legal advocacy for women escaping violence.", hours: "24/7 crisis line", phone: "604-687-1867", address: "Confidential locations", status: "open"}
];

// GLOBAL VARIABLES
let map, markers = [], userLocationMarker, userLat, userLng, mapLoaded = false;

// ===================================================================
// LOAD EXTERNAL RESOURCES WITH FALLBACKS
// ===================================================================

function loadScript(src, callback, fallback) {
    const script = document.createElement('script');
    script.src = src;
    script.onload = callback;
    script.onerror = fallback;
    document.head.appendChild(script);
}

function loadCSS(href, callback, fallback) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    link.onload = callback;
    link.onerror = fallback;
    document.head.appendChild(link);
}

// ===================================================================
// FALLBACK MAP RENDERING
// ===================================================================

function renderFallbackMap(resources = dtesResources) {
    const fallbackMap = document.getElementById('fallbackMap');
    const resourceList = document.getElementById('resourceList');
    
    resourceList.innerHTML = '';
    
    resources.forEach(resource => {
        const card = document.createElement('div');
        card.className = 'resource-card';
        
        const typeClass = `type-${resource.type.toLowerCase().replace(' ', '-').replace('injection', 'injection').replace('mental health', 'mental')}`;
        
        card.innerHTML = `
            <div class="resource-type ${typeClass}">${resource.type}</div>
            <h3 class="font-bold text-lg mb-2">${resource.name}</h3>
            <p class="text-gray-600 mb-2">${resource.description}</p>
            <p class="text-sm mb-2">
                <strong>Hours:</strong> ${resource.hours}<br>
                <strong>Phone:</strong> <a href="tel:${resource.phone}" class="text-blue-600 hover:underline">${resource.phone}</a><br>
                <strong>Address:</strong> ${resource.address}
            </p>
            <div class="mt-3">
                <button onclick="window.open('https://maps.google.com/maps?q=${resource.lat},${resource.lng}(${encodeURIComponent(resource.name)})', '_blank')" class="btn btn-primary">
                    <span class="icon icon-directions"></span> Get Directions
                </button>
                <button onclick="window.open('tel:${resource.phone}')" class="btn btn-secondary">
                    <span class="icon icon-phone"></span> Call
                </button>
            </div>
        `;
        
        resourceList.appendChild(card);
    });
    
    fallbackMap.style.display = 'block';
    document.getElementById('map').style.display = 'none';
}

// ===================================================================
// MAP INITIALIZATION WITH FALLBACK
// ===================================================================

function initMap() {
    // Try to load Leaflet
    loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', 
        function() {
            // Leaflet loaded successfully
            loadCSS('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
                function() {
                    // CSS loaded successfully, initialize map
                    initializeLeafletMap();
                },
                function() {
                    // CSS failed, still try to initialize
                    initializeLeafletMap();
                }
            );
        },
        function() {
            // Leaflet failed to load, use fallback
            console.log('Leaflet failed to load, using fallback map');
            showFallbackMap();
        }
    );
}

function initializeLeafletMap() {
    try {
        if (typeof L === 'undefined') {
            throw new Error('Leaflet not loaded');
        }

        map = L.map('map', {
            zoomControl: true,
            dragging: true,
            touchZoom: true,
            scrollWheelZoom: true,
            doubleClickZoom: true
        }).setView([49.2819, -123.1000], 15);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19,
            minZoom: 12
        }).addTo(map);

        // Add all resource markers to map
        dtesResources.forEach(resource => {
            addMarker(resource);
        });

        mapLoaded = true;
        
        // Hide loading overlay and show app
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainAppContent').classList.remove('opacity-0');
            }, 500);
        }, 1200);

    } catch (error) {
        console.error('Map initialization error:', error);
        showFallbackMap();
    }
}

function showFallbackMap() {
    renderFallbackMap();
    
    // Hide loading overlay and show app
    setTimeout(() => {
        document.getElementById('loadingOverlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('mainAppContent').classList.remove('opacity-0');
        }, 500);
    }, 1200);
}

// ===================================================================
// ADD MARKER TO MAP (only if map is loaded)
// ===================================================================

function addMarker(resource) {
    if (!mapLoaded) return;
    
    const iconColors = {
        'Naloxone': '#3B82F6',
        'Injection Site': '#10B981',
        'Detox': '#F97316',
        'Food': '#9333EA',
        'Shelter': '#b45309',
        'Urgent': '#EF4444',
        'Washrooms': '#14B8A6',
        'Mental Health': '#EC4899'
    };

    const customIcon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="
            background-color: ${iconColors[resource.type] || '#6B7280'};
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        "></div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    const marker = L.marker([resource.lat, resource.lng], { icon: customIcon })
        .addTo(map)
        .bindPopup(createPopupContent(resource));

    marker.resourceData = resource;
    markers.push(marker);
}

function createPopupContent(resource) {
    const iconColors = {
        'Naloxone': '#3B82F6',
        'Injection Site': '#10B981',
        'Detox': '#F97316',
        'Food': '#9333EA',
        'Shelter': '#b45309',
        'Urgent': '#EF4444',
        'Washrooms': '#14B8A6',
        'Mental Health': '#EC4899'
    };

    const safeName = resource.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    
    return `
        <div style="max-width: 280px; font-family: 'Nunito Sans', sans-serif;">
            <h3 style="font-weight: bold; margin-bottom: 10px; font-size: 17px; color: #1F2937;">
                ${resource.name}
            </h3>
            <p style="margin-bottom: 8px; font-size: 13px;">
                <strong style="color: ${iconColors[resource.type] || '#6B7280'};">Type:</strong> ${resource.type}
            </p>
            <p style="margin-bottom: 8px; font-size: 13px; line-height: 1.5;">
                ${resource.description}
            </p>
            <p style="margin-bottom: 8px; font-size: 13px;">
                <strong>Hours:</strong> ${resource.hours}
            </p>
            <p style="margin-bottom: 12px; font-size: 13px;">
                <strong>Call:</strong> 
                <a href="tel:${resource.phone}" style="color: #2563EB; text-decoration: underline;">
                    ${resource.phone}
                </a>
            </p>
            <p style="margin-bottom: 12px; font-size: 12px; color: #6B7280;">
                üìç ${resource.address}
            </p>
            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                <button 
                    onclick="window.open('https://maps.google.com/maps?q=${resource.lat},${resource.lng}(${encodeURIComponent(resource.name)})', '_blank')" 
                    class="btn btn-danger"
                    style="width: 100%; margin-top: 12px !important;"
                >
                    <span class="icon icon-directions"></span> Get Directions
                </button>
            </div>
        </div>
    `;
}

// ===================================================================
// SEARCH FUNCTIONALITY
// ===================================================================

document.getElementById('searchBar').addEventListener('input', (event) => {
    const searchQuery = event.target.value.toLowerCase().trim();
    
    if (mapLoaded) {
        markers.forEach(marker => {
            const resource = marker.resourceData;
            const matchesSearch = 
                resource.name.toLowerCase().includes(searchQuery) ||
                resource.description.toLowerCase().includes(searchQuery) ||
                resource.type.toLowerCase().includes(searchQuery) ||
                resource.address.toLowerCase().includes(searchQuery);

            if (matchesSearch || searchQuery === '') {
                marker.addTo(map);
            } else {
                map.removeLayer(marker);
            }
        });
    } else {
        // Filter fallback map
        const filteredResources = dtesResources.filter(resource => 
            resource.name.toLowerCase().includes(searchQuery) ||
            resource.description.toLowerCase().includes(searchQuery) ||
            resource.type.toLowerCase().includes(searchQuery) ||
            resource.address.toLowerCase().includes(searchQuery) ||
            searchQuery === ''
        );
        renderFallbackMap(filteredResources);
    }

    // Update count
    const visibleCount = mapLoaded ? 
        markers.filter(m => map.hasLayer(m)).length :
        dtesResources.filter(r => 
            r.name.toLowerCase().includes(searchQuery) ||
            r.description.toLowerCase().includes(searchQuery) ||
            r.type.toLowerCase().includes(searchQuery) ||
            r.address.toLowerCase().includes(searchQuery) ||
            searchQuery === ''
        ).length;
    
    document.getElementById('resourceCount').textContent = `${visibleCount} verified locations`;
});

// ===================================================================
// FILTER BUTTONS
// ===================================================================

document.querySelectorAll('.filter-button').forEach(button => {
    button.addEventListener('click', () => {
        // Remove active class from all buttons
        document.querySelectorAll('.filter-button').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
        });

        // Add active class to clicked button
        button.classList.add('active');
        button.setAttribute('aria-pressed', 'true');

        const filterType = button.dataset.filter;

        if (mapLoaded) {
            markers.forEach(marker => {
                if (filterType === 'all' || marker.resourceData.type === filterType) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });
        } else {
            // Filter fallback map
            const filteredResources = filterType === 'all' ? 
                dtesResources : 
                dtesResources.filter(r => r.type === filterType);
            renderFallbackMap(filteredResources);
        }

        // Update count
        const visibleCount = mapLoaded ? 
            markers.filter(m => 
                filterType === 'all' || m.resourceData.type === filterType
            ).length :
            filterType === 'all' ? 
                dtesResources.length :
                dtesResources.filter(r => r.type === filterType).length;
        
        document.getElementById('resourceCount').textContent = `${visibleCount} verified locations`;
    });
});

// ===================================================================
// USER LOCATION FEATURE
// ===================================================================

document.getElementById('locateUserButton').addEventListener('click', () => {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
    }

    document.getElementById('userLocationStatus').textContent = 'Locating you...';

    navigator.geolocation.getCurrentPosition(
        (position) => {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;

            if (mapLoaded) {
                // Remove old user location marker if exists
                if (userLocationMarker) {
                    map.removeLayer(userLocationMarker);
                }

                const userIcon = L.divIcon({
                    className: 'user-location-icon',
                    html: `<div style="
                        background-color: #3B82F6;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
                    "></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                userLocationMarker = L.marker([userLat, userLng], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('<strong>You are here</strong><br>Your current location');

                map.setView([userLat, userLng], 16);
                userLocationMarker.openPopup();
            } else {
                alert(`Your location: ${userLat.toFixed(4)}, ${userLng.toFixed(4)}`);
            }

            document.getElementById('userLocationStatus').textContent = 'Location found!';
        },
        (error) => {
            console.error('Geolocation error:', error);
            let errorMsg = 'Location unavailable. ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg += 'Please enable location services';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg += 'Location information is unavailable';
                    break;
                case error.TIMEOUT:
                    errorMsg += 'Location request timed out';
                    break;
                default:
                    errorMsg += 'An unknown error occurred';
            }
            
            alert(errorMsg);
            document.getElementById('userLocationStatus').textContent = 'Location error';
        }
    );
});

// ===================================================================
// EMERGENCY BUTTON
// ===================================================================

document.getElementById('emergencyButton').addEventListener('click', () => {
    const emergencyMsg = document.getElementById('emergencyMessage');
    emergencyMsg.classList.remove('hidden');

    setTimeout(() => {
        emergencyMsg.classList.add('hidden');
    }, 5000);

    console.log('Emergency button clicked');
});

// ===================================================================
// NALOXONE INSTRUCTIONS
// ===================================================================

document.getElementById('instructionsButton').addEventListener('click', () => {
    alert(`
üÜò NALOXONE (NARCAN) ADMINISTRATION INSTRUCTIONS

1Ô∏è‚É£ RECOGNIZE OVERDOSE SIGNS:
   ‚Ä¢ No breathing or very slow breathing
   ‚Ä¢ Blue lips or fingernails
   ‚Ä¢ Unconscious or unresponsive
   ‚Ä¢ Gurgling or choking sounds

2Ô∏è‚É£ CALL 911 IMMEDIATELY
   ‚Ä¢ Stay on the line
   ‚Ä¢ Give exact location
   ‚Ä¢ Good Samaritan Law protects you

3Ô∏è‚É£ GIVE NALOXONE:
   Nasal Spray: Insert in nostril, press plunger
   Injectable: Inject into upper arm or thigh muscle

4Ô∏è‚É£ PROVIDE RESCUE BREATHS (if trained):
   ‚Ä¢ Tilt head back
   ‚Ä¢ Give 1 breath every 5 seconds

5Ô∏è‚É£ STAY WITH PERSON:
   ‚Ä¢ Do NOT leave them alone
   ‚Ä¢ Put in recovery position (on side)
   
6Ô∏è‚É£ SECOND DOSE:
   ‚Ä¢ Give after 3-5 minutes if no response
   ‚Ä¢ Continue until help arrives

üìû Free naloxone kits available at locations marked with blue pins on map.

‚öñÔ∏è Good Samaritan Drug Overdose Act protects you from simple possession charges when calling 911.
            `.trim());
});

// ===================================================================
// REPORT STATUS BUTTON
// ===================================================================

document.getElementById('reportStatusButton').addEventListener('click', () => {
    alert(`
üì¢ REPORT SERVICE CHANGES

Help us keep information accurate by reporting:

‚úÖ Service closures or changes
‚úÖ Updated hours of operation  
‚úÖ New resources in the community
‚úÖ Incorrect contact information

How to report:
‚Ä¢ Email: info@dteslifeline.org
‚Ä¢ GitHub: Open an issue at our repository
‚Ä¢ In person: Visit any resource location

Your feedback helps the community!

Thank you for your contribution. üôè
            `.trim());
});

// ===================================================================
// INITIALIZE ON PAGE LOAD
// ===================================================================

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
} else {
    initMap();
}

// Add CSS for user location icon
const style = document.createElement('style');
style.textContent = `
    .user-location-icon {
        background-color: #3B82F6 !important;
        width: 20px !important;
        height: 20px !important;
        border-radius: 50% !important;
        border: 3px solid white !important;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.6) !important;
        animation: pulse 1.5s infinite !important;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }
`;
document.head.appendChild(style);
</script>

</body>
</html>
