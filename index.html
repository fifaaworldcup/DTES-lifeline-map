<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vancouver DTES Lifeline Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
  /* base */
  :root { --base-font:16px; --muted:#6b7280; --accent:#1d4ed8; }
  html,body,#map{ height:100%; margin:0; font-family: "Nunito Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; font-size:var(--base-font); background:#f6f7fb; }
  #map{ height:72vh; width:100%; min-height:420px; border-radius:.75rem; background:#fff; }
  /* popups */
  .leaflet-popup-content-wrapper{ border-radius:12px; font-family:inherit; }
  /* loading */
  #loadingOverlay{ position:fixed; inset:0; background:rgba(255,255,255,.98); z-index:1510; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .spinner{ border:4px solid rgba(0,0,0,.08); width:44px; height:44px; border-radius:50%; border-left-color:var(--accent); animation:spin 1s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  /* UI tweaks */
  .popup-btn{ padding:.45rem .8rem; border-radius:.5rem; font-weight:600; display:inline-flex; align-items:center; gap:.5rem; cursor:pointer; border:none; }
  .direction-btn{ background:#ef4444;color:#fff;width:100%; }
  .filter-button{ transition:all .18s; box-shadow:0 1px 3px rgba(0,0,0,.08); border:2px solid transparent; }
  .filter-button.active{ box-shadow:0 0 0 3px rgba(29,78,216,.12); border-color:#1D4ED8; transform:scale(1.02); }
  /* accessibility widget */
  #a11yWidget{ position:fixed; right:16px; bottom:16px; width:320px; background:#fff; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.12); padding:12px; z-index:2200; transition:all .18s; }
  #a11yWidget.minimized{ width:52px; height:52px; padding:6px; border-radius:50%; overflow:hidden; display:flex; align-items:center; justify-content:center; }
  /* dyslexic / large text helpers */
  .dyslexic { font-family: "Verdana", "Arial", sans-serif; letter-spacing: .02em; }
  .large-text { font-size:1.1875rem; line-height:1.6; }
  .big-cursor * { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><circle cx="12" cy="12" r="10" fill="black"/></svg>') 12 12, auto; }
  /* focus ring for keyboard users */
  .keyboard-focus *:focus { outline: 3px solid rgba(59,130,246,0.35); outline-offset: 2px; }
  /* reduced motion class */
  .reduced-motion * { animation-duration: 0.001ms !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
  /* high contrast */
  .high-contrast { background:#000 !important; color:#fff !important; }
  .high-contrast a { color: #ffea00 !important; }
  /* skip link */
  .skip-link{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  .skip-link:focus{ left:10px; top:10px; width:auto; height:auto; padding:8px 12px; background:#111; color:#fff; border-radius:6px; z-index:3000; }
  /* small responsive */
  @media (max-width:640px){ #a11yWidget{ right:10px; left:10px; width:auto; } }
</style>
</head>
<body>

<a href="#mainAppContent" class="skip-link">Skip to content</a>

<div id="loadingOverlay" aria-hidden="false">
  <div class="spinner mb-4" role="status" aria-hidden="true"></div>
  <div class="text-xl font-bold">DTES Lifeline Map</div>
  <div class="text-sm text-gray-600 mt-2">Loading community resources‚Ä¶</div>
</div>

<!-- language selector -->
<div class="language-selector" style="position:fixed;top:10px;right:10px;z-index:2000;">
  <label for="languageSelect" class="sr-only">Language</label>
  <select id="languageSelect" aria-label="Choose language" class="bg-white border border-gray-300 rounded px-3 py-1 text-sm shadow-lg">
    <option value="en">English</option><option value="zh">‰∏≠Êñá</option><option value="es">Espa√±ol</option><option value="fr">Fran√ßais</option>
    <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option><option value="tl">Tagalog</option><option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option><option value="fa">ŸÅÿßÿ±ÿ≥€å</option>
    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option><option value="ur">ÿßÿ±ÿØŸà</option><option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
    <option value="nl">Nederlands</option><option value="it">Italiano</option><option value="sv">Svenska</option><option value="de">Deutsch</option><option value="pt">Portugu√™s</option>
  </select>
</div>

<!-- QR modal -->
<div id="qrModal" class="qr-modal" style="display:none; position:fixed; inset:0; z-index:2500; align-items:center; justify-content:center; background:rgba(0,0,0,.5);">
  <div class="qr-modal-content" style="background:#fff;padding:20px;border-radius:10px;max-width:420px;width:90%;text-align:center;">
    <button id="closeQrModal" aria-label="Close QR" style="float:right;background:none;border:none;font-size:20px;">√ó</button>
    <h2 id="qrTitle" class="text-lg font-bold mb-2">Location QR Code</h2>
    <div id="qrcode" style="margin:8px auto;"></div>
    <p id="qrLocationName" class="text-sm text-gray-600 mt-3"></p>
  </div>
</div>

<button id="quickExit" style="position:fixed;right:14px;top:14px;background:#ef4444;color:#fff;padding:8px 10px;border-radius:8px;z-index:2000;border:none;display:none;">Exit</button>

<!-- App -->
<main id="mainAppContent" class="container mx-auto p-4 md:p-8" role="main" aria-live="polite">

  <header class="bg-white p-6 shadow-xl rounded-xl mb-6" role="banner">
    <h1 id="mainTitle" class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2">Vancouver DTES Lifeline Map</h1>
    <p id="subtitle" class="text-gray-600 mb-2">Instant access to harm reduction, supervised consumption, food banks, shelters, detox centers, and urgent care services.</p>
    <p class="text-sm text-gray-500 mb-2">
      <span id="userLocationStatus" class="font-semibold text-gray-700">Ready</span>
      <span class="mx-2">|</span>
      <span id="resourceCount" class="text-blue-600 font-semibold">0 verified locations</span>
    </p>
    <div id="alertBanner" class="text-xs text-red-600 font-semibold mt-3 bg-red-50 p-3 rounded-lg border border-red-200" role="status">
      <i class="fas fa-exclamation-triangle mr-2"></i><span id="alertText">Important: Service hours may change. Always call ahead.</span>
    </div>
  </header>

  <!-- controls -->
  <section class="grid grid-cols-1 gap-4 mb-6" aria-labelledby="searchLabel">
    <div class="bg-white p-5 shadow-lg rounded-xl border border-gray-200">
      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <div class="flex-grow">
          <label id="searchLabel" for="searchBar" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-search mr-1"></i> <span id="searchLabelText">Search Resources:</span>
          </label>
          <input id="searchBar" type="text" placeholder="Search by name, type, or service" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" aria-label="Search resources">
        </div>
      </div>

      <div class="mb-2"><span id="filterLabel" class="text-sm font-semibold text-gray-700"><i class="fas fa-filter mr-1"></i> Filter by Category:</span></div>

      <div id="filterButtons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-3" role="toolbar" aria-label="Quick filters">
        <button data-filter="all" class="filter-button bg-gray-600 hover:bg-gray-700 text-white py-2.5 px-3 rounded-lg active" aria-pressed="true">All (<span id="allCount">0</span>)</button>
        <button data-filter="Naloxone" class="filter-button bg-blue-500 hover:bg-blue-600 text-white py-2.5 px-3 rounded-lg">Naloxone</button>
        <button data-filter="Injection Site" class="filter-button bg-green-500 hover:bg-green-600 text-white py-2.5 px-3 rounded-lg">Sites</button>
        <button data-filter="Detox" class="filter-button bg-orange-500 hover:bg-orange-600 text-white py-2.5 px-3 rounded-lg">Detox</button>
        <button data-filter="Food" class="filter-button bg-purple-600 hover:bg-purple-700 text-white py-2.5 px-3 rounded-lg">Food</button>
        <button data-filter="Shelter" class="filter-button bg-yellow-700 hover:bg-yellow-800 text-white py-2.5 px-3 rounded-lg">Shelter</button>
        <button data-filter="Urgent" class="filter-button bg-red-600 hover:bg-red-700 text-white py-2.5 px-3 rounded-lg">Urgent</button>
        <button data-filter="Washrooms" class="filter-button bg-teal-600 hover:bg-teal-700 text-white py-2.5 px-3 rounded-lg">Washrooms</button>
        <button data-filter="Mental Health" class="filter-button bg-pink-600 hover:bg-pink-700 text-white py-2.5 px-3 rounded-lg">Mental</button>
      </div>

      <div>
        <div class="text-sm font-medium text-gray-700">Select categories (multi-select):</div>
        <div id="categoryCheckboxes" class="cat-list" aria-live="polite" aria-label="Category checkboxes"></div>
      </div>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
      <button id="locateUserButton" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg" aria-label="Find my location">
        <i class="fas fa-crosshairs mr-2"></i> <span id="locateBtnLabel">Find My Location</span>
      </button>
      <button id="instructionsButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg" aria-label="Naloxone instructions">
        <i class="fas fa-hand-holding-medical mr-2"></i> <span id="naloxoneBtnLabel">Naloxone Guide</span>
      </button>
      <button id="reportStatusButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg shadow-lg" aria-label="Report an issue">
        <i class="fas fa-bullhorn mr-2"></i> <span id="reportBtnLabel">Report Issue</span>
      </button>
      <button id="emergencyButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg" aria-label="Emergency 911">
        <i class="fas fa-phone-alt mr-2"></i> <span id="emergencyBtnLabel">Emergency 911</span>
      </button>
    </div>
  </section>

  <div id="emergencyMessage" class="hidden bg-red-200 border-2 border-red-500 text-red-800 px-4 py-3 rounded-lg mb-4 font-bold" role="alert">
    <i class="fas fa-exclamation-circle mr-2"></i> <span id="emergencyText">EMERGENCY: Please call 911 immediately.</span>
  </div>

  <div id="map" class="shadow-2xl border-4 border-white" role="application" aria-label="Map"></div>

  <footer class="mt-6 bg-gray-800 text-white p-6 rounded-xl shadow-lg" role="contentinfo">
    <h2 id="hotlinesTitle" class="text-xl font-bold mb-4 border-b border-gray-700 pb-2"><i class="fas fa-phone-volume mr-2"></i> Hotlines & Support</h2>
    <div id="hotlinesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5 text-sm" aria-live="polite"></div>
    <div class="text-center text-xs text-gray-400 mt-6 pt-4 border-t border-gray-700">
      <p>Made with ‚ù§Ô∏è for the DTES community ‚Äî call first to confirm hours and availability.</p>
    </div>
  </footer>
</main>

<!-- accessibility widget -->
<div id="a11yWidget" role="region" aria-label="Accessibility options">
  <div id="a11yContent">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong id="a11yTitle">Accessibility</strong>
      <div style="display:flex;gap:6px;align-items:center;">
        <button id="minimizeA11y" class="text-sm text-gray-600" aria-label="Minimize accessibility">‚Äì</button>
      </div>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="increaseFont" class="bg-gray-100 px-3 py-1 rounded text-sm" aria-label="Increase text size">A+</button>
      <button id="decreaseFont" class="bg-gray-100 px-3 py-1 rounded text-sm" aria-label="Decrease text size">A-</button>
      <button id="toggleContrast" class="bg-gray-100 px-3 py-1 rounded text-sm" aria-pressed="false">High contrast</button>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="toggleDyslexic" class="bg-gray-100 px-3 py-1 rounded text-sm" aria-pressed="false">Dyslexic font</button>
      <button id="toggleSpacing" class="bg-gray-100 px-3 py-1 rounded text-sm" aria-pressed="false">Letter spacing</button>
      <button id="toggleLargeCursor" class="bg-gray-100 px-3 py-1 rounded text-sm" aria-pressed="false">Large cursor</button>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="toggleReduceMotion" class="bg-gray-100 px-3 py-1 rounded text-sm" aria-pressed="false">Reduce motion</button>
      <button id="toggleKeyboardFocus" class="bg-gray-100 px-3 py-1 rounded text-sm" aria-pressed="false">Keyboard mode</button>
    </div>

    <div style="margin-top:8px;">
      <button id="readPopup" class="bg-blue-600 text-white px-3 py-1 rounded text-sm" aria-label="Read popup content">üîä Read open popup</button>
      <small id="screenReaderTip" class="block text-xs text-gray-500 mt-2">Screen reader & reading options available</small>
    </div>
  </div>

  <div id="a11yMinimized" style="display:none;text-align:center;">
    <button id="restoreA11y" title="Open accessibility" style="background:none;border:none;font-size:20px;"><i class="fas fa-universal-access"></i></button>
  </div>
</div>

<!-- libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
/* =========================
  TRANSLATIONS: FULL UI + POPUPS
  Keys used across the page (all languages included)
  ========================= */
const T = {
  en: {
    title:"Vancouver DTES Lifeline Map", subtitle:"Instant access to harm reduction, supervised consumption, food banks, shelters, detox centers, and urgent care services.",
    searchPlaceholder:"Search by name, type, or service", locate:"Find My Location", naloxone:"Naloxone Guide", report:"Report Issue", emergency:"Emergency 911",
    filterLabel:"Filter by Category:", searchLabel:"Search Resources:", alert:"Important: Service hours may change. Always call ahead.",
    resourceCountSuffix:"verified locations", locating:"Locating...", locationFound:"Location found!", enableLocationFirst:"Enable your location first",
    directionsTo:"Directions to", followRedLine:"Follow the red line on the map",
    popup_type:"Type", popup_hours:"Hours", popup_call:"Call", popup_getDirections:"Get Directions", popup_openInMaps:"Open in Maps", popup_showQRCode:"Show QR",
    accessibilityTitle:"Accessibility", highContrast:"High contrast", dyslexicFont:"Dyslexic font", letterSpacing:"Letter spacing", largeText:"Large text",
    reduceMotion:"Reduce motion", keyboardMode:"Keyboard focus mode", readPopup:"Read open popup", hotlinesTitle:"Hotlines & Support",
    emergencyText:"EMERGENCY: Please call 911 immediately.", skipTo:"Skip to content", copy:"Copy"
  },
  fa: {
    title:"ŸÜŸÇÿ¥Ÿá ŸÖŸÜÿßÿ®ÿπ DTES ŸàŸÜ⁄©ŸàŸàÿ±", subtitle:"ÿØÿ≥ÿ™ÿ±ÿ≥€å ŸÅŸàÿ±€å ÿ®Ÿá ⁄©ÿßŸáÿ¥ ÿ¢ÿ≥€åÿ®ÿå ŸÖÿ±ÿß⁄©ÿ≤ ŸÖÿµÿ±ŸÅ ÿ™ÿ≠ÿ™ ŸÜÿ∏ÿßÿ±ÿ™ÿå ÿ®ÿßŸÜ⁄©‚ÄåŸáÿß€å ÿ∫ÿ∞ÿßÿå ŸæŸÜÿßŸá⁄ØÿßŸá‚ÄåŸáÿßÿå ŸÖÿ±ÿß⁄©ÿ≤ ÿ≥ŸÖ‚Äåÿ≤ÿØÿß€å€å Ÿà ŸÖÿ±ÿßŸÇÿ®ÿ™‚ÄåŸáÿß€å ÿßÿ∂ÿ∑ÿ±ÿßÿ±€å.",
    searchPlaceholder:"ÿ¨ÿ≥ÿ™ÿ¨Ÿà ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ŸÜÿßŸÖÿå ŸÜŸàÿπ €åÿß ÿ≥ÿ±Ÿà€åÿ≥", locate:"ŸÖ⁄©ÿßŸÜ ŸÖŸÜ", naloxone:"ÿ±ÿßŸáŸÜŸÖÿß€å ŸÜÿßŸÑŸà⁄©ÿ≥ŸàŸÜ", report:"⁄Øÿ≤ÿßÿ±ÿ¥ ŸÖÿ¥⁄©ŸÑ", emergency:"ÿßŸàÿ±⁄òÿßŸÜÿ≥ 911",
    filterLabel:"ŸÅ€åŸÑÿ™ÿ± ÿ®ÿ±ÿßÿ≥ÿßÿ≥ ÿØÿ≥ÿ™Ÿá:", searchLabel:"ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ŸÖŸÜÿßÿ®ÿπ:", alert:"ŸÖŸáŸÖ: ÿ≥ÿßÿπÿßÿ™ ÿÆÿØŸÖÿßÿ™ ŸÖŸÖ⁄©ŸÜ ÿßÿ≥ÿ™ ÿ™ÿ∫€å€åÿ± ⁄©ŸÜÿØ. ÿßÿ®ÿ™ÿØÿß ÿ™ŸÖÿßÿ≥ ÿ®⁄Ø€åÿ±€åÿØ.",
    resourceCountSuffix:"ŸÖ⁄©ÿßŸÜ‚ÄåŸáÿß€å ÿ™ÿ£€å€åÿØÿ¥ÿØŸá", locating:"ÿØÿ± ÿ≠ÿßŸÑ €åÿßŸÅÿ™ŸÜ...", locationFound:"ŸÖŸàŸÇÿπ€åÿ™ Ÿæ€åÿØÿß ÿ¥ÿØ!", enableLocationFirst:"ÿßÿ®ÿ™ÿØÿß ŸÖ⁄©ÿßŸÜ ÿÆŸàÿØ ÿ±ÿß ŸÅÿπÿßŸÑ ⁄©ŸÜ€åÿØ",
    directionsTo:"ÿ±ÿßŸáŸÜŸÖÿß", followRedLine:"ÿÆÿ∑ ŸÇÿ±ŸÖÿ≤ ÿ±Ÿà€å ŸÜŸÇÿ¥Ÿá ÿ±ÿß ÿØŸÜÿ®ÿßŸÑ ⁄©ŸÜ€åÿØ",
    popup_type:"ŸÜŸàÿπ", popup_hours:"ÿ≥ÿßÿπÿßÿ™", popup_call:"ÿ™ŸÖÿßÿ≥", popup_getDirections:"ÿØÿ±€åÿßŸÅÿ™ ŸÖÿ≥€åÿ±", popup_openInMaps:"ÿ®ÿßÿ≤ ⁄©ÿ±ÿØŸÜ ÿØÿ± ŸÜŸÇÿ¥Ÿá", popup_showQRCode:"ŸÜŸÖÿß€åÿ¥ QR",
    accessibilityTitle:"ÿØÿ≥ÿ™ÿ±ÿ≥‚ÄåŸæÿ∞€åÿ±€å", highContrast:"⁄©ŸÜÿ™ÿ±ÿßÿ≥ÿ™ ÿ®ÿßŸÑÿß", dyslexicFont:"ŸÅŸàŸÜÿ™ ÿØ€åÿ≥ŸÑ⁄©ÿ≥€åÿß", letterSpacing:"ŸÅÿßÿµŸÑŸá ÿ≠ÿ±ŸàŸÅ", largeText:"ŸÖÿ™ŸÜ ÿ®ÿ≤ÿ±⁄Ø",
    reduceMotion:"⁄©ÿßŸáÿ¥ ÿßŸÜ€åŸÖ€åÿ¥ŸÜ", keyboardMode:"ÿ≠ÿßŸÑÿ™ ÿµŸÅÿ≠Ÿá‚Äå⁄©ŸÑ€åÿØ", readPopup:"ÿÆŸàÿßŸÜÿØŸÜ ŸæŸÜÿ¨ÿ±Ÿá ÿ®ÿßÿ≤", hotlinesTitle:"ÿÆÿ∑Ÿàÿ∑ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å",
    emergencyText:"ÿßŸàÿ±⁄òÿßŸÜÿ≥: ŸÑÿ∑ŸÅÿßŸã ÿ®ŸÑÿßŸÅÿßÿµŸÑŸá ÿ®ÿß 911 ÿ™ŸÖÿßÿ≥ ÿ®⁄Ø€åÿ±€åÿØ.", skipTo:"Ÿæÿ±ÿ¥ ÿ®Ÿá ŸÖÿ≠ÿ™Ÿàÿß", copy:"⁄©Ÿæ€å"
  },
  hi: {
    title:"‡§°‡•Ä‡§ü‡•Ä‡§à‡§è‡§∏ ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§® ‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞", subtitle:"‡§π‡§∞‡•ç‡§Æ-‡§∞‡§ø‡§°‡§ï‡•ç‡§∂‡§®, ‡§∏‡•Å‡§™‡§∞‡§µ‡§æ‡§á‡§ú‡§º‡§° ‡§ï‡§Ç‡§ú‡§Æ‡•ç‡§™‡•ç‡§∂‡§®, ‡§´‡•Ç‡§° ‡§¨‡•à‡§Ç‡§ï, ‡§∂‡•á‡§≤‡•ç‡§ü‡§∞, ‡§°‡§ø‡§ü‡•â‡§ï‡•ç‡§∏ ‡§î‡§∞ ‡§Ü‡§™‡§æ‡§§ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§∏‡•á‡§µ‡§æ‡§ì‡§Ç ‡§§‡§ï ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§™‡§π‡•Å‡§Å‡§ö‡•§",
    searchPlaceholder:"‡§®‡§æ‡§Æ, ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞, ‡§Ø‡§æ ‡§∏‡•á‡§µ‡§æ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç", locate:"‡§Æ‡•á‡§∞‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø", naloxone:"‡§®‡§æ‡§≤‡•â‡§ï‡•ç‡§∏‡•ã‡§® ‡§Æ‡§æ‡§∞‡•ç‡§ó‡§¶‡§∞‡•ç‡§∂‡§ø‡§ï‡§æ", report:"‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç", emergency:"‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤ 911",
    filterLabel:"‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞:", searchLabel:"‡§∏‡§Ç‡§∏‡§æ‡§ß‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§ñ‡•ã‡§ú:", alert:"‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£: ‡§∏‡•á‡§µ‡§æ ‡§ï‡•á ‡§ò‡§Ç‡§ü‡•á ‡§¨‡§¶‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§™‡§π‡§≤‡•á ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç‡•§",
    resourceCountSuffix:"‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§∏‡•ç‡§•‡§æ‡§®", locating:"‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§™‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...", locationFound:"‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡§ø‡§≤‡•Ä!", enableLocationFirst:"‡§™‡§π‡§≤‡•á ‡§Ö‡§™‡§®‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞‡•á‡§Ç",
    directionsTo:"‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂", followRedLine:"‡§®‡§ï‡•ç‡§∂‡•á ‡§™‡§∞ ‡§≤‡§æ‡§≤ ‡§∞‡•á‡§ñ‡§æ ‡§ï‡§æ ‡§™‡§æ‡§≤‡§® ‡§ï‡§∞‡•á‡§Ç",
    popup_type:"‡§™‡•ç‡§∞‡§ï‡§æ‡§∞", popup_hours:"‡§∏‡§Æ‡§Ø", popup_call:"‡§ï‡•â‡§≤", popup_getDirections:"‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç", popup_openInMaps:"‡§Æ‡•à‡§™ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç", popup_showQRCode:"QR ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å",
    accessibilityTitle:"‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ó‡•ç‡§∞‡§π-‡§ï‡§Æ (accessibility)", highContrast:"‡§π‡§æ‡§à ‡§ï‡§Ç‡§ü‡•ç‡§∞‡§æ‡§∏‡•ç‡§ü", dyslexicFont:"‡§°‡§ø‡§∏‡•ç‡§≤‡•á‡§ï‡•ç‡§∏‡§ø‡§Ø‡§æ ‡§´‡•â‡§®‡•ç‡§ü", letterSpacing:"‡§Ö‡§ï‡•ç‡§∑‡§∞ ‡§Ö‡§Ç‡§§‡§∞", largeText:"‡§¨‡§°‡§º‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü",
    reduceMotion:"‡§Æ‡•Ç‡§µ‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§Æ ‡§ï‡§∞‡•á‡§Ç", keyboardMode:"‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§Æ‡•ã‡§°", readPopup:"‡§ñ‡•Å‡§≤‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡§¢‡§º‡•á‡§Ç", hotlinesTitle:"‡§π‡•â‡§ü‡§≤‡§æ‡§á‡§® ‡§î‡§∞ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§®",
    emergencyText:"‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤: ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§∞‡§Ç‡§§ 911 ‡§™‡§∞ ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç‡•§", skipTo:"‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç", copy:"‡§ï‡•â‡§™‡•Ä"
  },
  ur: {
    title:"⁄à€å Ÿπ€å ÿß€å ÿß€åÿ≥ Ÿàÿ≥ÿßÿ¶ŸÑ ŸÜŸÇÿ¥€Å", subtitle:"⁄©ŸÖ ÿÆÿ∑ÿ±€íÿå ŸÜ⁄Øÿ±ÿßŸÜ€å ÿ¥ÿØ€Å ÿßÿ≥ÿ™ÿπŸÖÿßŸÑÿå ŸÅŸà⁄à ÿ®€åŸÜ⁄©ÿ≥ÿå ŸæŸÜÿß€Å ⁄Øÿß€Å€å⁄∫ÿå ⁄à€åŸπÿß⁄©ÿ≥ ŸÖÿ±ÿß⁄©ÿ≤ÿå ÿßŸàÿ± ÿß€åŸÖÿ±ÿ¨ŸÜÿ≥€å ÿÆÿØŸÖÿßÿ™ ÿ™⁄© ŸÅŸàÿ±€å ÿ±ÿ≥ÿßÿ¶€å€î",
    searchPlaceholder:"ŸÜÿßŸÖÿå ŸÇÿ≥ŸÖÿå €åÿß ÿ≥ÿ±Ÿàÿ≥ ÿ™ŸÑÿßÿ¥ ⁄©ÿ±€å⁄∫", locate:"ŸÖ€åÿ±ÿß ŸÖŸÇÿßŸÖ", naloxone:"ŸÜÿßŸÑŸà⁄©ÿ≥ŸàŸÜ ÿ±€ÅŸÜŸÖÿß", report:"ŸÖÿ≥ÿ¶ŸÑ€Å ÿ±ŸæŸàÿ±Ÿπ ⁄©ÿ±€å⁄∫", emergency:"ÿß€åŸÖÿ±ÿ¨ŸÜÿ≥€å 911",
    filterLabel:"ŸÇÿ≥ŸÖ ⁄©€í ŸÖÿ∑ÿßÿ®ŸÇ ŸÅŸÑŸπÿ± ⁄©ÿ±€å⁄∫:", searchLabel:"Ÿàÿ≥ÿßÿ¶ŸÑ ÿ™ŸÑÿßÿ¥ ⁄©ÿ±€å⁄∫:", alert:"ÿß€ÅŸÖ: ÿ≥€ÅŸàŸÑÿ™ ⁄©€í ÿßŸàŸÇÿßÿ™ ÿ™ÿ®ÿØ€åŸÑ €ÅŸà ÿ≥⁄©ÿ™€í €Å€å⁄∫€î Ÿæ€ÅŸÑ€í ⁄©ÿßŸÑ ⁄©ÿ±€å⁄∫€î",
    resourceCountSuffix:"ÿ™ÿµÿØ€åŸÇ ÿ¥ÿØ€Å ŸÖŸÇÿßŸÖÿßÿ™", locating:"ŸÖŸÇÿßŸÖ ŸÖÿπŸÑŸàŸÖ ⁄©€åÿß ÿ¨ÿß ÿ±€Åÿß €Å€í...", locationFound:"ŸÖŸÇÿßŸÖ ŸÖŸÑ ⁄Ø€åÿß!", enableLocationFirst:"Ÿæ€ÅŸÑ€í ÿßŸæŸÜÿß ŸÖŸÇÿßŸÖ ŸÅÿπÿßŸÑ ⁄©ÿ±€å⁄∫",
    directionsTo:"€ÅÿØÿß€åÿ™", followRedLine:"ŸÜŸÇÿ¥€í Ÿæÿ± ÿ≥ÿ±ÿÆ ŸÑÿßÿ¶ŸÜ ⁄©€å Ÿæ€åÿ±Ÿà€å ⁄©ÿ±€å⁄∫",
    popup_type:"ŸÇÿ≥ŸÖ", popup_hours:"⁄Ø⁄æŸÜŸπ€í", popup_call:"⁄©ÿßŸÑ", popup_getDirections:"ÿ±ÿßÿ≥ÿ™€Å ÿ≠ÿßÿµŸÑ ⁄©ÿ±€å⁄∫", popup_openInMaps:"ŸÜŸÇÿ¥€í ŸÖ€å⁄∫ ⁄©⁄æŸàŸÑ€å⁄∫", popup_showQRCode:"⁄©€åŸà ÿ¢ÿ± ÿØ⁄©⁄æÿßÿ¶€å⁄∫",
    accessibilityTitle:"ÿØÿ≥ÿ™€åÿßÿ®€å", highContrast:"€Åÿßÿ¶€å ⁄©ŸÜŸπÿ±ÿßÿ≥Ÿπ", dyslexicFont:"⁄àÿ≥ŸÑ€å⁄©ÿ≥€åÿß ŸÅŸàŸÜŸπ", letterSpacing:"ÿ≠ÿ±ŸàŸÅ ŸÅÿßÿµŸÑ€Å", largeText:"ÿ®⁄ëÿß ŸÖÿ™ŸÜ",
    reduceMotion:"ÿ≠ÿ±⁄©ÿ™ ⁄©ŸÖ ⁄©ÿ±€å⁄∫", keyboardMode:"⁄©€å ÿ®Ÿàÿ±⁄à ŸÖŸà⁄à", readPopup:"⁄©⁄æŸÑÿß ŸæÿßŸæ ÿßŸæ Ÿæ⁄ë⁄æ€å⁄∫", hotlinesTitle:"€ÅŸàŸπ ŸÑÿßÿ¶ŸÜÿ≤ ÿßŸàÿ± ŸÖÿπÿßŸàŸÜÿ™",
    emergencyText:"ÿß€åŸÖÿ±ÿ¨ŸÜÿ≥€å: ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ ŸÅŸàÿ±€å ÿ∑Ÿàÿ± Ÿæÿ± 911 Ÿæÿ± ⁄©ÿßŸÑ ⁄©ÿ±€å⁄∫€î", skipTo:"ŸÖÿ¥ŸÖŸàŸÑ Ÿæÿ± ÿ¨ÿßÿ¶€å⁄∫", copy:"⁄©ÿßŸæ€å"
  },
  pa: {
    title:"‡®°‡©Ä‡®ü‡©Ä‡®à‡®ê‡©±‡®∏ ‡®∏‡®∞‡©ã‡®§ ‡®®‡®ï‡®∏‡®º‡®æ", subtitle:"‡®π‡®æ‡®∞‡®Æ ‡®∞‡®ø‡®°‡®ï‡®∏‡®º‡®®, ‡®®‡®ø‡®ó‡®∞‡®æ‡®®‡©Ä ‡®µ‡®æ‡®≤‡©Ä ‡®ñ‡®™‡®§, ‡®´‡©Ç‡®° ‡®¨‡©à‡®Ç‡®ï, ‡®∂‡©à‡®≤‡®ü‡®∞, ‡®°‡©Ä‡®ü‡©å‡®ï‡®∏ ‡®Ö‡®§‡©á ‡®ê‡®Æ‡®∞‡®ú‡©à‡®Ç‡®∏‡©Ä ‡®∏‡©á‡®µ‡®æ‡®µ‡®æ‡®Ç ‡®§‡©±‡®ï ‡®§‡©Å‡®∞‡©∞‡®§ ‡®™‡®π‡©Å‡©∞‡®ö‡•§",
    searchPlaceholder:"‡®®‡®æ‡®Ç, ‡®ï‡®ø‡®∏‡®Æ, ‡®ú‡®æ‡®Ç ‡®∏‡©á‡®µ‡®æ ‡®®‡®æ‡®≤ ‡®ñ‡©ã‡®ú‡©ã", locate:"‡®Æ‡©á‡®∞‡©Ä ‡®•‡®æ‡®Ç", naloxone:"‡®®‡®æ‡®≤‡©ã‡®ï‡®∏‡©ã‡®® ‡®ó‡®æ‡®à‡®°", report:"‡®Æ‡©Å‡©±‡®¶‡®æ ‡®∞‡®ø‡®™‡©ã‡®∞‡®ü ‡®ï‡®∞‡©ã", emergency:"‡®ê‡®Æ‡®∞‡®ú‡©à‡®Ç‡®∏‡©Ä 911",
    filterLabel:"‡®∂‡©ç‡®∞‡©á‡®£‡©Ä ‡®Ö‡®®‡©Å‡®∏‡®æ‡®∞ ‡®õ‡®æ‡®£‡©ã:", searchLabel:"‡®∏‡®∞‡©ã‡®§ ‡®ñ‡©ã‡®ú‡©ã:", alert:"‡®ú‡®∞‡©Ç‡®∞‡©Ä: ‡®∏‡©á‡®µ‡®æ ‡®∏‡®Æ‡©á‡®Ç ‡®¨‡®¶‡®≤ ‡®∏‡®ï‡®¶‡©á ‡®π‡®®‡•§ ‡®™‡®π‡®ø‡®≤‡®æ‡®Ç ‡®ï‡®æ‡®≤ ‡®ï‡®∞‡©ã‡•§",
    resourceCountSuffix:"‡®™‡©ç‡®∞‡®Æ‡®æ‡®£‡®ø‡®§ ‡®∏‡®•‡®æ‡®®", locating:"‡®ü‡®ø‡®ï‡®æ‡®£‡®æ ‡®≤‡©±‡®≠‡®ø‡®Ü ‡®ú‡®æ ‡®∞‡®ø‡®π‡®æ ‡®π‡©à...", locationFound:"‡®ü‡®ø‡®ï‡®æ‡®£‡®æ ‡®Æ‡®ø‡®≤ ‡®ó‡®ø‡®Ü!", enableLocationFirst:"‡®™‡®π‡®ø‡®≤‡®æ‡®Ç ‡®Ü‡®™‡®£‡©Ä ‡®∏‡®•‡®ø‡®§‡©Ä ‡®ö‡®æ‡®≤‡©Ç ‡®ï‡®∞‡©ã",
    directionsTo:"‡®¶‡™ø‡™∂‡®æ", followRedLine:"‡®®‡®ï‡®∏‡®º‡©á '‡®§‡©á ‡®≤‡®æ‡®≤ ‡®≤‡®ï‡©Ä‡®∞ ‡®¶‡©Ä ‡®™‡®æ‡®≤‡®£‡®æ ‡®ï‡®∞‡©ã",
    popup_type:"‡®ï‡®ø‡®∏‡®Æ", popup_hours:"‡®ò‡©∞‡®ü‡©á", popup_call:"‡®ï‡®æ‡®≤", popup_getDirections:"‡®Æ‡®æ‡®∞‡®ó ‡®™‡©ç‡®∞‡®æ‡®™‡®§ ‡®ï‡®∞‡©ã", popup_openInMaps:"‡®®‡®ï‡®∂‡©á '‡®ö ‡®ñ‡©ã‡®≤‡©ç‡®π‡©ã", popup_showQRCode:"QR ‡®¶‡®ø‡®ñ‡®æ‡®ì",
    accessibilityTitle:"‡®™‡®π‡©Å‡©∞‡®ö", highContrast:"‡®π‡®æ‡®à ‡®ï‡®æ‡®Ç‡®ü‡©ç‡®∞‡®æ‡®∏‡®ü", dyslexicFont:"‡®°‡®ø‡®∏‡®≤‡©à‡®ï‡®∏‡®ø‡®ï ‡®´‡©ã‡®Ç‡®ü", letterSpacing:"‡®Ö‡©±‡®ñ‡®∞ ‡®´‡®º‡®æ‡®∏‡®≤‡®æ", largeText:"‡®µ‡©±‡®°‡®æ ‡®ü‡©à‡®ï‡®∏‡®ü",
    reduceMotion:"‡®∞‡©Å‡®ù‡®æ‡®® ‡®ò‡©±‡®ü ‡®ï‡®∞‡©ã", keyboardMode:"‡®ï‡©Ä‡®¨‡©ã‡®∞‡®° ‡®Æ‡©ã‡®°", readPopup:"‡®ñ‡©Å‡©±‡®≤‡©ç‡®π‡®æ ‡®™‡®æ‡®™‡®Ö‡©±‡®™ ‡®™‡©ú‡©ç‡®π‡©ã", hotlinesTitle:"‡®π‡©ã‡®ü‡®≤‡®æ‡®à‡®® ‡®Ö‡®§‡©á ‡®∏‡®π‡®æ‡®á‡®§‡®æ",
    emergencyText:"‡®ú‡®∞‡©Ç‡®∞‡©Ä: ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®§‡©Å‡®∞‡©∞‡®§ 911 ‡®®‡©Ç‡©∞ ‡®ï‡®æ‡®≤ ‡®ï‡®∞‡©ã‡•§", skipTo:"‡®∏‡®Æ‡©±‡®ó‡®∞‡©Ä ‡®µ‡©±‡®≤ ‡®ú‡®æ‡®ì", copy:"‡®ï‡®æ‡®™‡©Ä"
  },
  bn: {
    title:"DTES ‡¶∞‡¶ø‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞", subtitle:"‡¶π‡¶æ‡¶Æ-‡¶∞‡¶ø‡¶°‡¶æ‡¶ï‡¶∂‡¶®, ‡¶§‡¶¶‡¶æ‡¶∞‡¶ï‡¶ø‡¶ï‡ßÉ‡¶§ ‡¶∏‡ßá‡¶¨‡¶® ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞, ‡¶´‡ßÅ‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï, ‡¶Ü‡¶∂‡ßç‡¶∞‡¶Ø‡¶º, ‡¶°‡¶ø‡¶ü‡¶ï‡ßç‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ‡•§",
    searchPlaceholder:"‡¶®‡¶æ‡¶Æ, ‡¶ß‡¶∞‡¶® ‡¶¨‡¶æ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®", locate:"‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®", naloxone:"‡¶®‡¶æ‡¶≤‡¶ï‡ßç‡¶∏‡ßã‡¶® ‡¶ó‡¶æ‡¶á‡¶°", report:"‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®", emergency:"‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡ßØ‡ßß‡ßß",
    filterLabel:"‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞:", searchLabel:"‡¶∞‡¶ø‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®:", alert:"‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£: ‡¶∏‡ßá‡¶¨‡¶æ ‡¶∏‡¶Æ‡ßü ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶Ü‡¶ó‡ßá ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",
    resourceCountSuffix:"‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡ßÉ‡¶§ ‡¶∏‡ßç‡¶•‡¶æ‡¶®", locating:"‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...", locationFound:"‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá!", enableLocationFirst:"‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®",
    directionsTo:"‡¶¶‡¶ø‡¶ï‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂", followRedLine:"‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßá ‡¶≤‡¶æ‡¶≤ ‡¶≤‡¶æ‡¶á‡¶® ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®",
    popup_type:"‡¶ß‡¶∞‡¶®", popup_hours:"‡¶ò‡¶£‡ßç‡¶ü‡¶æ", popup_call:"‡¶ï‡¶≤", popup_getDirections:"‡¶¶‡¶ø‡¶ï‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂", popup_openInMaps:"‡¶Æ‡¶æ‡¶®‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßá ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®", popup_showQRCode:"QR ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì",
    accessibilityTitle:"‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡¶ø‡¶¨‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø", highContrast:"‡¶π‡¶æ‡¶á ‡¶ï‡¶®‡¶ü‡ßç‡¶∞‡¶æ‡¶∏‡ßç‡¶ü", dyslexicFont:"‡¶°‡¶ø‡¶∏‡¶≤‡ßá‡¶ï‡ßç‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ ‡¶´‡¶®‡ßç‡¶ü", letterSpacing:"‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶ß‡¶æ‡¶®", largeText:"‡¶¨‡¶°‡¶º ‡¶≤‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶Ü‡¶ï‡¶æ‡¶∞",
    reduceMotion:"‡¶ï‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶®", keyboardMode:"‡¶ï‡ßÄ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶Æ‡ßã‡¶°", readPopup:"‡¶ì‡¶™‡ßá‡¶® ‡¶™‡¶™‡¶Ü‡¶™ ‡¶™‡ßú‡ßÅ‡¶®", hotlinesTitle:"‡¶π‡¶ü‡¶≤‡¶æ‡¶á‡¶® ‡¶ì ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ",
    emergencyText:"‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ: ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶¨‡¶ø‡¶≤‡¶Æ‡ßç‡¶¨‡ßá ‡ßØ‡ßß‡ßß-‡¶è ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", skipTo:"‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®", copy:"‡¶ï‡¶™‡¶ø"
  },
  tl: {
    title:"Mapa ng DTES Resources", subtitle:"Agarang access sa harm reduction, supervised consumption, food banks, shelters, detox centers, at urgent care.",
    searchPlaceholder:"Maghanap ayon sa pangalan, uri, o serbisyo", locate:"Hanapin Akin", naloxone:"Gabayan sa Naloxone", report:"I-report ang isyu", emergency:"Emergency 911",
    filterLabel:"I-filter ayon sa Kategorya:", searchLabel:"Maghanap ng mga resource:", alert:"Mahalaga: Maaaring magbago ang oras ng serbisyo. Tumawag muna.",
    resourceCountSuffix:"napapatunayang lokasyon", locating:"Hinahanap...", locationFound:"Natagpuan ang lokasyon!", enableLocationFirst:"I-on muna ang iyong lokasyon",
    directionsTo:"Direksyon sa", followRedLine:"Sundan ang pulang linya sa mapa",
    popup_type:"Uri", popup_hours:"Oras", popup_call:"Tumawag", popup_getDirections:"Kumuha ng Direksyon", popup_openInMaps:"Buksan sa Maps", popup_showQRCode:"Ipakita ang QR",
    accessibilityTitle:"Accessibility", highContrast:"High contrast", dyslexicFont:"Dyslexic font", letterSpacing:"Letter spacing", largeText:"Large text",
    reduceMotion:"Reduce motion", keyboardMode:"Keyboard mode", readPopup:"Basahin ang bukas na popup", hotlinesTitle:"Hotlines & Support",
    emergencyText:"EMERGENCY: Mangyaring tumawag sa 911 kaagad.", skipTo:"Laktawan sa nilalaman", copy:"Kopya"
  },
  zh: {
    title:"DTES ËµÑÊ∫êÂú∞Âõæ", subtitle:"Âç≥Êó∂Ëé∑ÂèñÂáèÂÆ≥„ÄÅÁõëÁù£Ê≥®Â∞Ñ„ÄÅÈ£üÁâ©Èì∂Ë°å„ÄÅÊî∂ÂÆπÊâÄ„ÄÅÊéíÊØí‰∏≠ÂøÉÂíåÊÄ•ËØäÊúçÂä°„ÄÇ",
    searchPlaceholder:"ÊåâÂêçÁß∞„ÄÅÁ±ªÂûãÊàñÊúçÂä°ÊêúÁ¥¢", locate:"Êü•ÊâæÊàëÁöÑ‰ΩçÁΩÆ", naloxone:"Á∫≥Ê¥õÈÖÆ ÊåáÂçó", report:"Êä•ÂëäÈóÆÈ¢ò", emergency:"Á¥ßÊÄ• 911",
    filterLabel:"ÊåâÁ±ªÂà´Á≠õÈÄâ:", searchLabel:"ÊêúÁ¥¢ËµÑÊ∫ê:", alert:"ÈáçË¶ÅÔºöÊúçÂä°Êó∂Èó¥ÂèØËÉΩÊõ¥Êîπ„ÄÇËØ∑ÂÖàËá¥ÁîµÁ°ÆËÆ§„ÄÇ",
    resourceCountSuffix:"Â∑≤Ê†∏ÂÆûÂú∞ÁÇπ", locating:"Ê≠£Âú®ÂÆö‰Ωç...", locationFound:"‰ΩçÁΩÆÂ∑≤ÊâæÂà∞!", enableLocationFirst:"ËØ∑ÂÖàÂêØÁî®ÂÆö‰Ωç",
    directionsTo:"ÂâçÂæÄ", followRedLine:"ËØ∑Ê≤øÂú∞Âõæ‰∏äÁöÑÁ∫¢Á∫øË°åËøõ",
    popup_type:"Á±ªÂûã", popup_hours:"Êó∂Èó¥", popup_call:"ÂëºÂè´", popup_getDirections:"Ëé∑ÂèñË∑ØÁ∫ø", popup_openInMaps:"Âú®Âú∞Âõæ‰∏≠ÊâìÂºÄ", popup_showQRCode:"ÊòæÁ§∫‰∫åÁª¥Á†Å",
    accessibilityTitle:"Êó†ÈöúÁ¢ç", highContrast:"È´òÂØπÊØîÂ∫¶", dyslexicFont:"ÈòÖËØªÂèãÂ•ΩÂ≠ó‰Ωì", letterSpacing:"Â≠óË∑ù", largeText:"Â§ßÂ≠ó",
    reduceMotion:"ÂáèÂ∞ëÂä®Áîª", keyboardMode:"ÈîÆÁõòÊ®°Âºè", readPopup:"ÊúóËØªÂ∑≤ÊâìÂºÄÁöÑÂºπÁ™ó", hotlinesTitle:"Ê±ÇÂä©ÁÉ≠Á∫ø",
    emergencyText:"Á¥ßÊÄ•ÔºöËØ∑Á´ãÂç≥Êã®Êâì911„ÄÇ", skipTo:"Ë∑≥Âà∞ÂÜÖÂÆπ", copy:"Â§çÂà∂"
  },
  es: {
    title:"Mapa de Recursos DTES Vancouver", subtitle:"Acceso instant√°neo a reducci√≥n de da√±os, sitios de consumo supervisado, bancos de alimentos, refugios, centros de desintoxicaci√≥n y atenci√≥n urgente.",
    searchPlaceholder:"Buscar por nombre, tipo o servicio", locate:"Mi ubicaci√≥n", naloxone:"Gu√≠a Naloxona", report:"Reportar problema", emergency:"Emergencia 911",
    filterLabel:"Filtrar por categor√≠a:", searchLabel:"Buscar recursos:", alert:"Importante: Los horarios de servicio pueden cambiar. Llame antes.",
    resourceCountSuffix:"ubicaciones verificadas", locating:"Localizando...", locationFound:"¬°Ubicaci√≥n encontrada!", enableLocationFirst:"Active su ubicaci√≥n primero",
    directionsTo:"Direcciones a", followRedLine:"Siga la l√≠nea roja en el mapa",
    popup_type:"Tipo", popup_hours:"Horario", popup_call:"Llamar", popup_getDirections:"Obtener direcciones", popup_openInMaps:"Abrir en Mapas", popup_showQRCode:"Mostrar QR",
    accessibilityTitle:"Accesibilidad", highContrast:"Alto contraste", dyslexicFont:"Fuente disl√©xica", letterSpacing:"Espaciado de letras", largeText:"Texto grande",
    reduceMotion:"Reducir movimiento", keyboardMode:"Modo teclado", readPopup:"Leer popup abierto", hotlinesTitle:"L√≠neas de ayuda",
    emergencyText:"EMERGENCIA: Por favor llame al 911 inmediatamente.", skipTo:"Saltar al contenido", copy:"Copiar"
  },
  fr: {
    title:"Carte des ressources DTES Vancouver", subtitle:"Acc√®s instantan√© √† la r√©duction des risques, sites de consommation supervis√©e, banques alimentaires, refuges, centres de d√©sintoxication et soins d'urgence.",
    searchPlaceholder:"Rechercher par nom, type ou service", locate:"Ma position", naloxone:"Guide Naloxone", report:"Signaler un probl√®me", emergency:"Urgence 911",
    filterLabel:"Filtrer par cat√©gorie:", searchLabel:"Rechercher des ressources:", alert:"Important : les horaires peuvent changer. Appelez avant.",
    resourceCountSuffix:"lieux v√©rifi√©s", locating:"Localisation...", locationFound:"Position trouv√©e!", enableLocationFirst:"Activez votre position d'abord",
    directionsTo:"Itin√©raire vers", followRedLine:"Suivez la ligne rouge sur la carte",
    popup_type:"Type", popup_hours:"Heures", popup_call:"Appeler", popup_getDirections:"Obtenir l'itin√©raire", popup_openInMaps:"Ouvrir dans Maps", popup_showQRCode:"Afficher QR",
    accessibilityTitle:"Accessibilit√©", highContrast:"Contraste √©lev√©", dyslexicFont:"Police dyslexique", letterSpacing:"Espacement des lettres", largeText:"Grand texte",
    reduceMotion:"R√©duire le mouvement", keyboardMode:"Mode clavier", readPopup:"Lire la popup ouverte", hotlinesTitle:"Lignes d'assistance",
    emergencyText:"URGENT : Veuillez appeler le 911 imm√©diatement.", skipTo:"Passer au contenu", copy:"Copier"
  },
  nl: {
    title:"DTES Hulpbronnenkaart Vancouver", subtitle:"Directe toegang tot schadebeperking, begeleid gebruik, voedselbanken, opvang, ontgiftingscentra en spoedeisende zorg.",
    searchPlaceholder:"Zoeken op naam, type of dienst", locate:"Mijn locatie", naloxone:"Naloxon gids", report:"Probleem melden", emergency:"Nood 911",
    filterLabel:"Filter op categorie:", searchLabel:"Zoek hulpbronnen:", alert:"Belangrijk: openingstijden kunnen wijzigen. Bel eerst.",
    resourceCountSuffix:"gecontroleerde locaties", locating:"Bepalen locatie...", locationFound:"Locatie gevonden!", enableLocationFirst:"Schakel eerst uw locatie in",
    directionsTo:"Route naar", followRedLine:"Volg de rode lijn op de kaart",
    popup_type:"Type", popup_hours:"Uren", popup_call:"Bellen", popup_getDirections:"Routebeschrijving", popup_openInMaps:"Open in Maps", popup_showQRCode:"Toon QR",
    accessibilityTitle:"Toegankelijkheid", highContrast:"Hoge contrast", dyslexicFont:"Dyslexie lettertype", letterSpacing:"Letterafstand", largeText:"Grote tekst",
    reduceMotion:"Beweeg minder", keyboardMode:"Toetsenbord modus", readPopup:"Lees geopende popup", hotlinesTitle:"Hulplijnen",
    emergencyText:"NOOD: Bel onmiddellijk 911.", skipTo:"Overslaan naar inhoud", copy:"Kopieer"
  },
  it: {
    title:"Mappa delle risorse DTES Vancouver", subtitle:"Accesso immediato a riduzione del danno, siti di consumo supervisionato, banche alimentari, rifugi, centri di disintossicazione e cure urgenti.",
    searchPlaceholder:"Cerca per nome, tipo o servizio", locate:"La mia posizione", naloxone:"Guida Naloxone", report:"Segnala problema", emergency:"Emergenza 911",
    filterLabel:"Filtra per categoria:", searchLabel:"Cerca risorse:", alert:"Importante: gli orari possono cambiare. Chiama prima.",
    resourceCountSuffix:"luoghi verificati", locating:"Localizzazione...", locationFound:"Posizione trovata!", enableLocationFirst:"Attiva prima la tua posizione",
    directionsTo:"Indicazioni per", followRedLine:"Segui la linea rossa sulla mappa",
    popup_type:"Tipo", popup_hours:"Orari", popup_call:"Chiama", popup_getDirections:"Ottieni indicazioni", popup_openInMaps:"Apri in Maps", popup_showQRCode:"Mostra QR",
    accessibilityTitle:"Accessibilit√†", highContrast:"Alto contrasto", dyslexicFont:"Carattere dislessico", letterSpacing:"Spaziatura lettere", largeText:"Testo grande",
    reduceMotion:"Riduci movimento", keyboardMode:"Modalit√† tastiera", readPopup:"Leggi popup aperto", hotlinesTitle:"Hotline",
    emergencyText:"EMERGENZA: Si prega di chiamare il 911 immediatamente.", skipTo:"Vai al contenuto", copy:"Copia"
  },
  sv: {
    title:"DTES Resurskarta Vancouver", subtitle:"Omedelbar √•tkomst till skadereducering, √∂vervakad konsumtion, matbanker, skydd, avgiftningscenter och akutv√•rd.",
    searchPlaceholder:"S√∂k efter namn, typ eller tj√§nst", locate:"Hitta mig", naloxone:"Naloxon guide", report:"Rapportera problem", emergency:"N√∂dfall 911",
    filterLabel:"Filtrera efter kategori:", searchLabel:"S√∂k resurser:", alert:"Viktigt: √∂ppettider kan √§ndras. Ring f√∂rst.",
    resourceCountSuffix:"verifierade platser", locating:"Lokalisering...", locationFound:"Plats hittad!", enableLocationFirst:"Aktivera din plats f√∂rst",
    directionsTo:"V√§gbeskrivning till", followRedLine:"F√∂lj den r√∂da linjen p√• kartan",
    popup_type:"Typ", popup_hours:"√ñppettider", popup_call:"Ring", popup_getDirections:"F√• v√§gbeskrivning", popup_openInMaps:"√ñppna i kartor", popup_showQRCode:"Visa QR",
    accessibilityTitle:"Tillg√§nglighet", highContrast:"H√∂g kontrast", dyslexicFont:"Dyslexi-teckensnitt", letterSpacing:"Bokstavsavst√•nd", largeText:"Stor text",
    reduceMotion:"Minska r√∂relse", keyboardMode:"Tangentbordsl√§ge", readPopup:"L√§s √∂ppen popup", hotlinesTitle:"Hj√§lplinjer",
    emergencyText:"N√ñD: Ring 911 omedelbart.", skipTo:"Hoppa till inneh√•llet", copy:"Kopiera"
  },
  de: {
    title:"DTES Ressourcenkarte Vancouver", subtitle:"Sofortiger Zugriff auf Schadensminderung, √ºberwachte Konsumstellen, Tafeln, Unterk√ºnfte, Entgiftungszentren und Notfallversorgung.",
    searchPlaceholder:"Suche nach Name, Typ oder Dienst", locate:"Mein Standort", naloxone:"Naloxon Anleitung", report:"Problem melden", emergency:"Notfall 911",
    filterLabel:"Nach Kategorie filtern:", searchLabel:"Ressourcen suchen:", alert:"Wichtig: √ñffnungszeiten k√∂nnen sich √§ndern. Rufen Sie vorher an.",
    resourceCountSuffix:"verifizierte Standorte", locating:"Suche Standort...", locationFound:"Standort gefunden!", enableLocationFirst:"Aktivieren Sie zuerst Ihren Standort",
    directionsTo:"Wegbeschreibung zu", followRedLine:"Folgen Sie der roten Linie auf der Karte",
    popup_type:"Typ", popup_hours:"Stunden", popup_call:"Anrufen", popup_getDirections:"Route anzeigen", popup_openInMaps:"In Maps √∂ffnen", popup_showQRCode:"QR anzeigen",
    accessibilityTitle:"Barrierefreiheit", highContrast:"Hoher Kontrast", dyslexicFont:"Dyslexie Schrift", letterSpacing:"Buchstabenabstand", largeText:"Gro√üer Text",
    reduceMotion:"Bewegung reduzieren", keyboardMode:"Tastaturmodus", readPopup:"Lesen Sie das ge√∂ffnete Popup", hotlinesTitle:"Hotlines",
    emergencyText:"NOTFALL: Bitte rufen Sie sofort 911 an.", skipTo:"Zum Inhalt springen", copy:"Kopieren"
  },
  pt: {
    title:"Mapa de Recursos DTES Vancouver", subtitle:"Acesso instant√¢neo a redu√ß√£o de danos, locais de consumo supervisionado, bancos de alimentos, abrigos, centros de desintoxica√ß√£o e atendimento de urg√™ncia.",
    searchPlaceholder:"Pesquisar por nome, tipo ou servi√ßo", locate:"Minha localiza√ß√£o", naloxone:"Guia Naloxona", report:"Relatar problema", emergency:"Emerg√™ncia 911",
    filterLabel:"Filtrar por categoria:", searchLabel:"Pesquisar recursos:", alert:"Importante: os hor√°rios de servi√ßo podem mudar. Ligue antes.",
    resourceCountSuffix:"locais verificados", locating:"Localizando...", locationFound:"Localiza√ß√£o encontrada!", enableLocationFirst:"Ative sua localiza√ß√£o primeiro",
    directionsTo:"Dire√ß√µes para", followRedLine:"Siga a linha vermelha no mapa",
    popup_type:"Tipo", popup_hours:"Hor√°rio", popup_call:"Ligar", popup_getDirections:"Obter dire√ß√µes", popup_openInMaps:"Abrir no Maps", popup_showQRCode:"Mostrar QR",
    accessibilityTitle:"Acessibilidade", highContrast:"Alto contraste", dyslexicFont:"Fonte disl√©xica", letterSpacing:"Espa√ßamento de letras", largeText:"Texto grande",
    reduceMotion:"Reduzir movimento", keyboardMode:"Modo teclado", readPopup:"Ler popup aberto", hotlinesTitle:"Hotlines",
    emergencyText:"EMERG√äNCIA: Ligue para 911 imediatamente.", skipTo:"Pular para o conte√∫do", copy:"Copiar"
  }
};

/* =========================
  State & Map init
  ========================= */
let dtesResources = [];
let map = null, markers = [], userLat = null, userLng = null, routingControl = null;
let currentLang = 'en';

/* Helper safe text */
function safe(s){ return s === null || s === undefined ? '' : String(s); }

/* Load external JSON and init UI */
async function loadResourcesJSON(url='dtes-resources.json'){
  const status = document.getElementById('userLocationStatus');
  try{
    status.textContent = 'Loading resources...';
    const r = await fetch(url, { cache:'no-store' });
    if(!r.ok) throw new Error('Fetch failed: ' + r.status);
    const data = await r.json();
    if(!Array.isArray(data)) throw new Error('JSON must be an array');
    dtesResources = data;
    renderHotlines();
    buildCategoryCheckboxes();
    initMap();
    applyTranslations(); // ensures UI text updated
  } catch(err){
    console.error(err);
    alert('Failed to load dtes-resources.json: ' + err.message);
  } finally {
    hideLoading();
  }
}

/* hide loading */
function hideLoading(){ const ov = document.getElementById('loadingOverlay'); if(ov){ ov.style.opacity='0'; setTimeout(()=>ov.style.display='none',360); } }

/* wait for Leaflet then init */
function initMap(){
  if(!map){
    map = L.map('map').setView([49.2819, -123.1000], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);
  } else {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
  }
  // add markers
  dtesResources.forEach(item => {
    if(typeof item.lat === 'number' && typeof item.lng === 'number'){
      addMarker(item);
    }
  });
  updateCounts();
}

/* add a map marker */
function addMarker(item){
  const colors = {'Naloxone':'#3B82F6','Injection Site':'#10B981','Detox':'#F97316','Food':'#9333EA','Shelter':'#b45309','Urgent':'#EF4444','Washrooms':'#14B8A6','Mental Health':'#EC4899','Hotline':'#6B7280'};
  const color = colors[item.type] || '#6B7280';
  const icon = L.divIcon({ className:'custom-marker', html:`<div style="background:${color};width:28px;height:28px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,.2)"></div>`, iconSize:[28,28], iconAnchor:[14,14] });
  const m = L.marker([item.lat, item.lng], { icon }).addTo(map);
  m.resource = item;
  m.bindPopup(createPopupHtml(item), { maxWidth: 340 });
  m.on('popupopen', ()=> {
    // when popup opens, store as lastPopupText for TTS
    lastOpenPopupHtml = m.getPopup().getContent();
  });
  markers.push(m);
}

/* popup builder uses translations T */
let lastOpenPopupHtml = '';
function createPopupHtml(r){
  const t = T[currentLang] || T.en;
  const phoneHtml = r.phone ? `<a href="tel:${safe(r.phone)}">${safe(r.phone)}</a>` : 'N/A';
  const hours = safe(r.hours || 'N/A');
  const address = safe(r.address || '');
  const safeName = safe(r.name || '');
  return `
    <div style="max-width:320px;">
      <h3 style="margin:0 0 6px 0;font-size:16px;font-weight:700">${safeName}</h3>
      <p style="margin:0 0 6px 0;"><strong>${t.popup_type}:</strong> ${safe(r.type || 'N/A')}</p>
      <p style="margin:0 0 6px 0;"><strong>${t.popup_hours}:</strong> ${hours}</p>
      <p style="margin:0 0 6px 0;"><strong>${t.popup_call}:</strong> ${phoneHtml}</p>
      <p style="margin:0 0 6px 0;color:#6b7280">${address}</p>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;">
        <button class="popup-btn direction-btn" onclick="getDirections(${r.lat},${r.lng},'${safeName}')">${t.popup_getDirections}</button>
        <button class="popup-btn" style="background:#3B82F6;color:#fff" onclick="openExternal(${r.lat},${r.lng},'${safeName}')">${t.popup_openInMaps}</button>
        <button class="popup-btn" style="background:#10B981;color:#fff" onclick="showQR(${r.lat},${r.lng},'${safeName}')">${t.popup_showQRCode}</button>
      </div>
    </div>
  `;
}

/* getDirections & openExternal & showQR */
function getDirections(lat,lng,name){
  const t = T[currentLang] || T.en;
  if(!userLat || !userLng){ alert(t.enableLocationFirst); return; }
  if(routingControl) map.removeControl(routingControl);
  routingControl = L.Routing.control({
    waypoints: [ L.latLng(userLat, userLng), L.latLng(lat, lng) ],
    lineOptions: { styles: [{ color:'#EF4444', weight:5, opacity:0.8 }] },
    createMarker: ()=> null
  }).addTo(map);
  alert(`${t.directionsTo} ${name}\n\n${t.followRedLine}`);
}

function openExternal(lat,lng,name){
  const url = `https://maps.google.com/?q=${lat},${lng}(${encodeURIComponent(name)})`;
  window.open(url, '_blank');
}

function showQR(lat,lng,name){
  const url = `https://maps.google.com/?q=${lat},${lng}(${encodeURIComponent(name)})`;
  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), { text: url, width:200, height:200 });
  document.getElementById('qrLocationName').textContent = name;
  document.getElementById('qrModal').style.display = 'flex';
}

/* close QR modal */
document.getElementById('closeQrModal').addEventListener('click', ()=> document.getElementById('qrModal').style.display='none');
window.addEventListener('click', e => { if(e.target === document.getElementById('qrModal')) document.getElementById('qrModal').style.display='none'; });

/* locate user */
document.getElementById('locateUserButton').addEventListener('click', ()=>{
  const t = T[currentLang] || T.en;
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  document.getElementById('userLocationStatus').textContent = t.locating;
  navigator.geolocation.getCurrentPosition(pos=>{
    userLat = pos.coords.latitude; userLng = pos.coords.longitude;
    if(window._youMarker) map.removeLayer(window._youMarker);
    window._youMarker = L.circleMarker([userLat, userLng], { radius:8, color:'#2563EB', fillColor:'#3B82F6', fillOpacity:1 }).addTo(map).bindPopup(t.locationFound);
    map.setView([userLat, userLng], 15);
    document.getElementById('userLocationStatus').textContent = t.locationFound;
  }, err=>{
    console.error(err); alert('Unable to get location: ' + err.message);
  });
});

/* search */
document.getElementById('searchBar').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase().trim();
  markers.forEach(m=>{
    const r = m.resource;
    const hay = `${r.name} ${r.type} ${r.description||''} ${r.address||''} ${r.phone||''}`.toLowerCase();
    const match = q === '' || hay.includes(q);
    if(match) m.addTo(map); else map.removeLayer(m);
  });
  updateCounts();
});

/* filter buttons */
document.querySelectorAll('.filter-button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.filter-button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const filter = btn.dataset.filter;
    const anyChecked = document.querySelectorAll('#categoryCheckboxes input:checked').length > 0;
    if(anyChecked) return; // checkboxes take precedence
    markers.forEach(m=>{
      if(filter === 'all' || m.resource.type === filter) m.addTo(map); else map.removeLayer(m);
    });
    updateCounts();
  });
});

/* categories checkboxes */
function buildCategoryCheckboxes(){
  const container = document.getElementById('categoryCheckboxes');
  container.innerHTML = '';
  const types = Array.from(new Set(dtesResources.map(r => r.type))).sort();
  types.forEach(type=>{
    const id = 'cat_'+type.replace(/\W+/g,'_');
    const label = document.createElement('label');
    label.className = 'cat-chk';
    label.innerHTML = `<input type="checkbox" id="${id}" value="${type}" /><span style="font-size:13px;">${type}</span>`;
    container.appendChild(label);
    label.querySelector('input').addEventListener('change', applyCategoryFilters);
  });
}

function applyCategoryFilters(){
  const checked = Array.from(document.querySelectorAll('#categoryCheckboxes input:checked')).map(i=>i.value);
  if(checked.length === 0){
    const activeBtn = document.querySelector('.filter-button.active');
    const filter = activeBtn ? activeBtn.dataset.filter : 'all';
    markers.forEach(m => {
      if(filter === 'all' || m.resource.type === filter) m.addTo(map); else map.removeLayer(m);
    });
  } else {
    markers.forEach(m => {
      if(checked.includes(m.resource.type)) m.addTo(map); else map.removeLayer(m);
    });
  }
  updateCounts();
}

/* update counts & UI */
function updateCounts(){
  const visible = markers.filter(m => map.hasLayer(m)).length;
  document.getElementById('resourceCount').textContent = `${visible} ${T[currentLang]?.resourceCountSuffix || 'verified locations'}`;
  document.getElementById('allCount').textContent = dtesResources.length;
}

/* emergency/instruction/report */
document.getElementById('emergencyButton').addEventListener('click', ()=> {
  document.getElementById('emergencyMessage').classList.remove('hidden');
  setTimeout(()=> document.getElementById('emergencyMessage').classList.add('hidden'), 6000);
});
document.getElementById('instructionsButton').addEventListener('click', ()=> {
  alert(`NALOXONE ‚Äî Quick steps:\n1) Recognize overdose (no/slow breathing, blue lips, unconscious)\n2) Call 911\n3) Give naloxone\n4) Provide rescue breaths\n5) Stay with person & call for help`);
});
document.getElementById('reportStatusButton').addEventListener('click', ()=> alert('Report updates: open a GitHub issue or email your coordinator.'));

/* hotlines rendering */
function renderHotlines(){
  const container = document.getElementById('hotlinesGrid');
  container.innerHTML = '';
  const hotlines = dtesResources.filter(r => r.type && r.type.toLowerCase().includes('hotline'));
  if(hotlines.length === 0){
    // fallback small set
    const fallback = [
      {name:"BC Mental Health", phone:"310-6789", description:"Provincial mental health support (BC)"},
      {name:"Suicide Crisis (9-8-8)", phone:"988", description:"24/7 suicide & crisis support ‚Äî call or text"},
      {name:"Kids Help Phone", phone:"1-800-668-6868", description:"24/7 support for young people"},
      {name:"BC211", phone:"211", description:"Information & referrals across BC"},
      {name:"Crisis Services Canada", phone:"1-833-456-4566", description:"National crisis line ‚Äî text 45645"}
    ];
    fallback.forEach(h => {
      const el = document.createElement('div');
      el.innerHTML = `<div class="font-semibold text-teal-400 mb-2">${safe(h.name)}</div>
                      <a href="tel:${safe(h.phone)}" class="block text-lg font-bold">${safe(h.phone)}</a>
                      <div class="text-xs text-gray-400 mt-1">${safe(h.description)}</div>`;
      container.appendChild(el);
    });
    return;
  }
  hotlines.forEach(h=>{
    const el = document.createElement('div');
    el.innerHTML = `<div class="font-semibold text-teal-400 mb-2">${safe(h.name)}</div>
                    <a href="tel:${safe(h.phone)}" class="block text-lg font-bold">${safe(h.phone)}</a>
                    <div class="text-xs text-gray-400 mt-1">${safe(h.description||'')}</div>`;
    container.appendChild(el);
  });
}

/* =========================
  Accessibility controls
  ========================= */
const a11y = {
  el: document.getElementById('a11yWidget'),
  content: document.getElementById('a11yContent'),
  mini: document.getElementById('a11yMinimized'),
  minimizeBtn: document.getElementById('minimizeA11y'),
  restoreBtn: document.getElementById('restoreA11y'),
  inc: document.getElementById('increaseFont'),
  dec: document.getElementById('decreaseFont'),
  contrast: document.getElementById('toggleContrast'),
  dys: document.getElementById('toggleDyslexic'),
  space: document.getElementById('toggleSpacing'),
  cursor: document.getElementById('toggleLargeCursor'),
  reduceMotion: document.getElementById('toggleReduceMotion'),
  keyboardMode: document.getElementById('toggleKeyboardFocus'),
  readBtn: document.getElementById('readPopup')
};

function setA11yMinimized(state){
  if(state){
    a11y.el.classList.add('minimized');
    a11y.content.style.display = 'none';
    if(a11y.mini) a11y.mini.style.display = 'block';
    sessionStorage.setItem('a11yMin','1');
  } else {
    a11y.el.classList.remove('minimized');
    a11y.content.style.display = 'block';
    if(a11y.mini) a11y.mini.style.display = 'none';
    sessionStorage.removeItem('a11yMin');
  }
}
if(a11y.minimizeBtn) a11y.minimizeBtn.addEventListener('click', ()=> setA11yMinimized(true));
if(a11y.restoreBtn) a11y.restoreBtn.addEventListener('click', ()=> setA11yMinimized(false));
if(sessionStorage.getItem('a11yMin')) setA11yMinimized(true);

if(a11y.inc) a11y.inc.addEventListener('click', ()=> {
  const root = document.documentElement;
  const size = parseFloat(getComputedStyle(root).fontSize) || 16;
  const next = Math.min(28, size + 2);
  root.style.fontSize = next + 'px';
  document.body.classList.add('large-text');
});
if(a11y.dec) a11y.dec.addEventListener('click', ()=> {
  const root = document.documentElement;
  const size = parseFloat(getComputedStyle(root).fontSize) || 16;
  const next = Math.max(12, size - 2);
  root.style.fontSize = next + 'px';
  if(next <= 16) document.body.classList.remove('large-text');
});
if(a11y.contrast) a11y.contrast.addEventListener('click', ()=> {
  document.body.classList.toggle('high-contrast');
  const on = document.body.classList.contains('high-contrast');
  a11y.contrast.setAttribute('aria-pressed', String(on));
});
if(a11y.dys) a11y.dys.addEventListener('click', ()=> {
  document.body.classList.toggle('dyslexic');
  a11y.dys.setAttribute('aria-pressed', String(document.body.classList.contains('dyslexic')));
});
if(a11y.space) a11y.space.addEventListener('click', ()=> {
  document.body.style.letterSpacing = document.body.style.letterSpacing ? '' : '0.03em';
  a11y.space.setAttribute('aria-pressed', String(!!document.body.style.letterSpacing));
});
if(a11y.cursor) a11y.cursor.addEventListener('click', ()=> {
  document.body.classList.toggle('big-cursor');
  a11y.cursor.setAttribute('aria-pressed', String(document.body.classList.contains('big-cursor')));
});
if(a11y.reduceMotion) a11y.reduceMotion.addEventListener('click', ()=> {
  document.body.classList.toggle('reduced-motion');
  a11y.reduceMotion.setAttribute('aria-pressed', String(document.body.classList.contains('reduced-motion')));
});
if(a11y.keyboardMode) a11y.keyboardMode.addEventListener('click', ()=> {
  document.body.classList.toggle('keyboard-focus');
  a11y.keyboardMode.setAttribute('aria-pressed', String(document.body.classList.contains('keyboard-focus')));
});
if(a11y.readBtn) a11y.readBtn.addEventListener('click', ()=> {
  // read currently open popup content
  if(!lastOpenPopupHtml){ alert('No popup open to read.'); return; }
  speak(stripHtml(lastOpenPopupHtml));
});

/* Text-to-speech helper */
function speak(text){
  if(!('speechSynthesis' in window)){ alert('Text-to-speech not supported in this browser.'); return; }
  const ut = new SpeechSynthesisUtterance(text);
  ut.lang = currentLang === 'zh' ? 'zh-CN' : currentLang; // basic lang hint
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(ut);
}
function stripHtml(html){ const tmp = document.createElement('div'); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ''; }

/* language switching: apply translations everywhere */
const uiSelectors = {
  mainTitle:'#mainTitle', subtitle:'#subtitle', searchBar:'#searchBar', locateBtnLabel:'#locateBtnLabel',
  naloxoneBtnLabel:'#naloxoneBtnLabel', reportBtnLabel:'#reportBtnLabel', emergencyBtnLabel:'#emergencyBtnLabel',
  filterLabel:'#filterLabel', searchLabelText:'#searchLabelText', alertText:'#alertText', hotlinesTitle:'#hotlinesTitle',
  emergencyText:'#emergencyText', userLocationStatus:'#userLocationStatus'
};

function applyTranslations(){
  const t = T[currentLang] || T.en;
  // top UI
  document.querySelector(uiSelectors.mainTitle).textContent = t.title;
  document.querySelector(uiSelectors.subtitle).textContent = t.subtitle;
  document.querySelector(uiSelectors.searchBar).setAttribute('placeholder', t.searchPlaceholder);
  document.querySelector(uiSelectors.locateBtnLabel).textContent = t.locate || 'Find My Location';
  document.querySelector(uiSelectors.naloxoneBtnLabel).textContent = t.naloxone || 'Naloxone Guide';
  document.querySelector(uiSelectors.reportBtnLabel).textContent = t.report || 'Report Issue';
  document.querySelector(uiSelectors.emergencyBtnLabel).textContent = t.emergency || 'Emergency 911';
  document.querySelector(uiSelectors.filterLabel).textContent = t.filterLabel;
  document.querySelector(uiSelectors.searchLabelText).textContent = t.searchLabel;
  document.querySelector(uiSelectors.alertText).textContent = t.alert;
  document.querySelector(uiSelectors.hotlinesTitle).textContent = t.hotlinesTitle;
  document.querySelector(uiSelectors.emergencyText).textContent = t.emergencyText;
  // update popup content for all markers
  markers.forEach(m => {
    m.bindPopup(createPopupHtml(m.resource), { maxWidth:340 });
  });
  updateCounts();
}

/* language selector wiring */
document.getElementById('languageSelect').addEventListener('change', (e)=>{
  currentLang = e.target.value;
  applyTranslations();
});

/* quick exit visibility */
window.addEventListener('scroll', ()=> { document.getElementById('quickExit').style.display = window.scrollY > 200 ? 'block' : 'none'; });
document.getElementById('quickExit').addEventListener('click', ()=> window.location.href = 'https://www.google.com');

/* initial load */
document.addEventListener('DOMContentLoaded', () => {
  // default language from browser
  const browserLang = (navigator.language || 'en').split('-')[0];
  if(T[browserLang]){ currentLang = browserLang; document.getElementById('languageSelect').value = browserLang; }
  applyTranslations();
  loadResourcesJSON('dtes-resources.json');
});

/* accessibility: keyboard trap avoidance ‚Äî allow keyboard focus outlines visible when Tab used */
(function(){ let hadKeyboardEvent = false; window.addEventListener('keydown', (e)=> { if(e.key === 'Tab'){ hadKeyboardEvent = true; document.body.classList.add('show-focus'); } }); window.addEventListener('mousedown', ()=> { hadKeyboardEvent = false; document.body.classList.remove('show-focus'); }); })();

</script>
</body>
</html>
